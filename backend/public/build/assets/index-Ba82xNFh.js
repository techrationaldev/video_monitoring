import{c as y,a as b,j as o,b as E}from"./app-BUqwFoQD.js";import{l as C}from"./index-BCtBPRNr.js";/* empty css            */class S{ws;device=null;sendTransport;producers=new Map;roomId;clientId;deviceLoadedPromise;deviceLoadedResolver=null;constructor(s,t,r){this.ws=new WebSocket(s),this.roomId=t,this.clientId=r,this.deviceLoadedPromise=new Promise(c=>{this.deviceLoadedResolver=c}),console.log("[CLIENT] WebRTC Client Created, room:",t,"client:",r)}onMessage(s){this.ws.onmessage=t=>{const r=JSON.parse(t.data);console.log(`[CLIENT] WS RECV: ${r.action}`,r),r.action==="restart-ice-done"&&this.handleRestartIceDone(r.data),r.action==="session-ended"&&(console.warn("[CLIENT] Session ended by server (restart?), reloading..."),window.location.reload()),s(r)}}send(s){const t={...s,clientId:this.clientId};console.log(`[CLIENT] WS SEND: ${s.action}`,t),this.ws.send(JSON.stringify(t))}async init(){return new Promise(s=>{this.connectWs(s)})}connectWs(s){this.ws=new WebSocket(this.ws.url),this.ws.onopen=()=>{console.log("[CLIENT] WS CONNECTED"),this.send({action:"join-as-streamer",roomId:this.roomId}),s&&s()},this.ws.onclose=()=>{console.log("[CLIENT] WS CLOSED, reconnecting in 3s..."),setTimeout(()=>this.connectWs(),3e3)},this.ws.onerror=t=>{console.error("[CLIENT] WS ERROR:",t),this.ws.close()},this.onMessage(t=>{})}async loadDevice(s){console.log("[CLIENT] Loading device with capabilities:",s),this.device=new C.Device,await this.device.load({routerRtpCapabilities:s}),console.log("[CLIENT] Device loaded"),this.deviceLoadedResolver&&this.deviceLoadedResolver()}async createSendTransport(s){if(console.log("[CLIENT] createSendTransport options received:",s),!s){console.error("[CLIENT] ERROR! createSendTransport called with EMPTY options");return}if(await this.deviceLoadedPromise,!this.device){console.error("[CLIENT] Device is null after waiting!");return}this.sendTransport=this.device.createSendTransport(s),this.sendTransport.on("connect",({dtlsParameters:t},r)=>{console.log("[CLIENT] Transport connect"),this.send({action:"connect-transport",roomId:this.roomId,data:{transportId:this.sendTransport.id,dtlsParameters:t}}),r()}),this.sendTransport.on("connectionstatechange",async t=>{console.log(`[CLIENT] Send Transport connection state changed: ${t}`),(t==="failed"||t==="disconnected")&&(console.warn("[CLIENT] Transport failed/disconnected, triggering ICE restart..."),this.restartIce(this.sendTransport.id))}),this.sendTransport.on("produce",({kind:t,rtpParameters:r},c)=>{console.log("[CLIENT] Transport produce"),this.send({action:"produce",roomId:this.roomId,data:{transportId:this.sendTransport.id,kind:t,rtpParameters:r}});const x=d=>{const i=JSON.parse(d.data);i.action==="produce-done"&&(console.log("[CLIENT] producer created:",i.producerId),c({id:i.producerId}),this.ws.removeEventListener("message",x))};this.ws.addEventListener("message",x)})}async startVideoStream(s){console.log("[CLIENT] Requesting camera...");const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});s.srcObject=t;const r=t.getVideoTracks()[0];if(console.log("[CLIENT] Sending video track..."),!this.sendTransport){console.error("[CLIENT] sendTransport is not ready!");return}await this.sendTransport.produce({track:r})}restartIce(s){this.send({action:"restart-ice",roomId:this.roomId,data:{transportId:s}})}async handleRestartIceDone(s){const{transportId:t,iceParameters:r}=s;this.sendTransport&&this.sendTransport.id===t&&(console.log("[CLIENT] Restarting ICE with new parameters"),await this.sendTransport.restartIce({iceParameters:r}))}}function k(){const e=y.c(20),s=b.useRef(null),[t,r]=b.useState(!1),[c,x]=b.useState(0);let d,i;e[0]===Symbol.for("react.memo_cache_sentinel")?(d=()=>{let n=localStorage.getItem("stream_room_id");n||(n=`client-${Date.now()}`,localStorage.setItem("stream_room_id",n)),n||(n=`client-${Date.now()}`,localStorage.setItem("stream_room_id",n));let f=sessionStorage.getItem(`stream_connection_id_${n}`);f||(f=crypto.randomUUID(),sessionStorage.setItem(`stream_connection_id_${n}`,f)),E.post(`/api/rooms/${n}/join`,{connection_id:f}).then(()=>{console.log("[PAGE] Session created in DB");const g=new S("wss://eyeserver.mytro.in",n,f);g.init().then(()=>{g.onMessage(async a=>{console.log("[PAGE] Received:",a),a.action==="router-rtp-capabilities"&&await g.loadDevice(a.data),a.action==="create-send-transport"&&a.data&&await g.createSendTransport(a.data),a.action==="start-produce"&&s.current&&(await g.startVideoStream(s.current),r(!0)),a.action==="viewer-count"&&x(a.count)})})}).catch(L)},i=[],e[0]=d,e[1]=i):(d=e[0],i=e[1]),b.useEffect(d,i);let w;e[2]===Symbol.for("react.memo_cache_sentinel")?(w=o.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"Client Streaming"}),e[2]=w):w=e[2];let l;e[3]!==t?(l=t?o.jsxs("span",{className:"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200",children:[o.jsx("span",{className:"mr-1.5 h-2 w-2 rounded-full bg-red-600"}),"LIVE"]}):o.jsx("span",{className:"inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",children:"CONNECTING"}),e[3]=t,e[4]=l):l=e[4];let I;e[5]===Symbol.for("react.memo_cache_sentinel")?(I=o.jsxs("svg",{className:"mr-1.5 h-3 w-3",fill:"currentColor",viewBox:"0 0 20 20",children:[o.jsx("path",{d:"M10 12a2 2 0 100-4 2 2 0 000 4z"}),o.jsx("path",{fillRule:"evenodd",d:"M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z",clipRule:"evenodd"})]}),e[5]=I):I=e[5];let m;e[6]!==c?(m=o.jsxs("span",{className:"inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200",children:[I,c," Viewers"]}),e[6]=c,e[7]=m):m=e[7];let h;e[8]!==l||e[9]!==m?(h=o.jsx("div",{className:"border-b border-gray-200 p-4 dark:border-gray-700",children:o.jsxs("div",{className:"flex items-center justify-between",children:[w,o.jsxs("div",{className:"flex items-center gap-2",children:[l,m]})]})}),e[8]=l,e[9]=m,e[10]=h):h=e[10];let v;e[11]===Symbol.for("react.memo_cache_sentinel")?(v=o.jsx("video",{ref:s,autoPlay:!0,muted:!0,playsInline:!0,className:"h-full w-full object-cover"}),e[11]=v):v=e[11];let p;e[12]!==t?(p=!t&&o.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-white",children:o.jsxs("div",{className:"flex flex-col items-center gap-2",children:[o.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-white border-t-transparent"}),o.jsx("p",{children:"Connecting to server..."})]})}),e[12]=t,e[13]=p):p=e[13];let u;e[14]!==p?(u=o.jsxs("div",{className:"relative aspect-video bg-black",children:[v,p]}),e[14]=p,e[15]=u):u=e[15];let T;e[16]===Symbol.for("react.memo_cache_sentinel")?(T=o.jsx("div",{className:"p-4 text-sm text-gray-500 dark:text-gray-400",children:o.jsxs("p",{children:["Share your stream ID:"," ",o.jsx("code",{className:"rounded bg-gray-100 px-1 py-0.5 font-mono text-gray-800 dark:bg-gray-700 dark:text-gray-200",children:localStorage.getItem("stream_room_id")})]})}),e[16]=T):T=e[16];let N;return e[17]!==h||e[18]!==u?(N=o.jsx("div",{className:"flex min-h-screen items-center justify-center bg-gray-100 p-6 dark:bg-gray-900",children:o.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-xl bg-white shadow-xl dark:bg-gray-800",children:[h,u,T]})}),e[17]=h,e[18]=u,e[19]=N):N=e[19],N}function L(e){console.error("[PAGE] Failed to join room API:",e)}export{k as default};
