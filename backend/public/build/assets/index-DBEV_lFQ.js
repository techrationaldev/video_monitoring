import{c as Ke}from"./createLucideIcon-Bcz5Q4Qz.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],xr=Ke("Activity",Ht);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],kr=Ke("MicOff",Vt);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],Dr=Ke("Mic",Qt);var $e={},ke={exports:{}},ze,Je;function Gt(){if(Je)return ze;Je=1;var g=1e3,b=g*60,v=b*60,n=v*24,x=n*7,R=n*365.25;ze=function(r,h){h=h||{};var u=typeof r;if(u==="string"&&r.length>0)return m(r);if(u==="number"&&isFinite(r))return h.long?S(r):c(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function m(r){if(r=String(r),!(r.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(h){var u=parseFloat(h[1]),E=(h[2]||"ms").toLowerCase();switch(E){case"years":case"year":case"yrs":case"yr":case"y":return u*R;case"weeks":case"week":case"w":return u*x;case"days":case"day":case"d":return u*n;case"hours":case"hour":case"hrs":case"hr":case"h":return u*v;case"minutes":case"minute":case"mins":case"min":case"m":return u*b;case"seconds":case"second":case"secs":case"sec":case"s":return u*g;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return u;default:return}}}}function c(r){var h=Math.abs(r);return h>=n?Math.round(r/n)+"d":h>=v?Math.round(r/v)+"h":h>=b?Math.round(r/b)+"m":h>=g?Math.round(r/g)+"s":r+"ms"}function S(r){var h=Math.abs(r);return h>=n?T(r,h,n,"day"):h>=v?T(r,h,v,"hour"):h>=b?T(r,h,b,"minute"):h>=g?T(r,h,g,"second"):r+" ms"}function T(r,h,u,E){var y=h>=u*1.5;return Math.round(r/u)+" "+E+(y?"s":"")}return ze}var qe,Ye;function Kt(){if(Ye)return qe;Ye=1;function g(b){n.debug=n,n.default=n,n.coerce=T,n.disable=c,n.enable=R,n.enabled=S,n.humanize=Gt(),n.destroy=r,Object.keys(b).forEach(h=>{n[h]=b[h]}),n.names=[],n.skips=[],n.formatters={};function v(h){let u=0;for(let E=0;E<h.length;E++)u=(u<<5)-u+h.charCodeAt(E),u|=0;return n.colors[Math.abs(u)%n.colors.length]}n.selectColor=v;function n(h){let u,E=null,y,e;function t(...s){if(!t.enabled)return;const o=t,_=Number(new Date),l=_-(u||_);o.diff=l,o.prev=u,o.curr=_,u=_,s[0]=n.coerce(s[0]),typeof s[0]!="string"&&s.unshift("%O");let f=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,(i,d)=>{if(i==="%%")return"%";f++;const w=n.formatters[d];if(typeof w=="function"){const C=s[f];i=w.call(o,C),s.splice(f,1),f--}return i}),n.formatArgs.call(o,s),(o.log||n.log).apply(o,s)}return t.namespace=h,t.useColors=n.useColors(),t.color=n.selectColor(h),t.extend=x,t.destroy=n.destroy,Object.defineProperty(t,"enabled",{enumerable:!0,configurable:!1,get:()=>E!==null?E:(y!==n.namespaces&&(y=n.namespaces,e=n.enabled(h)),e),set:s=>{E=s}}),typeof n.init=="function"&&n.init(t),t}function x(h,u){const E=n(this.namespace+(typeof u>"u"?":":u)+h);return E.log=this.log,E}function R(h){n.save(h),n.namespaces=h,n.names=[],n.skips=[];const u=(typeof h=="string"?h:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const E of u)E[0]==="-"?n.skips.push(E.slice(1)):n.names.push(E)}function m(h,u){let E=0,y=0,e=-1,t=0;for(;E<h.length;)if(y<u.length&&(u[y]===h[E]||u[y]==="*"))u[y]==="*"?(e=y,t=E,y++):(E++,y++);else if(e!==-1)y=e+1,t++,E=t;else return!1;for(;y<u.length&&u[y]==="*";)y++;return y===u.length}function c(){const h=[...n.names,...n.skips.map(u=>"-"+u)].join(",");return n.enable(""),h}function S(h){for(const u of n.skips)if(m(h,u))return!1;for(const u of n.names)if(m(h,u))return!0;return!1}function T(h){return h instanceof Error?h.stack||h.message:h}function r(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}return qe=g,qe}var Ze;function Ae(){return Ze||(Ze=1,(function(g,b){var v={};b.formatArgs=x,b.save=R,b.load=m,b.useColors=n,b.storage=c(),b.destroy=(()=>{let T=!1;return()=>{T||(T=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),b.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let T;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(T=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(T[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function x(T){if(T[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+T[0]+(this.useColors?"%c ":" ")+"+"+g.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;T.splice(1,0,r,"color: inherit");let h=0,u=0;T[0].replace(/%[a-zA-Z%]/g,E=>{E!=="%%"&&(h++,E==="%c"&&(u=h))}),T.splice(u,0,r)}b.log=console.debug||console.log||(()=>{});function R(T){try{T?b.storage.setItem("debug",T):b.storage.removeItem("debug")}catch{}}function m(){let T;try{T=b.storage.getItem("debug")||b.storage.getItem("DEBUG")}catch{}return!T&&typeof process<"u"&&"env"in process&&(T=v.DEBUG),T}function c(){try{return localStorage}catch{}}g.exports=Kt()(b);const{formatters:S}=g.exports;S.j=function(T){try{return JSON.stringify(T)}catch(r){return"[UnexpectedJSONParseError]: "+r.message}}})(ke,ke.exports)),ke.exports}var Be={},Xe;function Wt(){return Xe||(Xe=1,Object.defineProperty(Be,"__esModule",{value:!0})),Be}var K={},re={},et;function $(){if(et)return re;et=1,Object.defineProperty(re,"__esModule",{value:!0}),re.Logger=void 0;const g=Ae(),b="mediasoup-client";class v{_debug;_warn;_error;constructor(x){x?(this._debug=(0,g.default)(`${b}:${x}`),this._warn=(0,g.default)(`${b}:WARN:${x}`),this._error=(0,g.default)(`${b}:ERROR:${x}`)):(this._debug=(0,g.default)(b),this._warn=(0,g.default)(`${b}:WARN`),this._error=(0,g.default)(`${b}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}return re.Logger=v,re}var se={},De={exports:{}},tt;function Jt(){if(tt)return De.exports;tt=1;var g=typeof Reflect=="object"?Reflect:null,b=g&&typeof g.apply=="function"?g.apply:function(f,p,i){return Function.prototype.apply.call(f,p,i)},v;g&&typeof g.ownKeys=="function"?v=g.ownKeys:Object.getOwnPropertySymbols?v=function(f){return Object.getOwnPropertyNames(f).concat(Object.getOwnPropertySymbols(f))}:v=function(f){return Object.getOwnPropertyNames(f)};function n(l){console&&console.warn&&console.warn(l)}var x=Number.isNaN||function(f){return f!==f};function R(){R.init.call(this)}De.exports=R,De.exports.once=s,R.EventEmitter=R,R.prototype._events=void 0,R.prototype._eventsCount=0,R.prototype._maxListeners=void 0;var m=10;function c(l){if(typeof l!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof l)}Object.defineProperty(R,"defaultMaxListeners",{enumerable:!0,get:function(){return m},set:function(l){if(typeof l!="number"||l<0||x(l))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+l+".");m=l}}),R.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},R.prototype.setMaxListeners=function(f){if(typeof f!="number"||f<0||x(f))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+f+".");return this._maxListeners=f,this};function S(l){return l._maxListeners===void 0?R.defaultMaxListeners:l._maxListeners}R.prototype.getMaxListeners=function(){return S(this)},R.prototype.emit=function(f){for(var p=[],i=1;i<arguments.length;i++)p.push(arguments[i]);var d=f==="error",w=this._events;if(w!==void 0)d=d&&w.error===void 0;else if(!d)return!1;if(d){var C;if(p.length>0&&(C=p[0]),C instanceof Error)throw C;var I=new Error("Unhandled error."+(C?" ("+C.message+")":""));throw I.context=C,I}var M=w[f];if(M===void 0)return!1;if(typeof M=="function")b(M,this,p);else for(var a=M.length,D=y(M,a),i=0;i<a;++i)b(D[i],this,p);return!0};function T(l,f,p,i){var d,w,C;if(c(p),w=l._events,w===void 0?(w=l._events=Object.create(null),l._eventsCount=0):(w.newListener!==void 0&&(l.emit("newListener",f,p.listener?p.listener:p),w=l._events),C=w[f]),C===void 0)C=w[f]=p,++l._eventsCount;else if(typeof C=="function"?C=w[f]=i?[p,C]:[C,p]:i?C.unshift(p):C.push(p),d=S(l),d>0&&C.length>d&&!C.warned){C.warned=!0;var I=new Error("Possible EventEmitter memory leak detected. "+C.length+" "+String(f)+" listeners added. Use emitter.setMaxListeners() to increase limit");I.name="MaxListenersExceededWarning",I.emitter=l,I.type=f,I.count=C.length,n(I)}return l}R.prototype.addListener=function(f,p){return T(this,f,p,!1)},R.prototype.on=R.prototype.addListener,R.prototype.prependListener=function(f,p){return T(this,f,p,!0)};function r(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(l,f,p){var i={fired:!1,wrapFn:void 0,target:l,type:f,listener:p},d=r.bind(i);return d.listener=p,i.wrapFn=d,d}R.prototype.once=function(f,p){return c(p),this.on(f,h(this,f,p)),this},R.prototype.prependOnceListener=function(f,p){return c(p),this.prependListener(f,h(this,f,p)),this},R.prototype.removeListener=function(f,p){var i,d,w,C,I;if(c(p),d=this._events,d===void 0)return this;if(i=d[f],i===void 0)return this;if(i===p||i.listener===p)--this._eventsCount===0?this._events=Object.create(null):(delete d[f],d.removeListener&&this.emit("removeListener",f,i.listener||p));else if(typeof i!="function"){for(w=-1,C=i.length-1;C>=0;C--)if(i[C]===p||i[C].listener===p){I=i[C].listener,w=C;break}if(w<0)return this;w===0?i.shift():e(i,w),i.length===1&&(d[f]=i[0]),d.removeListener!==void 0&&this.emit("removeListener",f,I||p)}return this},R.prototype.off=R.prototype.removeListener,R.prototype.removeAllListeners=function(f){var p,i,d;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[f]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[f]),this;if(arguments.length===0){var w=Object.keys(i),C;for(d=0;d<w.length;++d)C=w[d],C!=="removeListener"&&this.removeAllListeners(C);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=i[f],typeof p=="function")this.removeListener(f,p);else if(p!==void 0)for(d=p.length-1;d>=0;d--)this.removeListener(f,p[d]);return this};function u(l,f,p){var i=l._events;if(i===void 0)return[];var d=i[f];return d===void 0?[]:typeof d=="function"?p?[d.listener||d]:[d]:p?t(d):y(d,d.length)}R.prototype.listeners=function(f){return u(this,f,!0)},R.prototype.rawListeners=function(f){return u(this,f,!1)},R.listenerCount=function(l,f){return typeof l.listenerCount=="function"?l.listenerCount(f):E.call(l,f)},R.prototype.listenerCount=E;function E(l){var f=this._events;if(f!==void 0){var p=f[l];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}R.prototype.eventNames=function(){return this._eventsCount>0?v(this._events):[]};function y(l,f){for(var p=new Array(f),i=0;i<f;++i)p[i]=l[i];return p}function e(l,f){for(;f+1<l.length;f++)l[f]=l[f+1];l.pop()}function t(l){for(var f=new Array(l.length),p=0;p<f.length;++p)f[p]=l[p].listener||l[p];return f}function s(l,f){return new Promise(function(p,i){function d(C){l.removeListener(f,w),i(C)}function w(){typeof l.removeListener=="function"&&l.removeListener("error",d),p([].slice.call(arguments))}_(l,f,w,{once:!0}),f!=="error"&&o(l,d,{once:!0})})}function o(l,f,p){typeof l.on=="function"&&_(l,"error",f,p)}function _(l,f,p,i){if(typeof l.on=="function")i.once?l.once(f,p):l.on(f,p);else if(typeof l.addEventListener=="function")l.addEventListener(f,function d(w){i.once&&l.removeEventListener(f,d),p(w)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof l)}return De.exports}var rt;function z(){if(rt)return se;rt=1,Object.defineProperty(se,"__esModule",{value:!0}),se.EnhancedEventEmitter=void 0;const g=Jt(),b=$(),v=new b.Logger("EnhancedEventEmitter");class n extends g.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}close(){super.removeAllListeners()}emit(R,...m){return super.emit(R,...m)}safeEmit(R,...m){try{return super.emit(R,...m)}catch(c){v.error("safeEmit() | event listener threw an error [eventName:%s]:%o",R,c);try{super.emit("listenererror",R,c)}catch{}return!!super.listenerCount(R)}}on(R,m){return super.on(R,m),this}off(R,m){return super.off(R,m),this}addListener(R,m){return super.on(R,m),this}prependListener(R,m){return super.prependListener(R,m),this}once(R,m){return super.once(R,m),this}prependOnceListener(R,m){return super.prependOnceListener(R,m),this}removeListener(R,m){return super.off(R,m),this}removeAllListeners(R){return super.removeAllListeners(R),this}listenerCount(R){return super.listenerCount(R)}listeners(R){return super.listeners(R)}rawListeners(R){return super.rawListeners(R)}}return se.EnhancedEventEmitter=n,se}var W={},st;function U(){if(st)return W;st=1,Object.defineProperty(W,"__esModule",{value:!0}),W.InvalidStateError=W.UnsupportedError=void 0;class g extends Error{constructor(n){super(n),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,g):this.stack=new Error(n).stack}}W.UnsupportedError=g;class b extends Error{constructor(n){super(n),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,b):this.stack=new Error(n).stack}}return W.InvalidStateError=b,W}var Z={},it;function ee(){if(it)return Z;it=1,Object.defineProperty(Z,"__esModule",{value:!0}),Z.clone=g,Z.generateRandomNumber=b,Z.deepFreeze=v;function g(n){if(n!==void 0)return Number.isNaN(n)?NaN:typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))}function b(){return Math.round(Math.random()*1e7)}function v(n){const x=Reflect.ownKeys(n);for(const R of x){const m=n[R];(m&&typeof m=="object"||typeof m=="function")&&v(m)}return Object.freeze(n)}return Z}var A={},j={},ie={},nt;function Yt(){if(nt)return ie;nt=1,Object.defineProperty(ie,"__esModule",{value:!0}),ie.Logger=void 0;const g=Ae(),b="h264-profile-level-id";class v{_debug;_warn;_error;constructor(x){x?(this._debug=(0,g.default)(`${b}:${x}`),this._warn=(0,g.default)(`${b}:WARN:${x}`),this._error=(0,g.default)(`${b}:ERROR:${x}`)):(this._debug=(0,g.default)(b),this._warn=(0,g.default)(`${b}:WARN`),this._error=(0,g.default)(`${b}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}return ie.Logger=v,ie}var at;function Zt(){if(at)return j;at=1,Object.defineProperty(j,"__esModule",{value:!0}),j.ProfileLevelId=j.Level=j.Profile=void 0,j.parseProfileLevelId=r,j.profileLevelIdToString=h,j.profileToString=u,j.levelToString=E,j.parseSdpProfileLevelId=y,j.isSameProfile=e,j.isSameProfileAndLevel=t,j.generateProfileLevelIdStringForAnswer=s,j.supportedLevel=o;const g=Yt(),b=new g.Logger;var v;(function(i){i[i.ConstrainedBaseline=1]="ConstrainedBaseline",i[i.Baseline=2]="Baseline",i[i.Main=3]="Main",i[i.ConstrainedHigh=4]="ConstrainedHigh",i[i.High=5]="High",i[i.PredictiveHigh444=6]="PredictiveHigh444"})(v||(j.Profile=v={}));var n;(function(i){i[i.L1_b=0]="L1_b",i[i.L1=10]="L1",i[i.L1_1=11]="L1_1",i[i.L1_2=12]="L1_2",i[i.L1_3=13]="L1_3",i[i.L2=20]="L2",i[i.L2_1=21]="L2_1",i[i.L2_2=22]="L2_2",i[i.L3=30]="L3",i[i.L3_1=31]="L3_1",i[i.L3_2=32]="L3_2",i[i.L4=40]="L4",i[i.L4_1=41]="L4_1",i[i.L4_2=42]="L4_2",i[i.L5=50]="L5",i[i.L5_1=51]="L5_1",i[i.L5_2=52]="L5_2"})(n||(j.Level=n={}));class x{profile;level;constructor(d,w){this.profile=d,this.level=w}}j.ProfileLevelId=x;const R=new x(v.ConstrainedBaseline,n.L3_1);class m{mask;masked_value;constructor(d){this.mask=~_("x",d),this.masked_value=_("1",d)}isMatch(d){return this.masked_value===(d&this.mask)}}class c{profile_idc;profile_iop;profile;constructor(d,w,C){this.profile_idc=d,this.profile_iop=w,this.profile=C}}const S=[new c(66,new m("x1xx0000"),v.ConstrainedBaseline),new c(77,new m("1xxx0000"),v.ConstrainedBaseline),new c(88,new m("11xx0000"),v.ConstrainedBaseline),new c(66,new m("x0xx0000"),v.Baseline),new c(88,new m("10xx0000"),v.Baseline),new c(77,new m("0x0x0000"),v.Main),new c(100,new m("00000000"),v.High),new c(100,new m("00001100"),v.ConstrainedHigh),new c(244,new m("00000000"),v.PredictiveHigh444)],T=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:n.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:n.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:n.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:n.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:n.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:n.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:n.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:n.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:n.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:n.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:n.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:n.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:n.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:n.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:n.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:n.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:n.L5_2}];function r(i){if(typeof i!="string"||i.length!==6)return;const w=parseInt(i,16);if(w===0)return;const C=w&255,I=w>>8&255,M=w>>16&255;let a;switch(C){case n.L1_1:{a=(I&16)!==0?n.L1_b:n.L1_1;break}case n.L1:case n.L1_2:case n.L1_3:case n.L2:case n.L2_1:case n.L2_2:case n.L3:case n.L3_1:case n.L3_2:case n.L4:case n.L4_1:case n.L4_2:case n.L5:case n.L5_1:case n.L5_2:{a=C;break}default:{b.warn(`parseProfileLevelId() | unrecognized level_idc [str:${i}, level_idc:${C}]`);return}}for(const D of S)if(M===D.profile_idc&&D.profile_iop.isMatch(I))return b.debug(`parseProfileLevelId() | result [str:${i}, profile:${D.profile}, level:${a}]`),new x(D.profile,a);b.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${i}, profile_idc:${M}, profile_iop:${I}]`)}function h(i){if(i.level==n.L1_b)switch(i.profile){case v.ConstrainedBaseline:return"42f00b";case v.Baseline:return"42100b";case v.Main:return"4d100b";default:{b.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${i.profile}`);return}}let d;switch(i.profile){case v.ConstrainedBaseline:{d="42e0";break}case v.Baseline:{d="4200";break}case v.Main:{d="4d00";break}case v.ConstrainedHigh:{d="640c";break}case v.High:{d="6400";break}case v.PredictiveHigh444:{d="f400";break}default:{b.warn(`profileLevelIdToString() | unrecognized profile ${i.profile}`);return}}let w=i.level.toString(16);return w.length===1&&(w=`0${w}`),`${d}${w}`}function u(i){switch(i){case v.ConstrainedBaseline:return"ConstrainedBaseline";case v.Baseline:return"Baseline";case v.Main:return"Main";case v.ConstrainedHigh:return"ConstrainedHigh";case v.High:return"High";case v.PredictiveHigh444:return"PredictiveHigh444";default:{b.warn(`profileToString() | unrecognized profile ${i}`);return}}}function E(i){switch(i){case n.L1_b:return"1b";case n.L1:return"1";case n.L1_1:return"1.1";case n.L1_2:return"1.2";case n.L1_3:return"1.3";case n.L2:return"2";case n.L2_1:return"2.1";case n.L2_2:return"2.2";case n.L3:return"3";case n.L3_1:return"3.1";case n.L3_2:return"3.2";case n.L4:return"4";case n.L4_1:return"4.1";case n.L4_2:return"4.2";case n.L5:return"5";case n.L5_1:return"5.1";case n.L5_2:return"5.2";default:{b.warn(`levelToString() | unrecognized level ${i}`);return}}}function y(i={}){const d=i["profile-level-id"];return d?r(d):R}function e(i={},d={}){const w=y(i),C=y(d);return!!(w&&C&&w.profile===C.profile)}function t(i={},d={}){const w=y(i),C=y(d);return!!(w&&C&&w.profile===C.profile&&w.level==C.level)}function s(i={},d={}){if(!i["profile-level-id"]&&!d["profile-level-id"]){b.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const w=y(i),C=y(d);if(!w)throw new TypeError("invalid local_profile_level_id");if(!C)throw new TypeError("invalid remote_profile_level_id");if(w.profile!==C.profile)throw new TypeError("H264 Profile mismatch");const I=p(i)&&p(d),M=w.level,a=C.level,D=f(M,a),P=I?M:D;return b.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${w.profile}, level:${P}]`),h(new x(w.profile,P))}function o(i,d){for(let C=T.length-1;C>=0;--C){const I=T[C];if(I.max_macroblock_frame_size*256<=i&&I.max_macroblocks_per_second<=d*I.max_macroblock_frame_size)return b.debug(`supportedLevel() | result [max_frame_pixel_count:${i}, max_fps:${d}, level:${I.level}]`),I.level}b.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${i}, max_fps:${d}]`)}function _(i,d){return+(d[0]===i)<<7|+(d[1]===i)<<6|+(d[2]===i)<<5|+(d[3]===i)<<4|+(d[4]===i)<<3|+(d[5]===i)<<2|+(d[6]===i)<<1|+(d[7]===i)<<0}function l(i,d){return i===n.L1_b?d!==n.L1&&d!==n.L1_b:d===n.L1_b?i!==n.L1:i<d}function f(i,d){return l(i,d)?i:d}function p(i={}){const d=i["level-asymmetry-allowed"];return d===!0||d===1||d==="1"}return j}var ot;function V(){if(ot)return A;ot=1,Object.defineProperty(A,"__esModule",{value:!0}),A.validateAndNormalizeRtpCapabilities=R,A.validateAndNormalizeRtpParameters=m,A.validateAndNormalizeSctpStreamParameters=c,A.validateSctpCapabilities=S,A.getExtendedRtpCapabilities=T,A.getRecvRtpCapabilities=r,A.getSendingRtpParameters=h,A.getSendingRemoteRtpParameters=u,A.reduceCodecs=E,A.generateProbatorRtpParameters=y,A.canSend=e,A.canReceive=t;const g=Zt(),b=ee(),v="probator",n=1234,x=127;function R(a){if(typeof a!="object")throw new TypeError("caps is not an object");if(a.codecs&&!Array.isArray(a.codecs))throw new TypeError("caps.codecs is not an array");a.codecs||(a.codecs=[]);for(const D of a.codecs)s(D);if(a.headerExtensions&&!Array.isArray(a.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");a.headerExtensions||(a.headerExtensions=[]);for(const D of a.headerExtensions)_(D)}function m(a){if(typeof a!="object")throw new TypeError("params is not an object");if(a.mid&&typeof a.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(a.codecs))throw new TypeError("missing params.codecs");for(const D of a.codecs)l(D);if(a.headerExtensions&&!Array.isArray(a.headerExtensions))throw new TypeError("params.headerExtensions is not an array");a.headerExtensions||(a.headerExtensions=[]);for(const D of a.headerExtensions)f(D);if(a.encodings&&!Array.isArray(a.encodings))throw new TypeError("params.encodings is not an array");a.encodings||(a.encodings=[]);for(const D of a.encodings)p(D);if(a.rtcp&&typeof a.rtcp!="object")throw new TypeError("params.rtcp is not an object");a.rtcp||(a.rtcp={}),i(a.rtcp)}function c(a){if(typeof a!="object")throw new TypeError("params is not an object");if(typeof a.streamId!="number")throw new TypeError("missing params.streamId");let D=!1;if(typeof a.ordered=="boolean"?D=!0:a.ordered=!0,a.maxPacketLifeTime&&typeof a.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(a.maxRetransmits&&typeof a.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(a.maxPacketLifeTime&&a.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(D&&a.ordered&&(a.maxPacketLifeTime||a.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!D&&(a.maxPacketLifeTime||a.maxRetransmits)&&(a.ordered=!1),a.label&&typeof a.label!="string")throw new TypeError("invalid params.label");if(a.protocol&&typeof a.protocol!="string")throw new TypeError("invalid params.protocol")}function S(a){if(typeof a!="object")throw new TypeError("caps is not an object");if(!a.numStreams||typeof a.numStreams!="object")throw new TypeError("missing caps.numStreams");d(a.numStreams)}function T(a,D,P){const k={codecs:[],headerExtensions:[]};if(P)for(const L of a.codecs??[]){if(w(L))continue;const O=(D.codecs??[]).find(N=>C(N,L,{strict:!0,modify:!0}));if(!O)continue;const F={kind:L.kind,mimeType:L.mimeType,clockRate:L.clockRate,channels:L.channels,localPayloadType:L.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:O.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:L.parameters??{},remoteParameters:O.parameters??{},rtcpFeedback:M(L,O)};k.codecs.push(F)}else for(const L of D.codecs??[]){if(w(L))continue;const O=(a.codecs??[]).find(N=>C(N,L,{strict:!0,modify:!0}));if(!O)continue;const F={kind:O.kind,mimeType:O.mimeType,clockRate:O.clockRate,channels:O.channels,localPayloadType:O.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:L.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:O.parameters??{},remoteParameters:L.parameters??{},rtcpFeedback:M(O,L)};k.codecs.push(F)}for(const L of k.codecs){const O=a.codecs.find(N=>w(N)&&N.parameters?.apt===L.localPayloadType),F=D.codecs.find(N=>w(N)&&N.parameters?.apt===L.remotePayloadType);O&&F&&(L.localRtxPayloadType=O.preferredPayloadType,L.remoteRtxPayloadType=F.preferredPayloadType)}for(const L of D.headerExtensions){const O=a.headerExtensions.find(N=>I(N,L));if(!O)continue;const F={kind:L.kind,uri:L.uri,sendId:O.preferredId,recvId:L.preferredId,encrypt:O.preferredEncrypt??!1,direction:"sendrecv"};switch(L.direction){case"sendrecv":{F.direction="sendrecv";break}case"recvonly":{F.direction="sendonly";break}case"sendonly":{F.direction="recvonly";break}case"inactive":{F.direction="inactive";break}}k.headerExtensions.push(F)}return k}function r(a){const D={codecs:[],headerExtensions:[]};for(const P of a.codecs){const k={kind:P.kind,mimeType:P.mimeType,preferredPayloadType:P.remotePayloadType,clockRate:P.clockRate,channels:P.channels,parameters:P.localParameters,rtcpFeedback:P.rtcpFeedback};if(D.codecs.push(k),!P.remoteRtxPayloadType)continue;const L={kind:P.kind,mimeType:`${P.kind}/rtx`,preferredPayloadType:P.remoteRtxPayloadType,clockRate:P.clockRate,parameters:{apt:P.remotePayloadType},rtcpFeedback:[]};D.codecs.push(L)}for(const P of a.headerExtensions){if(P.direction!=="sendrecv"&&P.direction!=="recvonly")continue;const k={kind:P.kind,uri:P.uri,preferredId:P.recvId,preferredEncrypt:P.encrypt??!1,direction:P.direction};D.headerExtensions.push(k)}return D}function h(a,D){const P={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const k of D.codecs){if(k.kind!==a)continue;const L={mimeType:k.mimeType,payloadType:k.localPayloadType,clockRate:k.clockRate,channels:k.channels,parameters:k.localParameters,rtcpFeedback:k.rtcpFeedback};if(P.codecs.push(L),k.localRtxPayloadType){const O={mimeType:`${k.kind}/rtx`,payloadType:k.localRtxPayloadType,clockRate:k.clockRate,parameters:{apt:k.localPayloadType},rtcpFeedback:[]};P.codecs.push(O)}}for(const k of D.headerExtensions){if(k.kind&&k.kind!==a||k.direction!=="sendrecv"&&k.direction!=="sendonly")continue;const L={uri:k.uri,id:k.sendId,encrypt:k.encrypt,parameters:{}};P.headerExtensions.push(L)}return P}function u(a,D){const P={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const k of D.codecs){if(k.kind!==a)continue;const L={mimeType:k.mimeType,payloadType:k.localPayloadType,clockRate:k.clockRate,channels:k.channels,parameters:k.remoteParameters,rtcpFeedback:k.rtcpFeedback};if(P.codecs.push(L),k.localRtxPayloadType){const O={mimeType:`${k.kind}/rtx`,payloadType:k.localRtxPayloadType,clockRate:k.clockRate,parameters:{apt:k.localPayloadType},rtcpFeedback:[]};P.codecs.push(O)}}for(const k of D.headerExtensions){if(k.kind&&k.kind!==a||k.direction!=="sendrecv"&&k.direction!=="sendonly")continue;const L={uri:k.uri,id:k.sendId,encrypt:k.encrypt,parameters:{}};P.headerExtensions.push(L)}if(P.headerExtensions.some(k=>k.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const k of P.codecs)k.rtcpFeedback=(k.rtcpFeedback??[]).filter(L=>L.type!=="goog-remb");else if(P.headerExtensions.some(k=>k.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const k of P.codecs)k.rtcpFeedback=(k.rtcpFeedback??[]).filter(L=>L.type!=="transport-cc");else for(const k of P.codecs)k.rtcpFeedback=(k.rtcpFeedback??[]).filter(L=>L.type!=="transport-cc"&&L.type!=="goog-remb");return P}function E(a,D){const P=[];if(!D)P.push(a[0]),w(a[1])&&P.push(a[1]);else{for(let k=0;k<a.length;++k)if(C(a[k],D,{strict:!0})){P.push(a[k]),w(a[k+1])&&P.push(a[k+1]);break}if(P.length===0)throw new TypeError("no matching codec found")}return P}function y(a){a=b.clone(a),m(a);const D={mid:v,codecs:[],headerExtensions:[],encodings:[{ssrc:n}],rtcp:{cname:"probator"}};return D.codecs.push(a.codecs[0]),D.codecs[0].payloadType=x,D.headerExtensions=a.headerExtensions,D}function e(a,D){return(D.codecs??[]).some(P=>P.kind===a)}function t(a,D){if(m(a),a.codecs.length===0)return!1;const P=a.codecs[0];return(D.codecs??[]).some(k=>k.preferredPayloadType===P.payloadType)}function s(a){const D=new RegExp("^(audio|video)/(.+)","i");if(typeof a!="object")throw new TypeError("codec is not an object");if(!a.mimeType||typeof a.mimeType!="string")throw new TypeError("missing codec.mimeType");const P=D.exec(a.mimeType);if(!P)throw new TypeError("invalid codec.mimeType");if(a.kind=P[1].toLowerCase(),typeof a.preferredPayloadType!="number")throw new TypeError("missing codec.preferredPayloadType");if(typeof a.clockRate!="number")throw new TypeError("missing codec.clockRate");a.kind==="audio"?typeof a.channels!="number"&&(a.channels=1):delete a.channels,(!a.parameters||typeof a.parameters!="object")&&(a.parameters={});for(const k of Object.keys(a.parameters)){let L=a.parameters[k];if(L===void 0&&(a.parameters[k]="",L=""),typeof L!="string"&&typeof L!="number")throw new TypeError(`invalid codec parameter [key:${k}s, value:${L}]`);if(k==="apt"&&typeof L!="number")throw new TypeError("invalid codec apt parameter")}(!a.rtcpFeedback||!Array.isArray(a.rtcpFeedback))&&(a.rtcpFeedback=[]);for(const k of a.rtcpFeedback)o(k)}function o(a){if(typeof a!="object")throw new TypeError("fb is not an object");if(!a.type||typeof a.type!="string")throw new TypeError("missing fb.type");(!a.parameter||typeof a.parameter!="string")&&(a.parameter="")}function _(a){if(typeof a!="object")throw new TypeError("ext is not an object");if(a.kind!=="audio"&&a.kind!=="video")throw new TypeError("invalid ext.kind");if(!a.uri||typeof a.uri!="string")throw new TypeError("missing ext.uri");if(typeof a.preferredId!="number")throw new TypeError("missing ext.preferredId");if(a.preferredEncrypt&&typeof a.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(a.preferredEncrypt||(a.preferredEncrypt=!1),a.direction&&typeof a.direction!="string")throw new TypeError("invalid ext.direction");a.direction||(a.direction="sendrecv")}function l(a){const D=new RegExp("^(audio|video)/(.+)","i");if(typeof a!="object")throw new TypeError("codec is not an object");if(!a.mimeType||typeof a.mimeType!="string")throw new TypeError("missing codec.mimeType");const P=D.exec(a.mimeType);if(!P)throw new TypeError("invalid codec.mimeType");if(typeof a.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof a.clockRate!="number")throw new TypeError("missing codec.clockRate");P[1].toLowerCase()==="audio"?typeof a.channels!="number"&&(a.channels=1):delete a.channels,(!a.parameters||typeof a.parameters!="object")&&(a.parameters={});for(const L of Object.keys(a.parameters)){let O=a.parameters[L];if(O===void 0&&(a.parameters[L]="",O=""),typeof O!="string"&&typeof O!="number")throw new TypeError(`invalid codec parameter [key:${L}s, value:${O}]`);if(L==="apt"&&typeof O!="number")throw new TypeError("invalid codec apt parameter")}(!a.rtcpFeedback||!Array.isArray(a.rtcpFeedback))&&(a.rtcpFeedback=[]);for(const L of a.rtcpFeedback)o(L)}function f(a){if(typeof a!="object")throw new TypeError("ext is not an object");if(!a.uri||typeof a.uri!="string")throw new TypeError("missing ext.uri");if(typeof a.id!="number")throw new TypeError("missing ext.id");if(a.encrypt&&typeof a.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");a.encrypt||(a.encrypt=!1),(!a.parameters||typeof a.parameters!="object")&&(a.parameters={});for(const D of Object.keys(a.parameters)){let P=a.parameters[D];if(P===void 0&&(a.parameters[D]="",P=""),typeof P!="string"&&typeof P!="number")throw new TypeError("invalid header extension parameter")}}function p(a){if(typeof a!="object")throw new TypeError("encoding is not an object");if(a.ssrc&&typeof a.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(a.rid&&typeof a.rid!="string")throw new TypeError("invalid encoding.rid");if(a.rtx&&typeof a.rtx!="object")throw new TypeError("invalid encoding.rtx");if(a.rtx&&typeof a.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!a.dtx||typeof a.dtx!="boolean")&&(a.dtx=!1),a.scalabilityMode&&typeof a.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function i(a){if(typeof a!="object")throw new TypeError("rtcp is not an object");if(a.cname&&typeof a.cname!="string")throw new TypeError("invalid rtcp.cname");(!a.reducedSize||typeof a.reducedSize!="boolean")&&(a.reducedSize=!0)}function d(a){if(typeof a!="object")throw new TypeError("numStreams is not an object");if(typeof a.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof a.MIS!="number")throw new TypeError("missing numStreams.MIS")}function w(a){return a?/.+\/rtx$/i.test(a.mimeType):!1}function C(a,D,{strict:P=!1,modify:k=!1}={}){const L=a.mimeType.toLowerCase(),O=D.mimeType.toLowerCase();if(L!==O||a.clockRate!==D.clockRate||a.channels!==D.channels)return!1;switch(L){case"video/h264":{if(P){const F=a.parameters["packetization-mode"]??0,N=D.parameters["packetization-mode"]??0;if(F!==N||!g.isSameProfile(a.parameters,D.parameters))return!1;let Y;try{Y=g.generateProfileLevelIdStringForAnswer(a.parameters,D.parameters)}catch{return!1}k&&(Y?(a.parameters["profile-level-id"]=Y,D.parameters["profile-level-id"]=Y):(delete a.parameters["profile-level-id"],delete D.parameters["profile-level-id"]))}break}case"video/vp9":{if(P){const F=a.parameters["profile-id"]??0,N=D.parameters["profile-id"]??0;if(F!==N)return!1}break}}return!0}function I(a,D){return!(a.kind&&D.kind&&a.kind!==D.kind||a.uri!==D.uri)}function M(a,D){const P=[];for(const k of a.rtcpFeedback??[]){const L=(D.rtcpFeedback??[]).find(O=>O.type===k.type&&(O.parameter===k.parameter||!O.parameter&&!k.parameter));L&&P.push(L)}return P}return A}var ne={},Ue={},ae={},oe={},ct;function Xt(){if(ct)return oe;ct=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.Logger=void 0;const g=Ae(),b="awaitqueue";let v=class{_debug;_warn;_error;constructor(x){x?(this._debug=g(`${b}:${x}`),this._warn=g(`${b}:WARN:${x}`),this._error=g(`${b}:ERROR:${x}`)):(this._debug=g(b),this._warn=g(`${b}:WARN`),this._error=g(`${b}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};return oe.Logger=v,oe}var J={},dt;function Bt(){if(dt)return J;dt=1,Object.defineProperty(J,"__esModule",{value:!0}),J.AwaitQueueRemovedTaskError=J.AwaitQueueStoppedError=void 0;class g extends Error{constructor(n){super(n??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,g)}}J.AwaitQueueStoppedError=g;class b extends Error{constructor(n){super(n??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,b)}}return J.AwaitQueueRemovedTaskError=b,J}var pt;function er(){if(pt)return ae;pt=1,Object.defineProperty(ae,"__esModule",{value:!0}),ae.AwaitQueue=void 0;const g=Xt(),b=Bt(),v=new g.Logger("AwaitQueue");let n=class{pendingTasks=new Map;nextTaskId=0;constructor(){v.debug("constructor()")}get size(){return this.pendingTasks.size}async push(R,m,c){if(m=m??R.name,v.debug(`push() [name:${m}, options:%o]`,c),typeof R!="function")throw new TypeError("given task is not a function");if(m)try{Object.defineProperty(R,"name",{value:m})}catch{}return new Promise((S,T)=>{if(m&&c?.removeOngoingTasksWithSameName)for(const h of this.pendingTasks.values())h.name===m&&h.reject(new b.AwaitQueueRemovedTaskError,{canExecuteNextTask:!1});const r={id:this.nextTaskId++,task:R,name:m,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:h=>{if(r.completed)return;r.completed=!0,this.pendingTasks.delete(r.id),v.debug(`resolving task [name:${r.name}]`),S(h);const[u]=this.pendingTasks.values();u&&!u.executedAt&&this.execute(u)},reject:(h,{canExecuteNextTask:u})=>{if(!r.completed&&(r.completed=!0,this.pendingTasks.delete(r.id),v.debug(`rejecting task [name:${r.name}]: %s`,String(h)),T(h),u)){const[E]=this.pendingTasks.values();E&&!E.executedAt&&this.execute(E)}}};this.pendingTasks.set(r.id,r),this.pendingTasks.size===1&&this.execute(r)})}stop(){v.debug("stop()");for(const R of this.pendingTasks.values())v.debug(`stop() | stopping task [name:${R.name}]`),R.reject(new b.AwaitQueueStoppedError,{canExecuteNextTask:!1})}remove(R){v.debug(`remove() [taskIdx:${R}]`);const m=Array.from(this.pendingTasks.values())[R];if(!m){v.debug(`stop() | no task with given idx [taskIdx:${R}]`);return}m.reject(new b.AwaitQueueRemovedTaskError,{canExecuteNextTask:!0})}dump(){const R=Date.now();let m=0;return Array.from(this.pendingTasks.values()).map(c=>({idx:m++,task:c.task,name:c.name,enqueuedTime:c.executedAt?c.executedAt-c.enqueuedAt:R-c.enqueuedAt,executionTime:c.executedAt?R-c.executedAt:0}))}async execute(R){if(v.debug(`execute() [name:${R.name}]`),R.executedAt)throw new Error("task already being executed");R.executedAt=Date.now();try{const m=await R.task();R.resolve(m)}catch(m){R.reject(m,{canExecuteNextTask:!0})}}};return ae.AwaitQueue=n,ae}var lt;function tr(){return lt||(lt=1,(function(g){Object.defineProperty(g,"__esModule",{value:!0}),g.AwaitQueueRemovedTaskError=g.AwaitQueueStoppedError=g.AwaitQueue=void 0;var b=er();Object.defineProperty(g,"AwaitQueue",{enumerable:!0,get:function(){return b.AwaitQueue}});var v=Bt();Object.defineProperty(g,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return v.AwaitQueueStoppedError}}),Object.defineProperty(g,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return v.AwaitQueueRemovedTaskError}})})(Ue)),Ue}var ce={},ut;function rr(){if(ut)return ce;ut=1,Object.defineProperty(ce,"__esModule",{value:!0}),ce.Producer=void 0;const g=$(),b=z(),v=U(),n=new g.Logger("Producer");let x=class extends b.EnhancedEventEmitter{_id;_localId;_closed=!1;_rtpSender;_track;_kind;_rtpParameters;_paused;_maxSpatialLayer;_stopTracks;_disableTrackOnPause;_zeroRtpOnPause;_appData;_observer=new b.EnhancedEventEmitter;constructor({id:m,localId:c,rtpSender:S,track:T,rtpParameters:r,stopTracks:h,disableTrackOnPause:u,zeroRtpOnPause:E,appData:y}){super(),n.debug("constructor()"),this._id=m,this._localId=c,this._rtpSender=S,this._track=T,this._kind=T.kind,this._rtpParameters=r,this._paused=u?!T.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=h,this._disableTrackOnPause=u,this._zeroRtpOnPause=E,this._appData=y??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(m){this._appData=m}get observer(){return this._observer}close(){this._closed||(n.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new v.InvalidStateError("closed");return new Promise((m,c)=>{this.safeEmit("@getstats",m,c)})}pause(){if(n.debug("pause()"),this._closed){n.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((m,c)=>{this.safeEmit("@pause",m,c)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(n.debug("resume()"),this._closed){n.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((m,c)=>{this.safeEmit("@resume",m,c)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:m}){if(n.debug("replaceTrack() [track:%o]",m),this._closed){if(m&&this._stopTracks)try{m.stop()}catch{}throw new v.InvalidStateError("closed")}else if(m?.readyState==="ended")throw new v.InvalidStateError("track ended");if(m===this._track){n.debug("replaceTrack() | same track, ignored");return}await new Promise((c,S)=>{this.safeEmit("@replacetrack",m,c,S)}),this.destroyTrack(),this._track=m,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(m){if(this._closed)throw new v.InvalidStateError("closed");if(this._kind!=="video")throw new v.UnsupportedError("not a video Producer");if(typeof m!="number")throw new TypeError("invalid spatialLayer");m!==this._maxSpatialLayer&&(await new Promise((c,S)=>{this.safeEmit("@setmaxspatiallayer",m,c,S)}).catch(()=>{}),this._maxSpatialLayer=m)}async setRtpEncodingParameters(m){if(this._closed)throw new v.InvalidStateError("closed");if(typeof m!="object")throw new TypeError("invalid params");await new Promise((c,S)=>{this.safeEmit("@setrtpencodingparameters",m,c,S)})}onTrackEnded(){n.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};return ce.Producer=x,ce}var de={},ht;function sr(){if(ht)return de;ht=1,Object.defineProperty(de,"__esModule",{value:!0}),de.Consumer=void 0;const g=$(),b=z(),v=U(),n=new g.Logger("Consumer");let x=class extends b.EnhancedEventEmitter{_id;_localId;_producerId;_closed=!1;_rtpReceiver;_track;_rtpParameters;_paused;_appData;_observer=new b.EnhancedEventEmitter;constructor({id:m,localId:c,producerId:S,rtpReceiver:T,track:r,rtpParameters:h,appData:u}){super(),n.debug("constructor()"),this._id=m,this._localId=c,this._producerId=S,this._rtpReceiver=T,this._track=r,this._rtpParameters=h,this._paused=!r.enabled,this._appData=u??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(m){this._appData=m}get observer(){return this._observer}close(){this._closed||(n.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new v.InvalidStateError("closed");return new Promise((m,c)=>{this.safeEmit("@getstats",m,c)})}pause(){if(n.debug("pause()"),this._closed){n.error("pause() | Consumer closed");return}if(this._paused){n.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(n.debug("resume()"),this._closed){n.error("resume() | Consumer closed");return}if(!this._paused){n.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){n.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}};return de.Consumer=x,de}var pe={},ft;function ir(){if(ft)return pe;ft=1,Object.defineProperty(pe,"__esModule",{value:!0}),pe.DataProducer=void 0;const g=$(),b=z(),v=U(),n=new g.Logger("DataProducer");let x=class extends b.EnhancedEventEmitter{_id;_dataChannel;_closed=!1;_sctpStreamParameters;_appData;_observer=new b.EnhancedEventEmitter;constructor({id:m,dataChannel:c,sctpStreamParameters:S,appData:T}){super(),n.debug("constructor()"),this._id=m,this._dataChannel=c,this._sctpStreamParameters=S,this._appData=T??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(m){this._dataChannel.bufferedAmountLowThreshold=m}get appData(){return this._appData}set appData(m){this._appData=m}get observer(){return this._observer}close(){this._closed||(n.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(m){if(n.debug("send()"),this._closed)throw new v.InvalidStateError("closed");this._dataChannel.send(m)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(n.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",m=>{if(this._closed)return;const c=m.error??new Error("unknown DataChannel error");m.error?.errorDetail==="sctp-failure"?n.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",m.error?.sctpCauseCode,m.error.message):n.error('DataChannel "error" event: %o',c),this.safeEmit("error",c)}),this._dataChannel.addEventListener("close",()=>{this._closed||(n.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||n.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};return pe.DataProducer=x,pe}var le={},mt;function nr(){if(mt)return le;mt=1,Object.defineProperty(le,"__esModule",{value:!0}),le.DataConsumer=void 0;const g=$(),b=z(),v=new g.Logger("DataConsumer");let n=class extends b.EnhancedEventEmitter{_id;_dataProducerId;_dataChannel;_closed=!1;_sctpStreamParameters;_appData;_observer=new b.EnhancedEventEmitter;constructor({id:R,dataProducerId:m,dataChannel:c,sctpStreamParameters:S,appData:T}){super(),v.debug("constructor()"),this._id=R,this._dataProducerId=m,this._dataChannel=c,this._sctpStreamParameters=S,this._appData=T??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(R){this._dataChannel.binaryType=R}get appData(){return this._appData}set appData(R){this._appData=R}get observer(){return this._observer}close(){this._closed||(v.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(v.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(v.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",R=>{if(this._closed)return;const m=R.error??new Error("unknown DataChannel error");R.error?.errorDetail==="sctp-failure"?v.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",R.error?.sctpCauseCode,R.error.message):v.error('DataChannel "error" event: %o',m),this.safeEmit("error",m)}),this._dataChannel.addEventListener("close",()=>{this._closed||(v.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",R=>{this._closed||this.safeEmit("message",R.data)})}};return le.DataConsumer=n,le}var gt;function ar(){if(gt)return ne;gt=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.Transport=void 0;const g=tr(),b=$(),v=z(),n=U(),x=ee(),R=V(),m=rr(),c=sr(),S=ir(),T=nr(),r=new b.Logger("Transport");class h{consumerOptions;promise;resolve;reject;constructor(y){this.consumerOptions=y,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}let u=class extends v.EnhancedEventEmitter{_id;_closed=!1;_direction;_getSendExtendedRtpCapabilities;_recvRtpCapabilities;_canProduceByKind;_maxSctpMessageSize;_handler;_iceGatheringState="new";_connectionState="new";_appData;_producers=new Map;_consumers=new Map;_dataProducers=new Map;_dataConsumers=new Map;_probatorConsumerCreated=!1;_awaitQueue=new g.AwaitQueue;_pendingConsumerTasks=[];_consumerCreationInProgress=!1;_pendingPauseConsumers=new Map;_consumerPauseInProgress=!1;_pendingResumeConsumers=new Map;_consumerResumeInProgress=!1;_pendingCloseConsumers=new Map;_consumerCloseInProgress=!1;_observer=new v.EnhancedEventEmitter;constructor({direction:y,id:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,appData:i,handlerFactory:d,getSendExtendedRtpCapabilities:w,recvRtpCapabilities:C,canProduceByKind:I}){super(),r.debug("constructor() [id:%s, direction:%s]",e,y),this._id=e,this._direction=y,this._getSendExtendedRtpCapabilities=w,this._recvRtpCapabilities=C,this._canProduceByKind=I,this._maxSctpMessageSize=_?_.maxMessageSize:null;const M=x.clone(p)??{};delete M.iceServers,delete M.iceTransportPolicy,delete M.bundlePolicy,delete M.rtcpMuxPolicy,this._handler=d.factory({direction:y,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:M,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities}),this._appData=i??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(y){this._appData=y}get observer(){return this._observer}close(){if(!this._closed){r.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const y of this._producers.values())y.transportClosed();this._producers.clear();for(const y of this._consumers.values())y.transportClosed();this._consumers.clear();for(const y of this._dataProducers.values())y.transportClosed();this._dataProducers.clear();for(const y of this._dataConsumers.values())y.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close"),super.close(),this._observer.close()}}async getStats(){if(this._closed)throw new n.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:y}){if(r.debug("restartIce()"),this._closed)throw new n.InvalidStateError("closed");if(!y)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(y),"transport.restartIce()")}async updateIceServers({iceServers:y}={}){if(r.debug("updateIceServers()"),this._closed)throw new n.InvalidStateError("closed");if(!Array.isArray(y))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(y),"transport.updateIceServers()")}async produce({track:y,streamId:e,encodings:t,codecOptions:s,headerExtensionOptions:o,codec:_,stopTracks:l=!0,disableTrackOnPause:f=!0,zeroRtpOnPause:p=!1,onRtpSender:i,appData:d={}}={}){if(r.debug("produce() [track:%o]",y),this._closed)throw new n.InvalidStateError("closed");if(y){if(this._direction!=="send")throw new n.UnsupportedError("not a sending Transport");if(this._canProduceByKind[y.kind]){if(y.readyState==="ended")throw new n.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object")}else throw new n.UnsupportedError(`cannot produce ${y.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let w;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t?.length===0?w=void 0:t&&(w=t.map(a=>{const D={active:!0};return a.active===!1&&(D.active=!1),typeof a.dtx=="boolean"&&(D.dtx=a.dtx),typeof a.scalabilityMode=="string"&&(D.scalabilityMode=a.scalabilityMode),typeof a.scaleResolutionDownBy=="number"&&(D.scaleResolutionDownBy=a.scaleResolutionDownBy),typeof a.maxBitrate=="number"&&(D.maxBitrate=a.maxBitrate),typeof a.maxFramerate=="number"&&(D.maxFramerate=a.maxFramerate),typeof a.adaptivePtime=="boolean"&&(D.adaptivePtime=a.adaptivePtime),typeof a.priority=="string"&&(D.priority=a.priority),typeof a.networkPriority=="string"&&(D.networkPriority=a.networkPriority),D}));const{localId:C,rtpParameters:I,rtpSender:M}=await this._handler.send({track:y,streamId:e,encodings:w,codecOptions:s,headerExtensionOptions:o,codec:_,onRtpSender:i});try{R.validateAndNormalizeRtpParameters(I);const{id:a}=await new Promise((P,k)=>{this.safeEmit("produce",{kind:y.kind,rtpParameters:I,appData:d},P,k)}),D=new m.Producer({id:a,localId:C,rtpSender:M,track:y,rtpParameters:I,stopTracks:l,disableTrackOnPause:f,zeroRtpOnPause:p,appData:d});return this._producers.set(D.id,D),this.handleProducer(D),this._observer.safeEmit("newproducer",D),D}catch(a){throw this._handler.stopSending(C).catch(()=>{}),a}},"transport.produce()").catch(w=>{if(l)try{y.stop()}catch{}throw w})}async consume({id:y,producerId:e,kind:t,rtpParameters:s,streamId:o,onRtpReceiver:_,appData:l={}}){if(r.debug("consume()"),this._closed)throw new n.InvalidStateError("closed");if(this._direction!=="recv")throw new n.UnsupportedError("not a receiving Transport");if(typeof y!="string")throw new TypeError("missing id");if(typeof e!="string")throw new TypeError("missing producerId");if(t!=="audio"&&t!=="video")throw new TypeError(`invalid kind '${t}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(l&&typeof l!="object")throw new TypeError("if given, appData must be an object");const f=x.clone(s);if(!R.canReceive(f,this._recvRtpCapabilities))throw new n.UnsupportedError("cannot consume this Producer");const i=new h({id:y,producerId:e,kind:t,rtpParameters:f,streamId:o,onRtpReceiver:_,appData:l});return this._pendingConsumerTasks.push(i),queueMicrotask(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),i.promise}async produceData({ordered:y=!0,maxPacketLifeTime:e,maxRetransmits:t,label:s="",protocol:o="",appData:_={}}={}){if(r.debug("produceData()"),this._closed)throw new n.InvalidStateError("closed");if(this._direction!=="send")throw new n.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(_&&typeof _!="object")throw new TypeError("if given, appData must be an object")}else throw new n.UnsupportedError("SCTP not enabled by remote Transport");return(e||t)&&(y=!1),this._awaitQueue.push(async()=>{const{dataChannel:l,sctpStreamParameters:f}=await this._handler.sendDataChannel({ordered:y,maxPacketLifeTime:e,maxRetransmits:t,label:s,protocol:o});R.validateAndNormalizeSctpStreamParameters(f);const{id:p}=await new Promise((d,w)=>{this.safeEmit("producedata",{sctpStreamParameters:f,label:s,protocol:o,appData:_},d,w)}),i=new S.DataProducer({id:p,dataChannel:l,sctpStreamParameters:f,appData:_});return this._dataProducers.set(i.id,i),this.handleDataProducer(i),this._observer.safeEmit("newdataproducer",i),i},"transport.produceData()")}async consumeData({id:y,dataProducerId:e,sctpStreamParameters:t,label:s="",protocol:o="",appData:_={}}){if(r.debug("consumeData()"),this._closed)throw new n.InvalidStateError("closed");if(this._direction!=="recv")throw new n.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof y!="string")throw new TypeError("missing id");if(typeof e!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(_&&typeof _!="object")throw new TypeError("if given, appData must be an object")}else throw new n.UnsupportedError("SCTP not enabled by remote Transport");const l=x.clone(t);return R.validateAndNormalizeSctpStreamParameters(l),this._awaitQueue.push(async()=>{const{dataChannel:f}=await this._handler.receiveDataChannel({sctpStreamParameters:l,label:s,protocol:o}),p=new T.DataConsumer({id:y,dataProducerId:e,dataChannel:f,sctpStreamParameters:l,appData:_});return this._dataConsumers.set(p.id,p),this.handleDataConsumer(p),this._observer.safeEmit("newdataconsumer",p),p},"transport.consumeData()")}createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){r.debug("createPendingConsumers() | there is no Consumer to be created");return}const y=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let e;const t=[];for(const s of y){const{id:o,kind:_,rtpParameters:l,streamId:f,onRtpReceiver:p}=s.consumerOptions;t.push({trackId:o,kind:_,rtpParameters:l,streamId:f,onRtpReceiver:p})}try{const s=await this._handler.receive(t);for(let o=0;o<s.length;++o){const _=y[o],l=s[o],{id:f,producerId:p,kind:i,rtpParameters:d,appData:w}=_.consumerOptions,{localId:C,rtpReceiver:I,track:M}=l,a=new c.Consumer({id:f,localId:C,producerId:p,rtpReceiver:I,track:M,rtpParameters:d,appData:w});this._consumers.set(a.id,a),this.handleConsumer(a),!this._probatorConsumerCreated&&!e&&i==="video"&&(e=a),this._observer.safeEmit("newconsumer",a),_.resolve(a)}}catch(s){for(const o of y)o.reject(s)}if(e)try{const s=R.generateProbatorRtpParameters(e.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:s}]),r.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(s){r.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",s)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){r.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const y=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const e=y.map(t=>t.localId);await this._handler.pauseReceiving(e)}catch(e){r.error("pausePendingConsumers() | failed to pause Consumers:",e)}},"transport.pausePendingConsumers()").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){r.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const y=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const e=y.map(t=>t.localId);await this._handler.resumeReceiving(e)}catch(e){r.error("resumePendingConsumers() | failed to resume Consumers:",e)}},"transport.resumePendingConsumers()").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){r.debug("closePendingConsumers() | there is no Consumer to be closed");return}const y=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(y.map(e=>e.localId))}catch(e){r.error("closePendingConsumers() | failed to close Consumers:",e)}},"transport.closePendingConsumers()").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const y=this._handler;y.on("@connect",({dtlsParameters:e},t,s)=>{if(this._closed){s(new n.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:e},t,s)}),y.on("@icegatheringstatechange",e=>{e!==this._iceGatheringState&&(r.debug("ICE gathering state changed to %s",e),this._iceGatheringState=e,this._closed||this.safeEmit("icegatheringstatechange",e))}),y.on("@icecandidateerror",e=>{r.warn(`ICE candidate error [url:${e.url}, localAddress:${e.address}, localPort:${e.port}]: ${e.errorCode} "${e.errorText}"`),this.safeEmit("icecandidateerror",e)}),y.on("@connectionstatechange",e=>{e!==this._connectionState&&(r.debug("connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))})}handleProducer(y){y.on("@close",()=>{this._producers.delete(y.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(y.localId),"producer @close event").catch(e=>r.warn("producer.close() failed:%o",e))}),y.on("@pause",(e,t)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(y.localId),"producer @pause event").then(e).catch(t)}),y.on("@resume",(e,t)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(y.localId),"producer @resume event").then(e).catch(t)}),y.on("@replacetrack",(e,t,s)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(y.localId,e),"producer @replacetrack event").then(t).catch(s)}),y.on("@setmaxspatiallayer",(e,t,s)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(y.localId,e),"producer @setmaxspatiallayer event").then(t).catch(s)}),y.on("@setrtpencodingparameters",(e,t,s)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(y.localId,e),"producer @setrtpencodingparameters event").then(t).catch(s)}),y.on("@getstats",(e,t)=>{if(this._closed)return t(new n.InvalidStateError("closed"));this._handler.getSenderStats(y.localId).then(e).catch(t)})}handleConsumer(y){y.on("@close",()=>{this._consumers.delete(y.id),this._pendingPauseConsumers.delete(y.id),this._pendingResumeConsumers.delete(y.id),!this._closed&&(this._pendingCloseConsumers.set(y.id,y),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),y.on("@pause",()=>{this._pendingResumeConsumers.has(y.id)&&this._pendingResumeConsumers.delete(y.id),this._pendingPauseConsumers.set(y.id,y),queueMicrotask(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),y.on("@resume",()=>{this._pendingPauseConsumers.has(y.id)&&this._pendingPauseConsumers.delete(y.id),this._pendingResumeConsumers.set(y.id,y),queueMicrotask(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),y.on("@getstats",(e,t)=>{if(this._closed)return t(new n.InvalidStateError("closed"));this._handler.getReceiverStats(y.localId).then(e).catch(t)})}handleDataProducer(y){y.on("@close",()=>{this._dataProducers.delete(y.id)})}handleDataConsumer(y){y.on("@close",()=>{this._dataConsumers.delete(y.id)})}};return ne.Transport=u,ne}var ue={},B={},He={},Ve={exports:{}},_t;function We(){if(_t)return Ve.exports;_t=1;var g=Ve.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(b){return b.encoding?"rtpmap:%d %s/%s/%s":b.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(b){return b.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(b){return b.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(b){return"extmap:%d"+(b.direction?"/%s":"%v")+(b["encrypt-uri"]?" %s":"%v")+" %s"+(b.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(b){return b.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(b){var v="candidate:%s %d %s %d %s %d typ %s";return v+=b.raddr!=null?" raddr %s rport %d":"%v%v",v+=b.tcptype!=null?" tcptype %s":"%v",b.generation!=null&&(v+=" generation %d"),v+=b["network-id"]!=null?" network-id %d":"%v",v+=b["network-cost"]!=null?" network-cost %d":"%v",v}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(b){var v="ssrc:%d";return b.attribute!=null&&(v+=" %s",b.value!=null&&(v+=":%s")),v}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(b){return b.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(b){return b.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(b){return"imageattr:%s %s %s"+(b.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(b){return"simulcast:%s %s"+(b.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(b){return"ts-refclk:%s"+(b.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(b){var v="mediaclk:";return v+=b.id!=null?"id=%s %s":"%v%s",v+=b.mediaClockValue!=null?"=%s":"",v+=b.rateNumerator!=null?" rate=%s":"",v+=b.rateDenominator!=null?"/%s":"",v}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(g).forEach(function(b){var v=g[b];v.forEach(function(n){n.reg||(n.reg=/(.*)/),n.format||(n.format="%s")})}),Ve.exports}var vt;function or(){return vt||(vt=1,(function(g){var b=function(c){return String(Number(c))===c?Number(c):c},v=function(c,S,T,r){if(r&&!T)S[r]=b(c[1]);else for(var h=0;h<T.length;h+=1)c[h+1]!=null&&(S[T[h]]=b(c[h+1]))},n=function(c,S,T){var r=c.name&&c.names;c.push&&!S[c.push]?S[c.push]=[]:r&&!S[c.name]&&(S[c.name]={});var h=c.push?{}:r?S[c.name]:S;v(T.match(c.reg),h,c.names,c.name),c.push&&S[c.push].push(h)},x=We(),R=RegExp.prototype.test.bind(/^([a-z])=(.*)/);g.parse=function(c){var S={},T=[],r=S;return c.split(/(\r\n|\r|\n)/).filter(R).forEach(function(h){var u=h[0],E=h.slice(2);u==="m"&&(T.push({rtp:[],fmtp:[]}),r=T[T.length-1]);for(var y=0;y<(x[u]||[]).length;y+=1){var e=x[u][y];if(e.reg.test(E))return n(e,r,E)}}),S.media=T,S};var m=function(c,S){var T=S.split(/=(.+)/,2);return T.length===2?c[T[0]]=b(T[1]):T.length===1&&S.length>1&&(c[T[0]]=void 0),c};g.parseParams=function(c){return c.split(/;\s?/).reduce(m,{})},g.parseFmtpConfig=g.parseParams,g.parsePayloads=function(c){return c.toString().split(" ").map(Number)},g.parseRemoteCandidates=function(c){for(var S=[],T=c.split(" ").map(b),r=0;r<T.length;r+=3)S.push({component:T[r],ip:T[r+1],port:T[r+2]});return S},g.parseImageAttributes=function(c){return c.split(" ").map(function(S){return S.substring(1,S.length-1).split(",").reduce(m,{})})},g.parseSimulcastStreamList=function(c){return c.split(";").map(function(S){return S.split(",").map(function(T){var r,h=!1;return T[0]!=="~"?r=b(T):(r=b(T.substring(1,T.length)),h=!0),{scid:r,paused:h}})})}})(He)),He}var Qe,wt;function cr(){if(wt)return Qe;wt=1;var g=We(),b=/%[sdv%]/g,v=function(m){var c=1,S=arguments,T=S.length;return m.replace(b,function(r){if(c>=T)return r;var h=S[c];switch(c+=1,r){case"%%":return"%";case"%s":return String(h);case"%d":return Number(h);case"%v":return""}})},n=function(m,c,S){var T=c.format instanceof Function?c.format(c.push?S:S[c.name]):c.format,r=[m+"="+T];if(c.names)for(var h=0;h<c.names.length;h+=1){var u=c.names[h];c.name?r.push(S[c.name][u]):r.push(S[c.names[h]])}else r.push(S[c.name]);return v.apply(null,r)},x=["v","o","s","i","u","e","p","c","b","t","r","z","a"],R=["i","c","b","a"];return Qe=function(m,c){c=c||{},m.version==null&&(m.version=0),m.name==null&&(m.name=" "),m.media.forEach(function(h){h.payloads==null&&(h.payloads="")});var S=c.outerOrder||x,T=c.innerOrder||R,r=[];return S.forEach(function(h){g[h].forEach(function(u){u.name in m&&m[u.name]!=null?r.push(n(h,u,m)):u.push in m&&m[u.push]!=null&&m[u.push].forEach(function(E){r.push(n(h,u,E))})})}),m.media.forEach(function(h){r.push(n("m",g.m[0],h)),T.forEach(function(u){g[u].forEach(function(E){E.name in h&&h[E.name]!=null?r.push(n(u,E,h)):E.push in h&&h[E.push]!=null&&h[E.push].forEach(function(y){r.push(n(u,E,y))})})})}),r.join(`\r
`)+`\r
`},Qe}var bt;function G(){if(bt)return B;bt=1;var g=or(),b=cr(),v=We();return B.grammar=v,B.write=b,B.parse=g.parse,B.parseParams=g.parseParams,B.parseFmtpConfig=g.parseFmtpConfig,B.parsePayloads=g.parsePayloads,B.parseRemoteCandidates=g.parseRemoteCandidates,B.parseImageAttributes=g.parseImageAttributes,B.parseSimulcastStreamList=g.parseSimulcastStreamList,B}var Pe={},yt;function te(){if(yt)return Pe;yt=1,Object.defineProperty(Pe,"__esModule",{value:!0}),Pe.parse=b;const g=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function b(v){const n=g.exec(v??"");return n?{spatialLayers:Number(n[1]),temporalLayers:Number(n[2])}:{spatialLayers:1,temporalLayers:1}}return Pe}var he={},H={},St;function dr(){if(St)return H;St=1,Object.defineProperty(H,"__esModule",{value:!0}),H.OfferMediaSection=H.AnswerMediaSection=H.MediaSection=void 0;const g=G(),b=ee();let v=class{_mediaObject;constructor({iceParameters:c,iceCandidates:S,dtlsParameters:T}){if(this._mediaObject={type:"",port:0,protocol:"",payloads:"",rtp:[],fmtp:[]},c&&this.setIceParameters(c),S){this._mediaObject.candidates=[];for(const r of S){const h={foundation:r.foundation,component:1,ip:r.address??r.ip,port:r.port,priority:r.priority,transport:r.protocol,type:r.type};r.tcpType&&(h.tcptype=r.tcpType),this._mediaObject.candidates.push(h)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}T&&this.setDtlsRole(T.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(c){this._mediaObject.iceUfrag=c.usernameFragment,this._mediaObject.icePwd=c.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};H.MediaSection=v;class n extends v{constructor({iceParameters:c,iceCandidates:S,dtlsParameters:T,sctpParameters:r,plainRtpParameters:h,offerMediaObject:u,offerRtpParameters:E,answerRtpParameters:y,codecOptions:e}){switch(super({iceParameters:c,iceCandidates:S,dtlsParameters:T}),this._mediaObject.mid=String(u.mid),this._mediaObject.type=u.type,this._mediaObject.protocol=u.protocol,h?(this._mediaObject.connection={ip:h.ip,version:h.ipVersion},this._mediaObject.port=h.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),u.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const t of y.codecs){const s={payload:t.payloadType,codec:R(t),rate:t.clockRate};t.channels>1&&(s.encoding=t.channels),this._mediaObject.rtp.push(s);const o=b.clone(t.parameters)??{};let _=b.clone(t.rtcpFeedback)??[];if(e){const{opusStereo:f,opusFec:p,opusDtx:i,opusMaxPlaybackRate:d,opusMaxAverageBitrate:w,opusPtime:C,opusNack:I,videoGoogleStartBitrate:M,videoGoogleMaxBitrate:a,videoGoogleMinBitrate:D}=e,P=E.codecs.find(k=>k.payloadType===t.payloadType);switch(t.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{f!==void 0&&(P.parameters["sprop-stereo"]=f?1:0,o.stereo=f?1:0),p!==void 0&&(P.parameters.useinbandfec=p?1:0,o.useinbandfec=p?1:0),i!==void 0&&(P.parameters.usedtx=i?1:0,o.usedtx=i?1:0),d!==void 0&&(o.maxplaybackrate=d),w!==void 0&&(o.maxaveragebitrate=w),C!==void 0&&(P.parameters.ptime=C,o.ptime=C),I||(P.rtcpFeedback=P.rtcpFeedback.filter(k=>k.type!=="nack"||k.parameter),_=_.filter(k=>k.type!=="nack"||k.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":case"video/av1":{M!==void 0&&(o["x-google-start-bitrate"]=M),a!==void 0&&(o["x-google-max-bitrate"]=a),D!==void 0&&(o["x-google-min-bitrate"]=D);break}}}const l={payload:t.payloadType,config:""};for(const f of Object.keys(o))l.config&&(l.config+=";"),l.config+=`${f}=${o[f]}`;l.config&&this._mediaObject.fmtp.push(l);for(const f of _)this._mediaObject.rtcpFb.push({payload:t.payloadType,type:f.type,subtype:f.parameter})}this._mediaObject.payloads=y.codecs.map(t=>t.payloadType).join(" "),this._mediaObject.ext=[];for(const t of y.headerExtensions)(u.ext??[]).some(o=>o.uri===t.uri)&&this._mediaObject.ext.push({uri:t.uri,value:t.id});if(u.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),u.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:u.simulcast.list1},this._mediaObject.rids=[];for(const t of u.rids??[])t.direction==="send"&&this._mediaObject.rids.push({id:t.id,direction:"recv"})}else if(u.simulcast_03){this._mediaObject.simulcast_03={value:u.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const t of u.rids??[])t.direction==="send"&&this._mediaObject.rids.push({id:t.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";break}case"application":{typeof u.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):u.sctpmap&&(this._mediaObject.payloads=String(r.port),this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize});break}}}setDtlsRole(c){switch(c){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(c){if(!this._mediaObject.simulcast?.list1)return;const S={};for(const h of c)h.rid&&(S[h.rid]=h);const T=this._mediaObject.simulcast.list1,r=g.parseSimulcastStreamList(T);for(const h of r)for(const u of h)u.paused=!S[u.scid]?.active;this._mediaObject.simulcast.list1=r.map(h=>h.map(u=>`${u.paused?"~":""}${u.scid}`).join(",")).join(";")}}H.AnswerMediaSection=n;class x extends v{constructor({iceParameters:c,iceCandidates:S,dtlsParameters:T,sctpParameters:r,plainRtpParameters:h,mid:u,kind:E,offerRtpParameters:y,streamId:e,trackId:t}){switch(super({iceParameters:c,iceCandidates:S,dtlsParameters:T}),this._mediaObject.mid=String(u),this._mediaObject.type=E,h?(this._mediaObject.connection={ip:h.ip,version:h.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=h.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},r?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),this._mediaObject.extmapAllowMixed="extmap-allow-mixed",E){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._mediaObject.msid=[{id:e,appdata:t}];for(const l of y.codecs){const f={payload:l.payloadType,codec:R(l),rate:l.clockRate};l.channels>1&&(f.encoding=l.channels),this._mediaObject.rtp.push(f);const p={payload:l.payloadType,config:""};for(const i of Object.keys(l.parameters??{}))p.config&&(p.config+=";"),p.config+=`${i}=${l.parameters[i]}`;p.config&&this._mediaObject.fmtp.push(p);for(const i of l.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:l.payloadType,type:i.type,subtype:i.parameter})}this._mediaObject.payloads=y.codecs.map(l=>l.payloadType).join(" "),this._mediaObject.ext=[];for(const l of y.headerExtensions)this._mediaObject.ext.push({uri:l.uri,value:l.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const s=y.encodings[0],o=s.ssrc,_=s.rtx?.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],o&&y.rtcp.cname&&this._mediaObject.ssrcs.push({id:o,attribute:"cname",value:y.rtcp.cname}),_&&(y.rtcp.cname&&this._mediaObject.ssrcs.push({id:_,attribute:"cname",value:y.rtcp.cname}),o&&this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${o} ${_}`}));break}case"application":{this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize;break}}}setDtlsRole(c){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}}H.OfferMediaSection=x;function R(m){const S=new RegExp("^(audio|video)/(.+)","i").exec(m.mimeType);if(!S)throw new TypeError("invalid codec.mimeType");return S[2]}return H}var Ct;function Re(){if(Ct)return he;Ct=1,Object.defineProperty(he,"__esModule",{value:!0}),he.RemoteSdp=void 0;const g=G(),b=$(),v=dr(),n=["av1","h264"],x=new b.Logger("RemoteSdp");let R=class{_iceParameters;_iceCandidates;_dtlsParameters;_sctpParameters;_plainRtpParameters;_mediaSections=[];_midToIndex=new Map;_firstMid;_sdpObject;constructor({iceParameters:c,iceCandidates:S,dtlsParameters:T,sctpParameters:r,plainRtpParameters:h}){if(this._iceParameters=c,this._iceCandidates=S,this._dtlsParameters=T,this._sctpParameters=r,this._plainRtpParameters=h,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:"10000",sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},this._sdpObject.iceOptions="ice2",c?.iceLite&&(this._sdpObject.icelite="ice-lite"),T){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const u=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:T.fingerprints[u-1].algorithm,hash:T.fingerprints[u-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}h&&(this._sdpObject.origin.address=h.ip,this._sdpObject.origin.ipVer=h.ipVersion)}updateIceParameters(c){x.debug("updateIceParameters() [iceParameters:%o]",c),this._iceParameters=c,this._sdpObject.icelite=c.iceLite?"ice-lite":void 0;for(const S of this._mediaSections)S.setIceParameters(c)}updateDtlsRole(c){x.debug("updateDtlsRole() [role:%s]",c),this._dtlsParameters.role=c;for(const S of this._mediaSections)S.setDtlsRole(c)}setSessionExtmapAllowMixed(){x.debug("setSessionExtmapAllowMixed()"),this._sdpObject.extmapAllowMixed="extmap-allow-mixed"}getNextMediaSectionIdx(){for(let c=0;c<this._mediaSections.length;++c){const S=this._mediaSections[c];if(S.closed)return{idx:c,reuseMid:S.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:c,reuseMid:S,offerRtpParameters:T,answerRtpParameters:r,codecOptions:h}){const u=new v.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:c,offerRtpParameters:T,answerRtpParameters:r,codecOptions:h}),E=u.getObject();E.rtp.find(e=>n.includes(e.codec.toLowerCase()))||(E.ext=E.ext?.filter(e=>e.uri!=="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension")),S?this.replaceMediaSection(u,S):this._midToIndex.has(u.mid)?this.replaceMediaSection(u):this.addMediaSection(u)}receive({mid:c,kind:S,offerRtpParameters:T,streamId:r,trackId:h}){this.setSessionExtmapAllowMixed();const u=new v.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,mid:c,kind:S,offerRtpParameters:T,streamId:r,trackId:h}),E=this._mediaSections.find(y=>y.closed);E?this.replaceMediaSection(u,E.mid):this.addMediaSection(u)}pauseMediaSection(c){this.findMediaSection(c).pause()}resumeSendingMediaSection(c){this.findMediaSection(c).resume()}resumeReceivingMediaSection(c){this.findMediaSection(c).resume()}disableMediaSection(c){this.findMediaSection(c).disable()}closeMediaSection(c){const S=this.findMediaSection(c);return c===this._firstMid?(x.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",c),this.disableMediaSection(c),!1):(S.close(),this.regenerateBundleMids(),!0)}muxMediaSectionSimulcast(c,S){const T=this.findMediaSection(c);T.muxSimulcastStreams(S),this.replaceMediaSection(T)}sendSctpAssociation({offerMediaObject:c}){const S=new v.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:c});this.addMediaSection(S)}receiveSctpAssociation(){const c=new v.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application"});this.addMediaSection(c)}getSdp(){return this._sdpObject.origin.sessionVersion++,g.write(this._sdpObject)}addMediaSection(c){this._firstMid||(this._firstMid=c.mid),this._mediaSections.push(c),this._midToIndex.set(c.mid,this._mediaSections.length-1),this._sdpObject.media.push(c.getObject()),this.regenerateBundleMids()}replaceMediaSection(c,S){if(typeof S=="string"){const T=this._midToIndex.get(S);if(T===void 0)throw new Error(`no media section found for reuseMid '${S}'`);const r=this._mediaSections[T];this._mediaSections[T]=c,this._midToIndex.delete(r.mid),this._midToIndex.set(c.mid,T),this._sdpObject.media[T]=c.getObject(),this.regenerateBundleMids()}else{const T=this._midToIndex.get(c.mid);if(T===void 0)throw new Error(`no media section found with mid '${c.mid}'`);this._mediaSections[T]=c,this._sdpObject.media[T]=c.getObject()}}findMediaSection(c){const S=this._midToIndex.get(c);if(S===void 0)throw new Error(`no media section found with mid '${c}'`);return this._mediaSections[S]}regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(c=>!c.closed).map(c=>c.mid).join(" "))}};return he.RemoteSdp=R,he}var Q={},Rt;function Ee(){if(Rt)return Q;Rt=1,Object.defineProperty(Q,"__esModule",{value:!0}),Q.extractRtpCapabilities=b,Q.extractDtlsParameters=v,Q.getCname=n,Q.applyCodecParameters=x,Q.addHeaderExtension=R;const g=G();function b({sdpObject:m}){const c=new Map,S=new Map;for(const r of m.media){const h=r.type;switch(h){case"audio":case"video":break;default:continue}for(const u of r.rtp){const E={kind:h,mimeType:`${h}/${u.codec}`,preferredPayloadType:u.payload,clockRate:u.rate,channels:u.encoding,parameters:{},rtcpFeedback:[]};c.set(E.preferredPayloadType,E)}for(const u of r.fmtp??[]){const E=g.parseParams(u.config),y=c.get(u.payload);y&&(E?.hasOwnProperty("profile-level-id")&&(E["profile-level-id"]=String(E["profile-level-id"])),y.parameters=E)}for(const u of r.rtcpFb??[]){const E={type:u.type,parameter:u.subtype};if(E.parameter||delete E.parameter,u.payload!=="*"){const y=c.get(Number(u.payload));if(!y)continue;y.rtcpFeedback.push(E)}else for(const y of c.values())y.kind===h&&!/.+\/rtx$/i.test(y.mimeType)&&y.rtcpFeedback.push(E)}for(const u of r.ext??[]){if(u["encrypt-uri"])continue;const E={kind:h,uri:u.uri,preferredId:u.value};S.set(E.preferredId,E)}}return{codecs:Array.from(c.values()),headerExtensions:Array.from(S.values())}}function v({sdpObject:m}){let c=m.setup,S=m.fingerprint;if(!c||!S){const h=(m.media??[]).find(u=>u.port!==0);h&&(c=c??h.setup,S=S??h.fingerprint)}if(c){if(!S)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let T;switch(c){case"active":{T="client";break}case"passive":{T="server";break}case"actpass":{T="auto";break}}return{role:T,fingerprints:[{algorithm:S.type,value:S.hash}]}}function n({offerMediaObject:m}){const c=(m.ssrcs??[]).find(S=>S.attribute==="cname");return c?c.value:""}function x({offerRtpParameters:m,answerMediaObject:c}){for(const S of m.codecs){const T=S.mimeType.toLowerCase();if(T!=="audio/opus"||!(c.rtp??[]).find(E=>E.payload===S.payloadType))continue;c.fmtp=c.fmtp??[];let h=c.fmtp.find(E=>E.payload===S.payloadType);h||(h={payload:S.payloadType,config:""},c.fmtp.push(h));const u=g.parseParams(h.config);switch(T){case"audio/opus":{const E=S.parameters?.["sprop-stereo"];E!==void 0&&(u.stereo=Number(E)?1:0);break}}h.config="";for(const E of Object.keys(u))h.config&&(h.config+=";"),h.config+=`${E}=${u[E]}`}}function R({offerMediaObject:m,headerExtensionUri:c,headerExtensionId:S}){m.ext||(m.ext=[]),m.ext.push({uri:c,value:S})}return Q}var fe={},Et;function Te(){if(Et)return fe;Et=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.getRtpEncodings=g,fe.addLegacySimulcast=b;function g({offerMediaObject:v}){const n=new Set;for(const m of v.ssrcs??[]){const c=m.id;c&&n.add(c)}if(n.size===0)throw new Error("no a=ssrc lines found");const x=new Map;for(const m of v.ssrcGroups??[]){if(m.semantics!=="FID")continue;const c=m.ssrcs.split(/\s+/),S=Number(c[0]),T=Number(c[1]);n.has(S)&&(n.delete(S),n.delete(T),x.set(S,T))}for(const m of n)x.set(m,void 0);const R=[];for(const[m,c]of x){const S={ssrc:m};c&&(S.rtx={ssrc:c}),R.push(S)}return R}function b({offerMediaObject:v,numStreams:n}){if(n<=1)throw new TypeError("numStreams must be greater than 1");const x=(v.ssrcs??[]).find(E=>E.attribute==="msid");if(!x)throw new Error("a=ssrc line with msid information not found");const[R,m]=x.value.split(" "),c=Number(x.id);let S;(v.ssrcGroups??[]).some(E=>{if(E.semantics!=="FID")return!1;const y=E.ssrcs.split(/\s+/);return Number(y[0])===c?(S=Number(y[1]),!0):!1});const T=(v.ssrcs??[]).find(E=>E.attribute==="cname");if(!T)throw new Error("a=ssrc line with cname information not found");const r=T.value,h=[],u=[];for(let E=0;E<n;++E)h.push(c+E),S&&u.push(S+E);v.ssrcGroups=[],v.ssrcs=[],v.ssrcGroups.push({semantics:"SIM",ssrcs:h.join(" ")});for(const E of h)v.ssrcs.push({id:E,attribute:"cname",value:r}),v.ssrcs.push({id:E,attribute:"msid",value:`${R} ${m}`});for(let E=0;E<u.length;++E){const y=h[E],e=u[E];v.ssrcs.push({id:e,attribute:"cname",value:r}),v.ssrcs.push({id:e,attribute:"msid",value:`${R} ${m}`}),v.ssrcGroups.push({semantics:"FID",ssrcs:`${y} ${e}`})}}return fe}var X={},Tt;function xe(){if(Tt)return X;Tt=1,Object.defineProperty(X,"__esModule",{value:!0}),X.addNackSupportForOpus=g,X.addHeaderExtensionSupport=b,X.getMsidStreamIdAndTrackId=v;function g(n){for(const x of n.codecs??[])(x.mimeType.toLowerCase()==="audio/opus"||x.mimeType.toLowerCase()==="audio/multiopus")&&!x.rtcpFeedback?.some(R=>R.type==="nack"&&!R.parameter)&&(x.rtcpFeedback||(x.rtcpFeedback=[]),x.rtcpFeedback.push({type:"nack"}))}function b(n,x){if(n.headerExtensions?.some(S=>S.kind===x.kind&&S.uri===x.uri))return;n.headerExtensions||(n.headerExtensions=[]);const R=new Set(n.headerExtensions.filter(S=>S.uri!==x.uri).map(S=>S.preferredId));let m=1;for(;R.has(m);)++m;const c={kind:x.kind,uri:x.uri,preferredId:m,preferredEncrypt:!1,direction:x.direction};n.headerExtensions.push(c)}function v(n){if(!n||typeof n!="string")return{msidStreamId:void 0,msidTrackId:void 0};const[x,R]=n.trim().split(/\s+/);return x?{msidStreamId:x,msidTrackId:R}:{msidStreamId:void 0,msidTrackId:void 0}}return X}var xt;function pr(){if(xt)return ue;xt=1,Object.defineProperty(ue,"__esModule",{value:!0}),ue.Chrome111=void 0;const g=G(),b=z(),v=$(),n=V(),x=U(),R=te(),m=Re(),c=Ee(),S=Te(),T=xe(),r=new v.Logger("Chrome111"),h="Chrome111",u={OS:1024,MIS:1024};let E=class Ie extends b.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:h,factory:e=>new Ie(e),getNativeRtpCapabilities:async()=>{r.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video",{sendEncodings:[{scalabilityMode:"L3T3"}]});const t=await e.createOffer();try{e.close()}catch{}e=void 0;const s=g.parse(t.sdp);return Ie.getLocalRtpCapabilities(s)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(r.debug("getNativeSctpCapabilities()"),{numStreams:u})}}static getLocalRtpCapabilities(e,t=[]){const s=c.extractRtpCapabilities({sdpObject:e});n.validateAndNormalizeRtpCapabilities(s),T.addNackSupportForOpus(s);for(const o of t)T.addHeaderExtensionSupport(s,o);return s}constructor({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,getSendExtendedRtpCapabilities:i}){super(),r.debug("constructor()"),this._direction=e,this._remoteSdp=new m.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_}),this._getSendExtendedRtpCapabilities=i,o.role&&o.role!=="auto"&&(this._forcedLocalDtlsRole=o.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:l??[],iceTransportPolicy:f??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(r.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return h}close(){if(r.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),r.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),r.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});r.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:s,codecOptions:o,headerExtensionOptions:_,codec:l,onRtpSender:f}){if(this.assertNotClosed(),this.assertSendDirection(),r.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),s&&s.length>1){let O=1;for(const F of s){const N=F.scalabilityMode?(0,R.parse)(F.scalabilityMode).temporalLayers:3;N>O&&(O=N)}s.forEach((F,N)=>{F.rid=`r${N}`,F.scalabilityMode=`L1T${O}`})}const p=this._remoteSdp.getNextMediaSectionIdx(),i=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:s});f&&f(i.sender);let d=await this._pc.createOffer(),w=g.parse(d.sdp);w.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const C=[];C.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});const I=Ie.getLocalRtpCapabilities(w,C),M=this._getSendExtendedRtpCapabilities(I),a=n.getSendingRtpParameters(e.kind,M);a.codecs=n.reduceCodecs(a.codecs,l);const D=n.getSendingRemoteRtpParameters(e.kind,M);if(D.codecs=n.reduceCodecs(D.codecs,l),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:w}),_?.absCaptureTime){const O=w.media[p.idx];c.addHeaderExtension({offerMediaObject:O,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:D.headerExtensions.find(F=>F.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),d={type:"offer",sdp:g.write(w)}}r.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const P=i.mid;a.mid=P,w=g.parse(this._pc.localDescription.sdp);const k=w.media[p.idx];if(a.rtcp.cname=c.getCname({offerMediaObject:k}),a.msid=`${t??this._sendStream.id} ${e.id}`,!s)a.encodings=S.getRtpEncodings({offerMediaObject:k});else if(s.length===1){const O=S.getRtpEncodings({offerMediaObject:k});Object.assign(O[0],s[0]),a.encodings=O}else a.encodings=s;this._remoteSdp.send({offerMediaObject:k,reuseMid:p.reuseMid,offerRtpParameters:a,answerRtpParameters:D,codecOptions:o});const L={type:"answer",sdp:this._remoteSdp.getSdp()};return r.debug("send() | calling pc.setRemoteDescription() [answer:%o]",L),await this._pc.setRemoteDescription(L),this._mapMidTransceiver.set(P,i),{localId:P,rtpParameters:a,rtpSender:i.sender}}async stopSending(e){if(this.assertSendDirection(),r.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const o=await this._pc.createOffer();r.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const _={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();r.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();r.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?r.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):r.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{p<=t?f.active=!0:f.active=!1}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{o.encodings[p]={...f,...t}}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:o,protocol:_}){this.assertNotClosed(),this.assertSendDirection();const l={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:_};r.debug("sendDataChannel() [options:%o]",l);const f=this._pc.createDataChannel(o,l);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%u.MIS,!this._hasDataChannelMediaSection){const i=await this._pc.createOffer(),d=g.parse(i.sdp),w=d.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d}),r.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),this._remoteSdp.sendSctpAssociation({offerMediaObject:w});const C={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._hasDataChannelMediaSection=!0}const p={streamId:l.id,ordered:l.ordered,maxPacketLifeTime:l.maxPacketLifeTime,maxRetransmits:l.maxRetransmits};return{dataChannel:f,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const f of e){const{trackId:p,kind:i,rtpParameters:d,streamId:w}=f;r.debug("receive() [trackId:%s, kind:%s]",p,i);const C=d.mid??String(this._mapMidTransceiver.size);s.set(p,C);const{msidStreamId:I}=T.getMsidStreamIdAndTrackId(d.msid);this._remoteSdp.receive({mid:C,kind:i,offerRtpParameters:d,streamId:w??I??d.rtcp?.cname??"-",trackId:p})}const o={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);for(const f of e){const{trackId:p,onRtpReceiver:i}=f;if(i){const d=s.get(p),w=this._pc.getTransceivers().find(C=>C.mid===d);if(!w)throw new Error("transceiver not found");i(w.receiver)}}let _=await this._pc.createAnswer();const l=g.parse(_.sdp);for(const f of e){const{trackId:p,rtpParameters:i}=f,d=s.get(p),w=l.media.find(C=>String(C.mid)===d);c.applyCodecParameters({offerRtpParameters:i,answerMediaObject:w})}_={type:"answer",sdp:g.write(l)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l}),r.debug("receive() | calling pc.setLocalDescription() [answer:%o]",_),await this._pc.setLocalDescription(_);for(const f of e){const{trackId:p}=f,i=s.get(p),d=this._pc.getTransceivers().find(w=>w.mid===i);if(d)this._mapMidTransceiver.set(i,d),t.push({localId:i,track:d.receiver.track,rtpReceiver:d.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const o of e){r.debug("stopReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(_.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const o of e)this._mapMidTransceiver.delete(o)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("pauseReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="inactive",this._remoteSdp.pauseMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("resumeReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f}=e,p={negotiated:!0,id:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f,protocol:s};r.debug("receiveDataChannel() [options:%o]",p);const i=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const d={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",d),await this._pc.setRemoteDescription(d);const w=await this._pc.createAnswer();if(!this._transportReady){const C=g.parse(w.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C})}r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setLocalDescription(w),this._hasDataChannelMediaSection=!0}return{dataChannel:i}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=g.parse(this._pc.localDescription.sdp));const s=c.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((o,_)=>{this.safeEmit("@connect",{dtlsParameters:s},o,_)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=e=>{this.emit("@icecandidateerror",e)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new x.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return ue.Chrome111=E,ue}var me={},kt;function lr(){if(kt)return me;kt=1,Object.defineProperty(me,"__esModule",{value:!0}),me.Chrome74=void 0;const g=G(),b=$(),v=z(),n=V(),x=U(),R=te(),m=Re(),c=Ee(),S=Te(),T=xe(),r=new b.Logger("Chrome74"),h="Chrome74",u={OS:1024,MIS:1024};let E=class Me extends v.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:h,factory:e=>new Me(e),getNativeRtpCapabilities:async()=>{r.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const s=g.parse(t.sdp);return Me.getLocalRtpCapabilities(s)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(r.debug("getNativeSctpCapabilities()"),{numStreams:u})}}static getLocalRtpCapabilities(e,t=[]){const s=c.extractRtpCapabilities({sdpObject:e});n.validateAndNormalizeRtpCapabilities(s),T.addNackSupportForOpus(s);for(const o of t)T.addHeaderExtensionSupport(s,o);return s}constructor({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,getSendExtendedRtpCapabilities:i}){super(),r.debug("constructor()"),this._direction=e,this._remoteSdp=new m.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_}),this._getSendExtendedRtpCapabilities=i,o.role&&o.role!=="auto"&&(this._forcedLocalDtlsRole=o.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:l??[],iceTransportPolicy:f??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(r.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return h}close(){if(r.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),r.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),r.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});r.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:s,codecOptions:o,headerExtensionOptions:_,codec:l}){this.assertNotClosed(),this.assertSendDirection(),r.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),s&&s.length>1&&s.forEach((F,N)=>{F.rid=`r${N}`});const f=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:s});let i=await this._pc.createOffer(),d=g.parse(i.sdp);d.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const w=[];w.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});const C=Me.getLocalRtpCapabilities(d,w),I=this._getSendExtendedRtpCapabilities(C),M=n.getSendingRtpParameters(e.kind,I);M.codecs=n.reduceCodecs(M.codecs,l);const a=n.getSendingRemoteRtpParameters(e.kind,I);a.codecs=n.reduceCodecs(a.codecs,l),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d});let D=!1;const P=(0,R.parse)((s??[{}])[0].scalabilityMode);let k;s?.length===1&&P.spatialLayers>1&&M.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(r.debug("send() | enabling legacy simulcast for VP9 SVC"),D=!0,d=g.parse(i.sdp),k=d.media[f.idx],S.addLegacySimulcast({offerMediaObject:k,numStreams:P.spatialLayers}),i={type:"offer",sdp:g.write(d)}),r.debug("send() | calling pc.setLocalDescription() [offer:%o]",i),_?.absCaptureTime&&(k=d.media[f.idx],c.addHeaderExtension({offerMediaObject:k,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:a.headerExtensions.find(F=>F.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),i={type:"offer",sdp:g.write(d)}),await this._pc.setLocalDescription(i);const L=p.mid;if(M.mid=L,d=g.parse(this._pc.localDescription.sdp),k=d.media[f.idx],M.rtcp.cname=c.getCname({offerMediaObject:k}),M.msid=`${t??this._sendStream.id} ${e.id}`,!s)M.encodings=S.getRtpEncodings({offerMediaObject:k});else if(s.length===1){let F=S.getRtpEncodings({offerMediaObject:k});Object.assign(F[0],s[0]),D&&(F=[F[0]]),M.encodings=F}else M.encodings=s;if(M.encodings.length>1&&(M.codecs[0].mimeType.toLowerCase()==="video/vp8"||M.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const F of M.encodings)F.scalabilityMode?F.scalabilityMode=`L1T${P.temporalLayers}`:F.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:k,reuseMid:f.reuseMid,offerRtpParameters:M,answerRtpParameters:a,codecOptions:o});const O={type:"answer",sdp:this._remoteSdp.getSdp()};return r.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,p),{localId:L,rtpParameters:M,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),r.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const o=await this._pc.createOffer();r.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const _={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();r.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();r.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?r.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):r.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{p<=t?f.active=!0:f.active=!1}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{o.encodings[p]={...f,...t}}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:o,protocol:_}){this.assertNotClosed(),this.assertSendDirection();const l={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:_};r.debug("sendDataChannel() [options:%o]",l);const f=this._pc.createDataChannel(o,l);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%u.MIS,!this._hasDataChannelMediaSection){const i=await this._pc.createOffer(),d=g.parse(i.sdp),w=d.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d}),r.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),this._remoteSdp.sendSctpAssociation({offerMediaObject:w});const C={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._hasDataChannelMediaSection=!0}const p={streamId:l.id,ordered:l.ordered,maxPacketLifeTime:l.maxPacketLifeTime,maxRetransmits:l.maxRetransmits};return{dataChannel:f,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const f of e){const{trackId:p,kind:i,rtpParameters:d,streamId:w}=f;r.debug("receive() [trackId:%s, kind:%s]",p,i);const C=d.mid??String(this._mapMidTransceiver.size);s.set(p,C);const{msidStreamId:I}=T.getMsidStreamIdAndTrackId(d.msid);this._remoteSdp.receive({mid:C,kind:i,offerRtpParameters:d,streamId:w??I??d.rtcp?.cname??"-",trackId:p})}const o={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);let _=await this._pc.createAnswer();const l=g.parse(_.sdp);for(const f of e){const{trackId:p,rtpParameters:i}=f,d=s.get(p),w=l.media.find(C=>String(C.mid)===d);c.applyCodecParameters({offerRtpParameters:i,answerMediaObject:w})}_={type:"answer",sdp:g.write(l)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l}),r.debug("receive() | calling pc.setLocalDescription() [answer:%o]",_),await this._pc.setLocalDescription(_);for(const f of e){const{trackId:p}=f,i=s.get(p),d=this._pc.getTransceivers().find(w=>w.mid===i);if(d)this._mapMidTransceiver.set(i,d),t.push({localId:i,track:d.receiver.track,rtpReceiver:d.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const o of e){r.debug("stopReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(_.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const o of e)this._mapMidTransceiver.delete(o)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("pauseReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="inactive",this._remoteSdp.pauseMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("resumeReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f}=e,p={negotiated:!0,id:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f,protocol:s};r.debug("receiveDataChannel() [options:%o]",p);const i=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const d={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",d),await this._pc.setRemoteDescription(d);const w=await this._pc.createAnswer();if(!this._transportReady){const C=g.parse(w.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C})}r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setLocalDescription(w),this._hasDataChannelMediaSection=!0}return{dataChannel:i}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=g.parse(this._pc.localDescription.sdp));const s=c.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((o,_)=>{this.safeEmit("@connect",{dtlsParameters:s},o,_)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=e=>{this.emit("@icecandidateerror",e)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new x.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return me.Chrome74=E,me}var ge={},Dt;function ur(){if(Dt)return ge;Dt=1,Object.defineProperty(ge,"__esModule",{value:!0}),ge.Firefox120=void 0;const g=G(),b=z(),v=$(),n=U(),x=V(),R=te(),m=Re(),c=Ee(),S=Te(),T=xe(),r=new v.Logger("Firefox120"),h="Firefox120",u={OS:16,MIS:2048};let E=class Oe extends b.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:h,factory:e=>new Oe(e),getNativeRtpCapabilities:async()=>{r.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});const t=document.createElement("canvas");t.getContext("2d");const o=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(o,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const _=await e.createOffer();try{t.remove()}catch{}try{o.stop()}catch{}try{e.close()}catch{}e=void 0;const l=g.parse(_.sdp);return Oe.getLocalRtpCapabilities(l)}catch(_){try{t.remove()}catch{}try{o.stop()}catch{}try{e?.close()}catch{}throw e=void 0,_}},getNativeSctpCapabilities:async()=>(r.debug("getNativeSctpCapabilities()"),{numStreams:u})}}static getLocalRtpCapabilities(e){const t=c.extractRtpCapabilities({sdpObject:e});return x.validateAndNormalizeRtpCapabilities(t),t}constructor({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,getSendExtendedRtpCapabilities:i}){super(),r.debug("constructor()"),this._direction=e,this._remoteSdp=new m.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_}),this._getSendExtendedRtpCapabilities=i,this._pc=new RTCPeerConnection({iceServers:l??[],iceTransportPolicy:f??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(r.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return h}close(){if(r.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){throw this.assertNotClosed(),new n.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),r.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});r.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:s,codecOptions:o,codec:_,onRtpSender:l}){this.assertNotClosed(),this.assertSendDirection(),r.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),s&&s.length>1&&s.forEach((k,L)=>{k.rid=`r${L}`});const f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:s});l&&l(f.sender);const p=await this._pc.createOffer();let i=g.parse(p.sdp);i.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const d=Oe.getLocalRtpCapabilities(i),w=this._getSendExtendedRtpCapabilities(d),C=x.getSendingRtpParameters(e.kind,w);C.codecs=x.reduceCodecs(C.codecs,_);const I=x.getSendingRemoteRtpParameters(e.kind,w);I.codecs=x.reduceCodecs(I.codecs,_),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:i});const M=(0,R.parse)((s??[{}])[0].scalabilityMode);r.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const a=f.mid;C.mid=a,i=g.parse(this._pc.localDescription.sdp);const D=i.media[i.media.length-1];if(C.rtcp.cname=c.getCname({offerMediaObject:D}),C.msid=`${t??this._sendStream.id} ${e.id}`,!s)C.encodings=S.getRtpEncodings({offerMediaObject:D});else if(s.length===1){const k=S.getRtpEncodings({offerMediaObject:D});Object.assign(k[0],s[0]),C.encodings=k}else C.encodings=s;if(C.encodings.length>1&&(C.codecs[0].mimeType.toLowerCase()==="video/vp8"||C.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const k of C.encodings)k.scalabilityMode?k.scalabilityMode=`L1T${M.temporalLayers}`:k.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:D,offerRtpParameters:C,answerRtpParameters:I,codecOptions:o});const P={type:"answer",sdp:this._remoteSdp.getSdp()};return r.debug("send() | calling pc.setRemoteDescription() [answer:%o]",P),await this._pc.setRemoteDescription(P),this._mapMidTransceiver.set(a,f),{localId:a,rtpParameters:C,rtpSender:f.sender}}async stopSending(e){if(this.assertSendDirection(),r.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const s=await this._pc.createOffer();r.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();r.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();r.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?r.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):r.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated transceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{p<=t?f.active=!0:f.active=!1}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{o.encodings[p]={...f,...t}}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:o,protocol:_}){this.assertNotClosed(),this.assertSendDirection();const l={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:_};r.debug("sendDataChannel() [options:%o]",l);const f=this._pc.createDataChannel(o,l);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%u.MIS,!this._hasDataChannelMediaSection){const i=await this._pc.createOffer(),d=g.parse(i.sdp),w=d.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:d}),r.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),this._remoteSdp.sendSctpAssociation({offerMediaObject:w});const C={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._hasDataChannelMediaSection=!0}const p={streamId:l.id,ordered:l.ordered,maxPacketLifeTime:l.maxPacketLifeTime,maxRetransmits:l.maxRetransmits};return{dataChannel:f,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const f of e){const{trackId:p,kind:i,rtpParameters:d,streamId:w}=f;r.debug("receive() [trackId:%s, kind:%s]",p,i);const C=d.mid??String(this._mapMidTransceiver.size);s.set(p,C);const{msidStreamId:I}=T.getMsidStreamIdAndTrackId(d.msid);this._remoteSdp.receive({mid:C,kind:i,offerRtpParameters:d,streamId:w??I??d.rtcp?.cname??"-",trackId:p})}const o={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);for(const f of e){const{trackId:p,onRtpReceiver:i}=f;if(i){const d=s.get(p),w=this._pc.getTransceivers().find(C=>C.mid===d);if(!w)throw new Error("transceiver not found");i(w.receiver)}}let _=await this._pc.createAnswer();const l=g.parse(_.sdp);for(const f of e){const{trackId:p,rtpParameters:i}=f,d=s.get(p),w=l.media.find(C=>String(C.mid)===d);c.applyCodecParameters({offerRtpParameters:i,answerMediaObject:w}),_={type:"answer",sdp:g.write(l)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:l}),r.debug("receive() | calling pc.setLocalDescription() [answer:%o]",_),await this._pc.setLocalDescription(_);for(const f of e){const{trackId:p}=f,i=s.get(p),d=this._pc.getTransceivers().find(w=>w.mid===i);if(!d)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(i,d),t.push({localId:i,track:d.receiver.track,rtpReceiver:d.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const o of e){r.debug("stopReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(_.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const o of e)this._mapMidTransceiver.delete(o)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("pauseReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="inactive",this._remoteSdp.pauseMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("resumeReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f}=e,p={negotiated:!0,id:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f,protocol:s};r.debug("receiveDataChannel() [options:%o]",p);const i=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const d={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",d),await this._pc.setRemoteDescription(d);const w=await this._pc.createAnswer();if(!this._transportReady){const C=g.parse(w.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:C})}r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setLocalDescription(w),this._hasDataChannelMediaSection=!0}return{dataChannel:i}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=g.parse(this._pc.localDescription.sdp));const s=c.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((o,_)=>{this.safeEmit("@connect",{dtlsParameters:s},o,_)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=e=>{this.emit("@icecandidateerror",e)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new n.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return ge.Firefox120=E,ge}var _e={},Pt;function hr(){if(Pt)return _e;Pt=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.Safari12=void 0;const g=G(),b=z(),v=$(),n=V(),x=U(),R=te(),m=Re(),c=Ee(),S=Te(),T=xe(),r=new v.Logger("Safari12"),h="Safari12",u={OS:1024,MIS:1024};let E=class Fe extends b.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:h,factory:e=>new Fe(e),getNativeRtpCapabilities:async()=>{r.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const s=g.parse(t.sdp);return Fe.getLocalRtpCapabilities(s)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(r.debug("getNativeSctpCapabilities()"),{numStreams:u})}}static getLocalRtpCapabilities(e,t=[]){const s=c.extractRtpCapabilities({sdpObject:e});n.validateAndNormalizeRtpCapabilities(s),T.addNackSupportForOpus(s);for(const o of t)T.addHeaderExtensionSupport(s,o);return s}constructor({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,getSendExtendedRtpCapabilities:i}){super(),r.debug("constructor()"),this._direction=e,this._remoteSdp=new m.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_}),this._getSendExtendedRtpCapabilities=i,o.role&&o.role!=="auto"&&(this._forcedLocalDtlsRole=o.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:l??[],iceTransportPolicy:f??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p}),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",d=>{this.emit("@icecandidateerror",d)}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(r.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return h}close(){if(r.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),r.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),r.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});r.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:s,codecOptions:o,headerExtensionOptions:_,codec:l,onRtpSender:f}){this.assertNotClosed(),this.assertSendDirection(),r.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t);const p=this._remoteSdp.getNextMediaSectionIdx(),i=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});f&&f(i.sender);let d=await this._pc.createOffer(),w=g.parse(d.sdp);w.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const C=[];C.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});const I=Fe.getLocalRtpCapabilities(w,C),M=this._getSendExtendedRtpCapabilities(I),a=n.getSendingRtpParameters(e.kind,M);a.codecs=n.reduceCodecs(a.codecs,l);const D=n.getSendingRemoteRtpParameters(e.kind,M);D.codecs=n.reduceCodecs(D.codecs,l);let P;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:w});const k=(0,R.parse)((s??[{}])[0].scalabilityMode);s&&s.length>1&&(r.debug("send() | enabling legacy simulcast"),w=g.parse(d.sdp),P=w.media[p.idx],S.addLegacySimulcast({offerMediaObject:P,numStreams:s.length}),d={type:"offer",sdp:g.write(w)}),_?.absCaptureTime&&(P=w.media[p.idx],c.addHeaderExtension({offerMediaObject:P,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:D.headerExtensions.find(F=>F.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),d={type:"offer",sdp:g.write(w)}),r.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const L=i.mid;if(a.mid=L,w=g.parse(this._pc.localDescription.sdp),P=w.media[p.idx],a.rtcp.cname=c.getCname({offerMediaObject:P}),a.msid=`${t??this._sendStream.id} ${e.id}`,a.encodings=S.getRtpEncodings({offerMediaObject:P}),s)for(let F=0;F<a.encodings.length;++F)s[F]&&Object.assign(a.encodings[F],s[F]);if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const F of a.encodings)F.scalabilityMode?F.scalabilityMode=`L1T${k.temporalLayers}`:F.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:P,reuseMid:p.reuseMid,offerRtpParameters:a,answerRtpParameters:D,codecOptions:o});const O={type:"answer",sdp:this._remoteSdp.getSdp()};return r.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,i),{localId:L,rtpParameters:a,rtpSender:i.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;r.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const o=await this._pc.createOffer();r.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const _={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();r.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();r.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?r.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):r.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{p<=t?f.active=!0:f.active=!1}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{o.encodings[p]={...f,...t}}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:o,protocol:_}){this.assertNotClosed(),this.assertSendDirection();const l={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:_};r.debug("sendDataChannel() [options:%o]",l);const f=this._pc.createDataChannel(o,l);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%u.MIS,!this._hasDataChannelMediaSection){const i=await this._pc.createOffer(),d=g.parse(i.sdp),w=d.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d}),r.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),this._remoteSdp.sendSctpAssociation({offerMediaObject:w});const C={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._hasDataChannelMediaSection=!0}const p={streamId:l.id,ordered:l.ordered,maxPacketLifeTime:l.maxPacketLifeTime,maxRetransmits:l.maxRetransmits};return{dataChannel:f,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const f of e){const{trackId:p,kind:i,rtpParameters:d,streamId:w}=f;r.debug("receive() [trackId:%s, kind:%s]",p,i);const C=d.mid??String(this._mapMidTransceiver.size);s.set(p,C);const{msidStreamId:I}=T.getMsidStreamIdAndTrackId(d.msid);this._remoteSdp.receive({mid:C,kind:i,offerRtpParameters:d,streamId:w??I??d.rtcp?.cname??"-",trackId:p})}const o={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);for(const f of e){const{trackId:p,onRtpReceiver:i}=f;if(i){const d=s.get(p),w=this._pc.getTransceivers().find(C=>C.mid===d);if(!w)throw new Error("transceiver not found");i(w.receiver)}}let _=await this._pc.createAnswer();const l=g.parse(_.sdp);for(const f of e){const{trackId:p,rtpParameters:i}=f,d=s.get(p),w=l.media.find(C=>String(C.mid)===d);c.applyCodecParameters({offerRtpParameters:i,answerMediaObject:w})}_={type:"answer",sdp:g.write(l)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l}),r.debug("receive() | calling pc.setLocalDescription() [answer:%o]",_),await this._pc.setLocalDescription(_);for(const f of e){const{trackId:p}=f,i=s.get(p),d=this._pc.getTransceivers().find(w=>w.mid===i);if(!d)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(i,d),t.push({localId:i,track:d.receiver.track,rtpReceiver:d.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const o of e){r.debug("stopReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(_.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const o of e)this._mapMidTransceiver.delete(o)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("pauseReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="inactive",this._remoteSdp.pauseMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("resumeReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f}=e,p={negotiated:!0,id:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f,protocol:s};r.debug("receiveDataChannel() [options:%o]",p);const i=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const d={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",d),await this._pc.setRemoteDescription(d);const w=await this._pc.createAnswer();if(!this._transportReady){const C=g.parse(w.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C})}r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setLocalDescription(w),this._hasDataChannelMediaSection=!0}return{dataChannel:i}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=g.parse(this._pc.localDescription.sdp));const s=c.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((o,_)=>{this.safeEmit("@connect",{dtlsParameters:s},o,_)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=e=>{this.emit("@icecandidateerror",e)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new x.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return _e.Safari12=E,_e}var ve={},Lt;function fr(){if(Lt)return ve;Lt=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.ReactNative106=void 0;const g=G(),b=z(),v=$(),n=V(),x=U(),R=te(),m=Re(),c=Ee(),S=Te(),T=xe(),r=new v.Logger("ReactNative106"),h="ReactNative106",u={OS:1024,MIS:1024};let E=class Ne extends b.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:h,factory:e=>new Ne(e),getNativeRtpCapabilities:async()=>{r.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const s=g.parse(t.sdp);return Ne.getLocalRtpCapabilities(s)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(r.debug("getNativeSctpCapabilities()"),{numStreams:u})}}static getLocalRtpCapabilities(e,t=[]){const s=c.extractRtpCapabilities({sdpObject:e});n.validateAndNormalizeRtpCapabilities(s),T.addNackSupportForOpus(s);for(const o of t)T.addHeaderExtensionSupport(s,o);return s}constructor({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_,iceServers:l,iceTransportPolicy:f,additionalSettings:p,getSendExtendedRtpCapabilities:i}){super(),r.debug("constructor()"),this._direction=e,this._remoteSdp=new m.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:o,sctpParameters:_}),this._getSendExtendedRtpCapabilities=i,o.role&&o.role!=="auto"&&(this._forcedLocalDtlsRole=o.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:l??[],iceTransportPolicy:f??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(r.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return h}close(){if(r.debug("close()"),!this._closed){this._closed=!0,this._sendStream.release(!1);try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),r.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),r.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});r.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:s,codecOptions:o,headerExtensionOptions:_,codec:l,onRtpSender:f}){this.assertNotClosed(),this.assertSendDirection(),r.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),s&&s.length>1&&s.forEach((N,Y)=>{N.rid=`r${Y}`});const p=this._remoteSdp.getNextMediaSectionIdx(),i=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:s});f&&f(i.sender);let d=await this._pc.createOffer(),w=g.parse(d.sdp);w.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const C=[];C.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});const I=Ne.getLocalRtpCapabilities(w,C),M=this._getSendExtendedRtpCapabilities(I),a=n.getSendingRtpParameters(e.kind,M);a.codecs=n.reduceCodecs(a.codecs,l);const D=n.getSendingRemoteRtpParameters(e.kind,M);D.codecs=n.reduceCodecs(D.codecs,l),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:w});let P=!1;const k=(0,R.parse)((s??[{}])[0].scalabilityMode);let L;s?.length===1&&k.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(r.debug("send() | enabling legacy simulcast for VP9 SVC"),P=!0,w=g.parse(d.sdp),L=w.media[p.idx],S.addLegacySimulcast({offerMediaObject:L,numStreams:k.spatialLayers}),d={type:"offer",sdp:g.write(w)}),_?.absCaptureTime&&(L=w.media[p.idx],c.addHeaderExtension({offerMediaObject:L,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:D.headerExtensions.find(N=>N.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),d={type:"offer",sdp:g.write(w)}),r.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);let O=i.mid??void 0;if(O||r.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),a.mid=O,w=g.parse(this._pc.localDescription.sdp),L=w.media[p.idx],a.rtcp.cname=c.getCname({offerMediaObject:L}),a.msid=`${t??this._sendStream.id} ${e.id}`,!s)a.encodings=S.getRtpEncodings({offerMediaObject:L});else if(s.length===1){let N=S.getRtpEncodings({offerMediaObject:L});Object.assign(N[0],s[0]),P&&(N=[N[0]]),a.encodings=N}else a.encodings=s;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const N of a.encodings)N.scalabilityMode?N.scalabilityMode=`L1T${k.temporalLayers}`:N.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:L,reuseMid:p.reuseMid,offerRtpParameters:a,answerRtpParameters:D,codecOptions:o});const F={type:"answer",sdp:this._remoteSdp.getSdp()};return r.debug("send() | calling pc.setRemoteDescription() [answer:%o]",F),await this._pc.setRemoteDescription(F),O||(O=i.mid,a.mid=O),this._mapMidTransceiver.set(O,i),{localId:O,rtpParameters:a,rtpSender:i.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;r.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const o=await this._pc.createOffer();r.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const _={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();r.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),r.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();r.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const o={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?r.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):r.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{p<=t?f.active=!0:f.active=!1}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),r.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const o=s.sender.getParameters();o.encodings.forEach((f,p)=>{o.encodings[p]={...f,...t}}),await s.sender.setParameters(o),this._remoteSdp.muxMediaSectionSimulcast(e,o.encodings);const _=await this._pc.createOffer();r.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const l={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:o,protocol:_}){this.assertNotClosed(),this.assertSendDirection();const l={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:_};r.debug("sendDataChannel() [options:%o]",l);const f=this._pc.createDataChannel(o,l);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%u.MIS,!this._hasDataChannelMediaSection){const i=await this._pc.createOffer(),d=g.parse(i.sdp),w=d.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d}),r.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),this._remoteSdp.sendSctpAssociation({offerMediaObject:w});const C={type:"answer",sdp:this._remoteSdp.getSdp()};r.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._hasDataChannelMediaSection=!0}const p={streamId:l.id,ordered:l.ordered,maxPacketLifeTime:l.maxPacketLifeTime,maxRetransmits:l.maxRetransmits};return{dataChannel:f,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const f of e){const{trackId:p,kind:i,rtpParameters:d,streamId:w}=f;r.debug("receive() [trackId:%s, kind:%s]",p,i);const C=d.mid??String(this._mapMidTransceiver.size);s.set(p,C);const{msidStreamId:I}=T.getMsidStreamIdAndTrackId(d.msid);this._remoteSdp.receive({mid:C,kind:i,offerRtpParameters:d,streamId:w??I??d.rtcp?.cname??"-",trackId:p})}const o={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);for(const f of e){const{trackId:p,onRtpReceiver:i}=f;if(i){const d=s.get(p),w=this._pc.getTransceivers().find(C=>C.mid===d);if(!w)throw new Error("transceiver not found");i(w.receiver)}}let _=await this._pc.createAnswer();const l=g.parse(_.sdp);for(const f of e){const{trackId:p,rtpParameters:i}=f,d=s.get(p),w=l.media.find(C=>String(C.mid)===d);c.applyCodecParameters({offerRtpParameters:i,answerMediaObject:w})}_={type:"answer",sdp:g.write(l)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l}),r.debug("receive() | calling pc.setLocalDescription() [answer:%o]",_),await this._pc.setLocalDescription(_);for(const f of e){const{trackId:p}=f,i=s.get(p),d=this._pc.getTransceivers().find(w=>w.mid===i);if(d)this._mapMidTransceiver.set(i,d),t.push({localId:i,track:d.receiver.track,rtpReceiver:d.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const o of e){r.debug("stopReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(_.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const o of e)this._mapMidTransceiver.delete(o)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("pauseReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="inactive",this._remoteSdp.pauseMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const o of e){r.debug("resumeReceiving() [localId:%s]",o);const _=this._mapMidTransceiver.get(o);if(!_)throw new Error("associated RTCRtpTransceiver not found");_.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(o)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();r.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f}=e,p={negotiated:!0,id:o,ordered:_,maxPacketLifeTime:l,maxRetransmits:f,protocol:s};r.debug("receiveDataChannel() [options:%o]",p);const i=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const d={type:"offer",sdp:this._remoteSdp.getSdp()};r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",d),await this._pc.setRemoteDescription(d);const w=await this._pc.createAnswer();if(!this._transportReady){const C=g.parse(w.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C})}r.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setLocalDescription(w),this._hasDataChannelMediaSection=!0}return{dataChannel:i}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=g.parse(this._pc.localDescription.sdp));const s=c.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((o,_)=>{this.safeEmit("@connect",{dtlsParameters:s},o,_)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=e=>{this.emit("@icecandidateerror",e)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new x.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return ve.ReactNative106=E,ve}var It;function mr(){if(It)return K;It=1,Object.defineProperty(K,"__esModule",{value:!0}),K.Device=void 0,K.detectDevice=u,K.detectDeviceAsync=E;const g=$(),b=z(),v=U(),n=ee(),x=V(),R=ar(),m=pr(),c=lr(),S=ur(),T=hr(),r=fr(),h=new g.Logger("Device");function u(p,i){return h.debug("detectDevice()"),!p&&typeof navigator=="object"&&(p=navigator.userAgent),!i&&typeof navigator=="object"&&(i=navigator.userAgentData),e(p,i)}async function E(p,i){return h.debug("detectDeviceAsync()"),!p&&typeof navigator=="object"&&(p=navigator.userAgent),!i&&typeof navigator=="object"&&(i=navigator.userAgentData),e(p,i)}let y=class Ut{_handlerFactory;_handlerName;_loaded=!1;_getSendExtendedRtpCapabilities;_recvRtpCapabilities;_canProduceByKind={audio:!1,video:!1};_sctpCapabilities;_observer=new b.EnhancedEventEmitter;static async factory({handlerName:i,handlerFactory:d}={}){if(h.debug("factory()"),i&&d)throw new TypeError("just one of handlerName or handlerInterface can be given");if(!i&&!d&&(i=await E(),!i))throw new v.UnsupportedError("device not supported");return new Ut({handlerName:i,handlerFactory:d})}constructor({handlerName:i,handlerFactory:d}={}){if(h.debug("constructor()"),i&&d)throw new TypeError("just one of handlerName or handlerInterface can be given");if(d)this._handlerFactory=d;else{if(i)h.debug("constructor() | handler given: %s",i);else if(i=u(),i)h.debug("constructor() | detected handler: %s",i);else throw new v.UnsupportedError("device not supported");switch(i){case"Chrome111":{this._handlerFactory=m.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=c.Chrome74.createFactory();break}case"Firefox120":{this._handlerFactory=S.Firefox120.createFactory();break}case"Safari12":{this._handlerFactory=T.Safari12.createFactory();break}case"ReactNative106":{this._handlerFactory=r.ReactNative106.createFactory();break}default:throw new TypeError(`unknown handlerName "${i}"`)}}this._handlerName=this._handlerFactory.name}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new v.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new v.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:i,preferLocalCodecsOrder:d=!1}){if(h.debug("load() [routerRtpCapabilities:%o]",i),this._loaded)throw new v.InvalidStateError("already loaded");const w=n.clone(i);x.validateAndNormalizeRtpCapabilities(w);const{getNativeRtpCapabilities:C,getNativeSctpCapabilities:I}=this._handlerFactory,M=n.clone(await C());x.validateAndNormalizeRtpCapabilities(M),h.debug("load() | got native RTP capabilities:%o",M),this._getSendExtendedRtpCapabilities=D=>n.clone(x.getExtendedRtpCapabilities(D,w,d));const a=x.getExtendedRtpCapabilities(M,w,!1);this._recvRtpCapabilities=x.getRecvRtpCapabilities(a),x.validateAndNormalizeRtpCapabilities(this._recvRtpCapabilities),h.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._canProduceByKind.audio=x.canSend("audio",this._recvRtpCapabilities),this._canProduceByKind.video=x.canSend("video",this._recvRtpCapabilities),this._sctpCapabilities=await I(),x.validateSctpCapabilities(this._sctpCapabilities),h.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),h.debug("load() succeeded"),this._loaded=!0}canProduce(i){if(this._loaded){if(i!=="audio"&&i!=="video")throw new TypeError(`invalid kind "${i}"`)}else throw new v.InvalidStateError("not loaded");return this._canProduceByKind[i]}createSendTransport({id:i,iceParameters:d,iceCandidates:w,dtlsParameters:C,sctpParameters:I,iceServers:M,iceTransportPolicy:a,additionalSettings:D,appData:P}){return h.debug("createSendTransport()"),this.createTransport({direction:"send",id:i,iceParameters:d,iceCandidates:w,dtlsParameters:C,sctpParameters:I,iceServers:M,iceTransportPolicy:a,additionalSettings:D,appData:P})}createRecvTransport({id:i,iceParameters:d,iceCandidates:w,dtlsParameters:C,sctpParameters:I,iceServers:M,iceTransportPolicy:a,additionalSettings:D,appData:P}){return h.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:i,iceParameters:d,iceCandidates:w,dtlsParameters:C,sctpParameters:I,iceServers:M,iceTransportPolicy:a,additionalSettings:D,appData:P})}createTransport({direction:i,id:d,iceParameters:w,iceCandidates:C,dtlsParameters:I,sctpParameters:M,iceServers:a,iceTransportPolicy:D,additionalSettings:P,appData:k}){if(this._loaded){if(typeof d!="string")throw new TypeError("missing id");if(typeof w!="object")throw new TypeError("missing iceParameters");if(Array.isArray(C)){if(typeof I!="object")throw new TypeError("missing dtlsParameters");if(M&&typeof M!="object")throw new TypeError("wrong sctpParameters");if(k&&typeof k!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new v.InvalidStateError("not loaded");const L=new R.Transport({direction:i,id:d,iceParameters:w,iceCandidates:C,dtlsParameters:I,sctpParameters:M,iceServers:a,iceTransportPolicy:D,additionalSettings:P,appData:k,handlerFactory:this._handlerFactory,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities,recvRtpCapabilities:this._recvRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",L),L}};K.Device=y;function e(p,i){h.debug('detectDeviceImpl() [userAgent:"%s", userAgentData:%o]',p,i);const d=t(p,i);if(d){if(d>=111)return h.debug("detectDeviceImpl() | using Chrome111 handler"),"Chrome111";if(d>=74)return h.debug("detectDeviceImpl() | using Chrome74 handler"),"Chrome74";h.warn("detectDeviceImpl() | unsupported Chromium based browser/version");return}const w=s(p);if(w){if(w>=120)return h.debug("detectDeviceImpl() | using Firefox120 handler"),"Firefox120";h.warn("detectDeviceImpl() | unsupported Firefox browser/version");return}const C=o(p);if(C){if(C>=605)return h.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";h.warn("detectDeviceImpl() | unsupported desktop Safari browser/version");return}const I=_(p);if(I){if(I>=605)return h.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";h.warn("detectDeviceImpl() | unsupported iOS Safari based browser/version");return}if(f()){if(typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u")return h.debug("detectDeviceImpl() | using ReactNative106 handler"),"ReactNative106";h.warn("detectDeviceImpl() | unsupported react-native-webrtc version without RTCPeerConnection or RTCRtpTransceiver, forgot to call registerGlobals() on it?");return}h.warn('detectDeviceImpl() | device not supported [userAgent:"%s", userAgentData:%o]',p,i)}function t(p,i){if(h.debug("getChromiumMajorVersion()"),l(p,i)){h.debug("getChromiumMajorVersion() | this is iOS => undefined");return}if(f()){h.debug("getChromiumMajorVersion() | this is React-Native => undefined");return}if(i){const w=(i.brands??[]).find(C=>C.brand==="Chromium");if(w){const C=Number(w.version);return h.debug(`getChromiumMajorVersion() | Chromium major version based on NavigatorUAData => ${C}`),C}}const d=p?.match(/\b(?:Chrome|Chromium)\/(\w+)/i);if(d?.[1]){const w=Number(d[1]);return h.debug(`getChromiumMajorVersion() | Chromium major version based on User-Agent => ${w}`),w}h.debug("getChromiumMajorVersion() | this is not Chromium => undefined")}function s(p){if(h.debug("getFirefoxMajorVersion()"),l(p)){h.debug("getFirefoxMajorVersion() | this is iOS => undefined");return}if(f()){h.debug("getFirefoxMajorVersion() | this is React-Native => undefined");return}const i=p?.match(/\bFirefox\/(\w+)/i);if(i?.[1]){const d=Number(i[1]);return h.debug(`getFirefoxMajorVersion() | Firefox major version based on User-Agent => ${d}`),d}h.debug("getFirefoxMajorVersion() | this is not Firefox => undefined")}function o(p){if(h.debug("getMacOSWebKitMajorVersion()"),l(p)){h.debug("getMacOSWebKitMajorVersion() | this is iOS => undefined");return}if(f()){h.debug("getMacOSWebKitMajorVersion() | this is React-Native => undefined");return}if(!(p&&/\bSafari\b/i.test(p)&&!/\bChrome\b/i.test(p)&&!/\bChromium\b/i.test(p)&&!/\bFirefox\b/i.test(p))){h.debug("getMacOSWebKitMajorVersion() | this is not Safari => undefined");return}const d=p.match(/AppleWebKit\/(\w+)/i);if(d?.[1]){const w=Number(d[1]);return h.debug(`getMacOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${w}`),w}h.debug("getMacOSWebKitMajorVersion() | this is not WebKit => undefined")}function _(p){if(h.debug("getIOSWebKitMajorVersion()"),!l(p)){h.debug("getIOSWebKitMajorVersion() | this is not iOS => undefined");return}if(f()){h.debug("getIOSWebKitMajorVersion() | this is React-Native => undefined");return}const i=p?.match(/AppleWebKit\/(\w+)/i);if(i?.[1]){const d=Number(i[1]);return h.debug(`getIOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${d}`),d}h.debug("getIOSWebKitMajorVersion() | this is not WebKit => undefined")}function l(p,i){return h.debug("isIOS()"),i?.platform==="iOS"?(h.debug("isIOS() | this is iOS based on NavigatorUAData.platform => true"),!0):i?.platform?(h.debug("isIOS() | this is not iOS based on NavigatorUAData.platform => false"),!1):p&&/iPad|iPhone|iPod/.test(p)?(h.debug("isIOS() | this is iOS based on User-Agent => true"),!0):typeof navigator=="object"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1?(h.debug("isIOS() | this is iPadOS 13+ based on User-Agent => true"),!0):(h.debug("isIOS() | this is not iOS => false"),!1)}function f(){return h.debug("isReactNative()"),typeof navigator=="object"&&navigator.product==="ReactNative"?(h.debug("isReactNative() | this is React-Native based on navigator.product"),!0):(h.debug("isReactNative() | this is not React-Native => false"),!1)}return K}var we={},be={},Ge={},Mt;function gr(){if(Mt)return Ge;Mt=1;for(var g=256,b=[],v;g--;)b[g]=(g+256).toString(16).substring(1);function n(){var x=0,R,m="";if(!v||g+16>256){for(v=Array(x=256);x--;)v[x]=256*Math.random()|0;x=g=0}for(;x<16;x++)R=v[g+x],x==6?m+=b[R&15|64]:x==8?m+=b[R&63|128]:m+=b[R],x&1&&x>1&&x<11&&(m+="-");return g++,m}return Ge.v4=n,Ge}var ye={},Ot;function _r(){if(Ot)return ye;Ot=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.FakeEventTarget=void 0;class g{listeners={};addEventListener(v,n,x){n&&(this.listeners[v]=this.listeners[v]??[],this.listeners[v].push({callback:typeof n=="function"?n:n.handleEvent,once:typeof x=="object"&&x.once===!0}))}removeEventListener(v,n,x){this.listeners[v]&&n&&(this.listeners[v]=this.listeners[v].filter(R=>R.callback!==(typeof n=="function"?n:n.handleEvent)))}dispatchEvent(v){if(!v||typeof v.type!="string")throw new Error("invalid event object");const n=this.listeners[v.type];if(!n)return!0;for(const x of[...n]){try{x.callback.call(this,v)}catch(R){setTimeout(()=>{throw R},0)}x.once&&this.removeEventListener(v.type,x.callback)}return!v.defaultPrevented}}return ye.FakeEventTarget=g,ye}var Se={},Ft;function vr(){if(Ft)return Se;Ft=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.FakeEvent=void 0;let g=class{NONE=0;CAPTURING_PHASE=1;AT_TARGET=2;BUBBLING_PHASE=3;type;bubbles;cancelable;defaultPrevented=!1;composed=!1;currentTarget=null;eventPhase=this.NONE;isTrusted=!0;target=null;timeStamp=0;cancelBubble=!1;returnValue=!0;srcElement=null;constructor(v,n={}){this.type=v,this.bubbles=n.bubbles??!1,this.cancelable=n.cancelable??!1}preventDefault(){this.cancelable&&(this.defaultPrevented=!0)}stopPropagation(){}stopImmediatePropagation(){}composedPath(){return[]}initEvent(v,n,x){}};return Se.FakeEvent=g,Se}var Le={},Nt;function wr(){if(Nt)return Le;Nt=1,Object.defineProperty(Le,"__esModule",{value:!0}),Le.clone=g;function g(b){if(b!==void 0)return Number.isNaN(b)?NaN:typeof structuredClone=="function"?structuredClone(b):JSON.parse(JSON.stringify(b))}return Le}var jt;function br(){if(jt)return be;jt=1,Object.defineProperty(be,"__esModule",{value:!0}),be.FakeMediaStreamTrack=void 0;const g=gr(),b=_r(),v=vr(),n=wr();class x extends b.FakeEventTarget{#m;#l;#u;#e;#r;#t;#s;#h;#i;#f;#n;#a=null;#o=null;#c=null;#d=null;#p=null;constructor({kind:m,id:c,label:S,contentHint:T,enabled:r,muted:h,readyState:u,capabilities:E,constraints:y,settings:e,data:t}){super(),this.#m=c??(0,g.v4)(),this.#l=m,this.#u=S??"",this.#s=T??"",this.#r=r??!0,this.#t=h??!1,this.#e=u??"live",this.#h=E??{},this.#i=y??{},this.#f=e??{},this.#n=t??{}}get id(){return this.#m}get kind(){return this.#l}get label(){return this.#u}get contentHint(){return this.#s}set contentHint(m){this.#s=m}get enabled(){return this.#r}set enabled(m){const c=this.#r!==m;this.#r=m,c&&this.dispatchEvent(new v.FakeEvent("enabledchange"))}get muted(){return this.#t}get readyState(){return this.#e}get data(){return this.#n}set data(m){this.#n=m}get onmute(){return this.#a}set onmute(m){this.#a&&this.removeEventListener("mute",this.#a),this.#a=m,m&&this.addEventListener("mute",m)}get onunmute(){return this.#o}set onunmute(m){this.#o&&this.removeEventListener("unmute",this.#o),this.#o=m,m&&this.addEventListener("unmute",m)}get onended(){return this.#c}set onended(m){this.#c&&this.removeEventListener("ended",this.#c),this.#c=m,m&&this.addEventListener("ended",m)}get onenabledchange(){return this.#d}set onenabledchange(m){this.#d&&this.removeEventListener("enabledchange",this.#d),this.#d=m,m&&this.addEventListener("enabledchange",m)}get onstopped(){return this.#p}set onstopped(m){this.#p&&this.removeEventListener("stopped",this.#p),this.#p=m,m&&this.addEventListener("stopped",m)}addEventListener(m,c,S){super.addEventListener(m,c,S)}removeEventListener(m,c,S){super.removeEventListener(m,c,S)}stop(){this.#e!=="ended"&&(this.#e="ended",this.dispatchEvent(new v.FakeEvent("stopped")))}clone({id:m,data:c}={}){return new x({id:m??(0,g.v4)(),kind:this.#l,label:this.#u,contentHint:this.#s,enabled:this.#r,muted:this.#t,readyState:this.#e,capabilities:(0,n.clone)(this.#h),constraints:(0,n.clone)(this.#i),settings:(0,n.clone)(this.#f),data:c??(0,n.clone)(this.#n)})}getCapabilities(){return this.#h}getConstraints(){return this.#i}async applyConstraints(m={}){return this.#i=m,Promise.resolve()}getSettings(){return this.#f}remoteStop(){this.#e!=="ended"&&(this.#e="ended",this.dispatchEvent(new v.FakeEvent("stopped")),this.dispatchEvent(new v.FakeEvent("ended")))}remoteMute(){this.#t||(this.#t=!0,this.dispatchEvent(new v.FakeEvent("mute")))}remoteUnmute(){this.#t&&(this.#t=!1,this.dispatchEvent(new v.FakeEvent("unmute")))}}return be.FakeMediaStreamTrack=x,be}var Ce={},At;function yr(){if(At)return Ce;At=1,Object.defineProperty(Ce,"__esModule",{value:!0}),Ce.FakeEventTarget=void 0;let g=class{listeners={};addEventListener(v,n,x){n&&(this.listeners[v]=this.listeners[v]??[],this.listeners[v].push({callback:typeof n=="function"?n:n.handleEvent,once:typeof x=="object"&&x.once===!0}))}removeEventListener(v,n,x){this.listeners[v]&&n&&(this.listeners[v]=this.listeners[v].filter(R=>R.callback!==(typeof n=="function"?n:n.handleEvent)))}dispatchEvent(v){if(!v||typeof v.type!="string")throw new Error("invalid event object");const n=this.listeners[v.type];if(!n)return!0;for(const x of[...n]){try{x.callback.call(this,v)}catch(R){setTimeout(()=>{throw R},0)}x.once&&this.removeEventListener(v.type,x.callback)}return!v.defaultPrevented}};return Ce.FakeEventTarget=g,Ce}var $t;function Sr(){if($t)return we;$t=1,Object.defineProperty(we,"__esModule",{value:!0}),we.FakeHandler=void 0;const g=br(),b=z(),v=$(),n=ee(),x=V(),R=U(),m=yr(),c=new v.Logger("FakeHandler"),S="FakeHandler";let T=class je extends b.EnhancedEventEmitter{_closed=!1;_fakeParameters;_getSendExtendedRtpCapabilities;_cname=`CNAME-${n.generateRandomNumber()}`;_defaultSendStreamId=`${n.generateRandomNumber()}`;_transportReady=!1;_nextLocalId=1;_tracks=new Map;_nextSctpStreamId=0;static createFactory(u){return{name:S,factory:E=>new je(E,u),getNativeRtpCapabilities:async()=>(c.debug("getNativeRtpCapabilities()"),je.getLocalRtpCapabilities(u)),getNativeSctpCapabilities:async()=>(c.debug("getNativeSctpCapabilities()"),u.generateNativeSctpCapabilities())}}static getLocalRtpCapabilities(u){const E=u.generateNativeRtpCapabilities();return x.validateAndNormalizeRtpCapabilities(E),E}constructor({getSendExtendedRtpCapabilities:u},E){super(),c.debug("constructor()"),this._getSendExtendedRtpCapabilities=u,this._fakeParameters=E}get name(){return S}close(){c.debug("close()"),!this._closed&&(this._closed=!0,super.close())}setIceGatheringState(u){this.emit("@icegatheringstatechange",u)}setConnectionState(u){this.emit("@connectionstatechange",u)}async updateIceServers(u){this.assertNotClosed(),c.debug("updateIceServers()")}async restartIce(u){this.assertNotClosed(),c.debug("restartIce()")}async getTransportStats(){return this.assertNotClosed(),new Map}async send({track:u,streamId:E,encodings:y,codecOptions:e,codec:t}){this.assertNotClosed(),c.debug("send() [kind:%s, track.id:%s]",u.kind,u.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"});const s=je.getLocalRtpCapabilities(this._fakeParameters),o=this._getSendExtendedRtpCapabilities(s),_=x.getSendingRtpParameters(u.kind,o);_.codecs=x.reduceCodecs(_.codecs,t);const l=_.codecs.some(p=>/.+\/rtx$/i.test(p.mimeType));_.mid=`mid-${n.generateRandomNumber()}`,_.msid=`${E??"-"} ${u.id}`,y||(y=[{}]);for(const p of y)p.ssrc=n.generateRandomNumber(),l&&(p.rtx={ssrc:n.generateRandomNumber()});_.encodings=y,_.rtcp={cname:this._cname,reducedSize:!0,mux:!0},_.msid=`${E??this._defaultSendStreamId} ${u.id}`;const f=this._nextLocalId++;return this._tracks.set(f,u),{localId:String(f),rtpParameters:_}}async stopSending(u){if(c.debug("stopSending() [localId:%s]",u),!this._closed){if(!this._tracks.has(Number(u)))throw new Error("local track not found");this._tracks.delete(Number(u))}}async pauseSending(u){this.assertNotClosed()}async resumeSending(u){this.assertNotClosed()}async replaceTrack(u,E){this.assertNotClosed(),E?c.debug("replaceTrack() [localId:%s, track.id:%s]",u,E.id):c.debug("replaceTrack() [localId:%s, no track]",u),this._tracks.delete(Number(u)),this._tracks.set(Number(u),E)}async setMaxSpatialLayer(u,E){this.assertNotClosed(),c.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",u,E)}async setRtpEncodingParameters(u,E){this.assertNotClosed(),c.debug("setRtpEncodingParameters() [localId:%s, params:%o]",u,E)}async getSenderStats(u){return this.assertNotClosed(),new Map}async sendDataChannel({ordered:u,maxPacketLifeTime:E,maxRetransmits:y,label:e,protocol:t}){this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),c.debug("sendDataChannel()");const s=new r({id:this._nextSctpStreamId++,ordered:u,maxPacketLifeTime:E,maxRetransmits:y,label:e,protocol:t}),o={streamId:this._nextSctpStreamId,ordered:u,maxPacketLifeTime:E,maxRetransmits:y};return{dataChannel:s,sctpStreamParameters:o}}async receive(u){this.assertNotClosed();const E=[];for(const y of u){const{trackId:e,kind:t}=y;this._transportReady||await this.setupTransport({localDtlsRole:"client"}),c.debug("receive() [trackId:%s, kind:%s]",e,t);const s=this._nextLocalId++,o=new g.FakeMediaStreamTrack({kind:t});this._tracks.set(s,o),E.push({localId:String(s),track:o})}return E}async stopReceiving(u){if(!this._closed)for(const E of u)c.debug("stopReceiving() [localId:%s]",E),this._tracks.delete(Number(E))}async pauseReceiving(u){this.assertNotClosed()}async resumeReceiving(u){this.assertNotClosed()}async getReceiverStats(u){return this.assertNotClosed(),new Map}async receiveDataChannel({sctpStreamParameters:u,label:E,protocol:y}){return this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"client"}),c.debug("receiveDataChannel()"),{dataChannel:new r({id:u.streamId,ordered:u.ordered,maxPacketLifeTime:u.maxPacketLifeTime,maxRetransmits:u.maxRetransmits,label:E,protocol:y})}}async setupTransport({localDtlsRole:u,localSdpObject:E}){const y=n.clone(this._fakeParameters.generateLocalDtlsParameters());u&&(y.role=u),this.emit("@connectionstatechange","connecting"),await new Promise((e,t)=>this.emit("@connect",{dtlsParameters:y},e,t)),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new R.InvalidStateError("method called in a closed handler")}};we.FakeHandler=T;class r extends m.FakeEventTarget{_id;_negotiated=!0;_ordered;_maxPacketLifeTime;_maxRetransmits;_label;_protocol;_readyState="connecting";_bufferedAmount=0;_bufferedAmountLowThreshold=0;_binaryType="arraybuffer";_onopen=null;_onclosing=null;_onclose=null;_onmessage=null;_onbufferedamountlow=null;_onerror=null;constructor({id:u,ordered:E=!0,maxPacketLifeTime:y=null,maxRetransmits:e=null,label:t="",protocol:s=""}){super(),c.debug(`constructor() [id:${u}, ordered:${E}, maxPacketLifeTime:${y}, maxRetransmits:${e}, label:${t}, protocol:${s}`),this._id=u,this._ordered=E,this._maxPacketLifeTime=y,this._maxRetransmits=e,this._label=t,this._protocol=s}get id(){return this._id}get negotiated(){return this._negotiated}get ordered(){return this._ordered}get maxPacketLifeTime(){return this._maxPacketLifeTime}get maxRetransmits(){return this._maxRetransmits}get label(){return this._label}get protocol(){return this._protocol}get readyState(){return this._readyState}get bufferedAmount(){return this._bufferedAmount}get bufferedAmountLowThreshold(){return this._bufferedAmountLowThreshold}set bufferedAmountLowThreshold(u){this._bufferedAmountLowThreshold=u}get binaryType(){return this._binaryType}set binaryType(u){this._binaryType=u}get onopen(){return this._onopen}set onopen(u){this._onopen&&this.removeEventListener("open",this._onopen),this._onopen=u,u&&this.addEventListener("open",u)}get onclosing(){return this._onclosing}set onclosing(u){this._onclosing&&this.removeEventListener("closing",this._onclosing),this._onclosing=u,u&&this.addEventListener("closing",u)}get onclose(){return this._onclose}set onclose(u){this._onclose&&this.removeEventListener("close",this._onclose),this._onclose=u,u&&this.addEventListener("close",u)}get onmessage(){return this._onmessage}set onmessage(u){this._onmessage&&this.removeEventListener("message",this._onmessage),this._onmessage=u,u&&this.addEventListener("message",u)}get onbufferedamountlow(){return this._onbufferedamountlow}set onbufferedamountlow(u){this._onbufferedamountlow&&this.removeEventListener("bufferedamountlow",this._onbufferedamountlow),this._onbufferedamountlow=u,u&&this.addEventListener("bufferedamountlow",u)}get onerror(){return this._onerror}set onerror(u){this._onerror&&this.removeEventListener("error",this._onerror),this._onerror=u,u&&this.addEventListener("error",u)}addEventListener(u,E,y){super.addEventListener(u,E,y)}removeEventListener(u,E,y){super.removeEventListener(u,E,y)}close(){["closing","closed"].includes(this._readyState)||(this._readyState="closed")}send(u){if(this._readyState!=="open")throw new R.InvalidStateError("not open")}}return we}var q={},zt;function Cr(){if(zt)return q;zt=1,Object.defineProperty(q,"__esModule",{value:!0}),q.generateRouterRtpCapabilities=v,q.generateNativeRtpCapabilities=n,q.generateNativeSctpCapabilities=x,q.generateLocalDtlsParameters=R,q.generateTransportRemoteParameters=m,q.generateProducerRemoteParameters=c,q.generateConsumerRemoteParameters=S,q.generateDataProducerRemoteParameters=T,q.generateDataConsumerRemoteParameters=r;const g=ee();function b(){return String(g.generateRandomNumber())}function v(){return g.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}},{mimeType:"video/H264",kind:"video",preferredPayloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:105,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"profile-id":0,"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:106,clockRate:9e4,rtcpFeedback:[],parameters:{apt:105}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:11,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"}]})}function n(){return{codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:111,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{minptime:10,useinbandfec:1}},{mimeType:"audio/ISAC",kind:"audio",preferredPayloadType:103,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/CN",kind:"audio",preferredPayloadType:106,clockRate:32e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/foo",kind:"audio",preferredPayloadType:107,clockRate:9e4,channels:4,rtcpFeedback:[{type:"foo-qwe-qwe"}],parameters:{foo:"lalala"}},{mimeType:"video/BAZCODEC",kind:"video",preferredPayloadType:100,clockRate:9e4,rtcpFeedback:[{type:"foo"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[],parameters:{apt:100}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:96,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:97,clockRate:9e4,rtcpFeedback:[],parameters:{apt:96}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:98,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{"profile-id":0}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:99,clockRate:9e4,rtcpFeedback:[],parameters:{apt:98}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:2},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:3},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:4},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay",preferredId:6},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type",preferredId:7},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing",preferredId:8},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10}]}}function x(){return g.deepFreeze({numStreams:{OS:2048,MIS:2048}})}function R(){return g.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"82:5A:68:3D:36:C3:0A:DE:AF:E7:32:43:D2:88:83:57:AC:2D:65:E5:80:C4:B6:FB:AF:1A:A0:21:9F:6D:0C:AD"}],role:"auto"})}function m(){return{id:b(),iceParameters:g.deepFreeze({iceLite:!0,password:"yku5ej8nvfaor28lvtrabcx0wkrpkztz",usernameFragment:"h3hk1iz6qqlnqlne"}),iceCandidates:g.deepFreeze([{foundation:"udpcandidate",address:"9.9.9.9",ip:"9.9.9.9",port:40533,priority:1078862079,protocol:"udp",type:"host",tcpType:"passive"},{foundation:"udpcandidate",address:"9.9.9.9",ip:"9:9:9:9:9:9",port:41333,priority:1078862089,protocol:"udp",type:"host",tcpType:"passive"}]),dtlsParameters:g.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"A9:F4:E0:D2:74:D3:0F:D9:CA:A5:2F:9F:7F:47:FA:F0:C4:72:DD:73:49:D0:3B:14:90:20:51:30:1B:90:8E:71"},{algorithm:"sha-384",value:"03:D9:0B:87:13:98:F6:6D:BC:FC:92:2E:39:D4:E1:97:32:61:30:56:84:70:81:6E:D1:82:97:EA:D9:C1:21:0F:6B:C5:E7:7F:E1:97:0C:17:97:6E:CF:B3:EF:2E:74:B0"},{algorithm:"sha-512",value:"84:27:A4:28:A4:73:AF:43:02:2A:44:68:FF:2F:29:5C:3B:11:9A:60:F4:A8:F0:F5:AC:A0:E3:49:3E:B1:34:53:A9:85:CE:51:9B:ED:87:5E:B8:F4:8E:3D:FA:20:51:B8:96:EE:DA:56:DC:2F:5C:62:79:15:23:E0:21:82:2B:2C"}],role:"auto"}),sctpParameters:g.deepFreeze({port:5e3,OS:2048,MIS:2048,maxMessageSize:2e6})}}function c(){return g.deepFreeze({id:b()})}function S({id:h,codecMimeType:u}={}){switch(u){case"audio/opus":return{id:h??b(),producerId:b(),kind:"audio",rtpParameters:g.deepFreeze({codecs:[{mimeType:"audio/opus",payloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}}],encodings:[{ssrc:46687003}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",id:10}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"audio/ISAC":return{id:h??b(),producerId:b(),kind:"audio",rtpParameters:g.deepFreeze({codecs:[{mimeType:"audio/ISAC",payloadType:111,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}}],encodings:[{ssrc:46687004}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/VP8":return{id:h??b(),producerId:b(),kind:"video",rtpParameters:g.deepFreeze({codecs:[{mimeType:"video/VP8",payloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",payloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}}],encodings:[{ssrc:99991111,rtx:{ssrc:99991112}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/H264":return{id:h??b(),producerId:b(),kind:"video",rtpParameters:g.deepFreeze({codecs:[{mimeType:"video/H264",payloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",payloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}}],encodings:[{ssrc:99991113,rtx:{ssrc:99991114}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};default:throw new TypeError(`unknown codecMimeType '${u}'`)}}function T(){return g.deepFreeze({id:b()})}function r({id:h}={}){return{id:h??b(),dataProducerId:b(),sctpStreamParameters:g.deepFreeze({streamId:666,maxPacketLifeTime:5e3,maxRetransmits:void 0})}}return q}var qt;function Rr(){return qt||(qt=1,(function(g){Object.defineProperty(g,"__esModule",{value:!0}),g.debug=g.testFakeParameters=g.FakeHandler=g.enhancedEvents=g.ortc=g.parseScalabilityMode=g.detectDeviceAsync=g.detectDevice=g.Device=g.version=g.types=void 0;const b=Ae();g.debug=b.default,g.types=Wt(),g.version="3.18.1";var v=mr();Object.defineProperty(g,"Device",{enumerable:!0,get:function(){return v.Device}}),Object.defineProperty(g,"detectDevice",{enumerable:!0,get:function(){return v.detectDevice}}),Object.defineProperty(g,"detectDeviceAsync",{enumerable:!0,get:function(){return v.detectDeviceAsync}});var n=te();Object.defineProperty(g,"parseScalabilityMode",{enumerable:!0,get:function(){return n.parse}}),g.ortc=V(),g.enhancedEvents=z();var x=Sr();Object.defineProperty(g,"FakeHandler",{enumerable:!0,get:function(){return x.FakeHandler}}),g.testFakeParameters=Cr()})($e)),$e}var qr=Rr();export{xr as A,Dr as M,kr as a,qr as l};
