import{a,j as t,c as Q,b as X}from"./app-CZUj66FS.js";import{l as Z,A as ee}from"./index-98mII7Yx.js";/* empty css            */function te({onReady:e}){const[s,r]=a.useState([]),[i,h]=a.useState([]),[v,I]=a.useState(""),[p,d]=a.useState(""),[g,l]=a.useState(!0),[b,m]=a.useState(!0),[c,n]=a.useState(null),j=a.useRef(null);a.useEffect(()=>{N()},[]),a.useEffect(()=>(S(),()=>{c&&c.getTracks().forEach(o=>o.stop())}),[v,p]),a.useEffect(()=>{c&&(c.getVideoTracks().forEach(o=>o.enabled=g),c.getAudioTracks().forEach(o=>o.enabled=b))},[g,b,c]);const N=async()=>{try{await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});const o=await navigator.mediaDevices.enumerateDevices();r(o.filter(f=>f.kind==="videoinput")),h(o.filter(f=>f.kind==="audioinput"));const C=o.find(f=>f.kind==="videoinput"),y=o.find(f=>f.kind==="audioinput");C&&I(C.deviceId),y&&d(y.deviceId)}catch(o){console.error("Error getting devices:",o)}},S=async()=>{c&&c.getTracks().forEach(o=>o.stop());try{const o=await navigator.mediaDevices.getUserMedia({video:v?{deviceId:{exact:v}}:!0,audio:p?{deviceId:{exact:p}}:!0});n(o),j.current&&(j.current.srcObject=o)}catch(o){console.error("Error starting preview:",o)}},T=()=>{c&&e(c,g,b)};return t.jsx("div",{className:"flex min-h-screen flex-col items-center justify-center bg-gray-900 p-4 text-white",children:t.jsxs("div",{className:"w-full max-w-md overflow-hidden rounded-xl bg-gray-800 shadow-2xl",children:[t.jsxs("div",{className:"relative aspect-video bg-black",children:[t.jsx("video",{ref:j,autoPlay:!0,muted:!0,playsInline:!0,className:`h-full w-full object-cover ${g?"":"hidden"}`}),!g&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-500",children:"Camera Off"}),t.jsxs("div",{className:"absolute right-0 bottom-4 left-0 flex justify-center gap-4",children:[t.jsx("button",{onClick:()=>m(!b),className:`rounded-full p-3 ${b?"bg-gray-700 hover:bg-gray-600":"bg-red-500 hover:bg-red-600"} transition-colors`,children:b?"Mic On":"Mic Off"}),t.jsx("button",{onClick:()=>l(!g),className:`rounded-full p-3 ${g?"bg-gray-700 hover:bg-gray-600":"bg-red-500 hover:bg-red-600"} transition-colors`,children:g?"Cam On":"Cam Off"})]})]}),t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsxs("div",{children:[t.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-400",children:"Camera"}),t.jsx("select",{value:v,onChange:o=>I(o.target.value),className:"w-full rounded-lg border-none bg-gray-700 px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500",children:s.map(o=>t.jsx("option",{value:o.deviceId,children:o.label||`Camera ${o.deviceId.slice(0,5)}...`},o.deviceId))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-400",children:"Microphone"}),t.jsx("select",{value:p,onChange:o=>d(o.target.value),className:"w-full rounded-lg border-none bg-gray-700 px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500",children:i.map(o=>t.jsx("option",{value:o.deviceId,children:o.label||`Mic ${o.deviceId.slice(0,5)}...`},o.deviceId))})]}),t.jsx("button",{onClick:T,className:"mt-4 w-full rounded-lg bg-indigo-600 px-4 py-3 font-bold text-white transition-colors hover:bg-indigo-700",children:"Start Streaming"})]})]})})}class oe{ws;device=null;sendTransport;producers=new Map;audioProducer=null;videoProducer=null;roomId;clientId;deviceLoadedPromise;deviceLoadedResolver=null;transportReadyPromise;transportReadyResolver=null;constructor(s,r,i){this.ws=new WebSocket(s),this.roomId=r,this.clientId=i,this.deviceLoadedPromise=new Promise(h=>{this.deviceLoadedResolver=h}),this.transportReadyPromise=new Promise(h=>{this.transportReadyResolver=h}),console.log("[CLIENT] WebRTC Client Created, room:",r,"client:",i)}onMessage(s){this.ws.onmessage=r=>{const i=JSON.parse(r.data);console.log(`[CLIENT] WS RECV: ${i.action}`,i),i.action==="restart-ice-done"&&this.handleRestartIceDone(i.data),i.action==="session-ended"&&(console.warn("[CLIENT] Session ended by server (restart?), reloading..."),window.location.reload()),s(i)}}send(s){const r={...s,clientId:this.clientId};console.log(`[CLIENT] WS SEND: ${s.action}`,r),this.ws.send(JSON.stringify(r))}async init(){return new Promise(s=>{this.connectWs(s)})}connectWs(s){this.ws=new WebSocket(this.ws.url),this.ws.onopen=()=>{console.log("[CLIENT] WS CONNECTED"),this.send({action:"join-as-streamer",roomId:this.roomId}),s&&s()},this.ws.onclose=()=>{console.log("[CLIENT] WS CLOSED, reconnecting in 3s..."),setTimeout(()=>this.connectWs(),3e3)},this.ws.onerror=r=>{console.error("[CLIENT] WS ERROR:",r),this.ws.close()},this.onMessage(r=>{})}async loadDevice(s){console.log("[CLIENT] Loading device with capabilities:",s),this.device=new Z.Device,await this.device.load({routerRtpCapabilities:s}),console.log("[CLIENT] Device loaded"),this.deviceLoadedResolver&&this.deviceLoadedResolver()}async createSendTransport(s){if(console.log("[CLIENT] createSendTransport options received:",s),!s){console.error("[CLIENT] ERROR! createSendTransport called with EMPTY options");return}if(await this.deviceLoadedPromise,!this.device){console.error("[CLIENT] Device is null after waiting!");return}this.sendTransport=this.device.createSendTransport(s),this.transportReadyResolver&&this.transportReadyResolver(),this.sendTransport.on("connect",({dtlsParameters:r},i)=>{console.log("[CLIENT] Transport connect"),this.send({action:"connect-transport",roomId:this.roomId,data:{transportId:this.sendTransport.id,dtlsParameters:r}}),i()}),this.sendTransport.on("connectionstatechange",async r=>{console.log(`[CLIENT] Send Transport connection state changed: ${r}`),(r==="failed"||r==="disconnected")&&(console.warn("[CLIENT] Transport failed/disconnected. Not restarting ICE to avoid loops. Reloading..."),window.location.reload())}),this.sendTransport.on("produce",({kind:r,rtpParameters:i},h)=>{console.log("[CLIENT] Transport produce"),this.send({action:"produce",roomId:this.roomId,data:{transportId:this.sendTransport.id,kind:r,rtpParameters:i}});const v=I=>{const p=JSON.parse(I.data);p.action==="produce-done"&&(console.log("[CLIENT] producer created:",p.producerId),h({id:p.producerId}),this.ws.removeEventListener("message",v))};this.ws.addEventListener("message",v)})}async produceStream(s){if(await this.transportReadyPromise,!this.sendTransport){console.error("[CLIENT] sendTransport is not ready!");return}const r=s.getVideoTracks()[0];r&&(console.log("[CLIENT] Producing video track..."),this.videoProducer=await this.sendTransport.produce({track:r}),this.producers.set("video",this.videoProducer));const i=s.getAudioTracks()[0];i&&(console.log("[CLIENT] Producing audio track..."),this.audioProducer=await this.sendTransport.produce({track:i}),this.producers.set("audio",this.audioProducer))}async replaceVideoTrack(s){this.videoProducer&&await this.videoProducer.replaceTrack({track:s})}muteAudio(){this.audioProducer&&this.audioProducer.pause()}unmuteAudio(){this.audioProducer&&this.audioProducer.resume()}pauseVideo(){this.videoProducer&&this.videoProducer.pause()}resumeVideo(){this.videoProducer&&this.videoProducer.resume()}restartIce(s){this.send({action:"restart-ice",roomId:this.roomId,data:{transportId:s}})}async handleRestartIceDone(s){const{transportId:r,iceParameters:i}=s;this.sendTransport&&this.sendTransport.id===r&&(console.log("[CLIENT] Restarting ICE with new parameters"),await this.sendTransport.restartIce({iceParameters:i}))}handleAdminAction(s,r){switch(console.log(`[CLIENT] Handling admin action: ${s}`,r),s){case"mute-audio":this.muteAudio();break;case"unmute-audio":this.unmuteAudio();break;case"mute-video":this.pauseVideo();break;case"unmute-video":this.resumeVideo();break;case"reload":window.location.reload();break;default:console.warn(`[CLIENT] Unknown admin action: ${s}`)}}}function ne(){const e=Q.c(53),s=a.useRef(null),[r,i]=a.useState(!1),[h,v]=a.useState(0),[I,p]=a.useState(!1),[d,g]=a.useState(null),[l,b]=a.useState(null),[m,c]=a.useState(!0),[n,j]=a.useState(!0);let N;if(e[0]===Symbol.for("react.memo_cache_sentinel")){N=(z,x,k)=>{g(z),j(x),c(k),p(!0),U(z)};const U=z=>{let x=localStorage.getItem("stream_room_id");x||(x=`client-${Date.now()}`,localStorage.setItem("stream_room_id",x));let k=sessionStorage.getItem(`stream_connection_id_${x}`);k||(k=crypto.randomUUID(),sessionStorage.setItem(`stream_connection_id_${x}`,k)),X.post(`/api/rooms/${x}/join`,{connection_id:k}).then(()=>{console.log("[PAGE] Session created in DB");const w=new oe("ws://192.168.1.14:5005",x,k);b(w),w.init().then(()=>{w.onMessage(async u=>{u.action==="router-rtp-capabilities"&&await w.loadDevice(u.data),u.action==="create-send-transport"&&u.data&&await w.createSendTransport(u.data),u.action==="start-produce"&&(await w.produceStream(z),i(!0)),u.action==="viewer-count"&&v(u.count),u.action==="session-ended"&&(console.warn("[PAGE] Session ended by server, reloading..."),window.location.reload()),u.action==="admin-action"&&w&&w.handleAdminAction(u.data.type,u.data.payload)})})}).catch(se)};e[0]=N}else N=e[0];let S;e[1]!==d?(S=()=>{s.current&&d&&(s.current.srcObject=d)},e[1]=d,e[2]=S):S=e[2];let T;e[3]!==r||e[4]!==d?(T=[d,r],e[3]=r,e[4]=d,e[5]=T):T=e[5],a.useEffect(S,T);let o;e[6]!==m||e[7]!==l?(o=()=>{l&&(m?l.muteAudio():l.unmuteAudio(),c(!m))},e[6]=m,e[7]=l,e[8]=o):o=e[8];const C=o;let y;e[9]!==l||e[10]!==n?(y=()=>{l&&(n?l.pauseVideo():l.resumeVideo(),j(!n))},e[9]=l,e[10]=n,e[11]=y):y=e[11];const f=y;if(!I){let U;return e[12]===Symbol.for("react.memo_cache_sentinel")?(U=t.jsx(te,{onReady:N}),e[12]=U):U=e[12],U}let B;e[13]===Symbol.for("react.memo_cache_sentinel")?(B=t.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"Client Streaming"}),e[13]=B):B=e[13];let E;e[14]!==r?(E=r?t.jsxs("span",{className:"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200",children:[t.jsx("span",{className:"mr-1.5 h-2 w-2 rounded-full bg-red-600"}),"LIVE"]}):t.jsx("span",{className:"inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",children:"CONNECTING"}),e[14]=r,e[15]=E):E=e[15];let L;e[16]!==h?(L=t.jsxs("span",{className:"inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200",children:[h," Viewers"]}),e[16]=h,e[17]=L):L=e[17];let P;e[18]!==E||e[19]!==L?(P=t.jsx("div",{className:"border-b border-gray-200 p-4 dark:border-gray-700",children:t.jsxs("div",{className:"flex items-center justify-between",children:[B,t.jsxs("div",{className:"flex items-center gap-2",children:[E,L]})]})}),e[18]=E,e[19]=L,e[20]=P):P=e[20];const J=`h-full w-full object-cover ${n?"":"opacity-50"}`;let R;e[21]!==J?(R=t.jsx("video",{ref:s,autoPlay:!0,muted:!0,playsInline:!0,className:J}),e[21]=J,e[22]=R):R=e[22];let D;e[23]!==n?(D=!n&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400",children:"Camera Paused"}),e[23]=n,e[24]=D):D=e[24];const F=`rounded-full p-3 ${m?"bg-white/20 text-white hover:bg-white/30":"bg-red-500 text-white hover:bg-red-600"} backdrop-blur-sm transition-colors`,Y=m?"Mute Mic":"Unmute Mic";let A;e[25]!==m?(A=m?t.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})}):t.jsxs("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"})]}),e[25]=m,e[26]=A):A=e[26];let M;e[27]!==F||e[28]!==Y||e[29]!==A||e[30]!==C?(M=t.jsx("button",{onClick:C,className:F,title:Y,children:A}),e[27]=F,e[28]=Y,e[29]=A,e[30]=C,e[31]=M):M=e[31];let V;e[32]!==d?(V=d?.getAudioTracks()[0]&&t.jsxs("div",{className:"flex items-center gap-2 rounded-full bg-black/50 px-3 py-2 backdrop-blur-sm",children:[t.jsx("span",{className:"text-xs text-white",children:"Mic Level:"}),t.jsx(ee,{track:d.getAudioTracks()[0]})]}),e[32]=d,e[33]=V):V=e[33];const q=`rounded-full p-3 ${n?"bg-white/20 text-white hover:bg-white/30":"bg-red-500 text-white hover:bg-red-600"} backdrop-blur-sm transition-colors`,K=n?"Turn Off Camera":"Turn On Camera";let _;e[34]!==n?(_=n?t.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}):t.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"})}),e[34]=n,e[35]=_):_=e[35];let $;e[36]!==q||e[37]!==K||e[38]!==_||e[39]!==f?($=t.jsx("button",{onClick:f,className:q,title:K,children:_}),e[36]=q,e[37]=K,e[38]=_,e[39]=f,e[40]=$):$=e[40];let O;e[41]!==M||e[42]!==V||e[43]!==$?(O=t.jsxs("div",{className:"absolute right-0 bottom-0 left-0 flex justify-center gap-4 bg-gradient-to-t from-black/80 to-transparent p-4 opacity-0 transition-opacity group-hover:opacity-100",children:[M,V,$]}),e[41]=M,e[42]=V,e[43]=$,e[44]=O):O=e[44];let W;e[45]!==D||e[46]!==O||e[47]!==R?(W=t.jsxs("div",{className:"group relative aspect-video bg-black",children:[R,D,O]}),e[45]=D,e[46]=O,e[47]=R,e[48]=W):W=e[48];let G;e[49]===Symbol.for("react.memo_cache_sentinel")?(G=t.jsx("div",{className:"p-4 text-sm text-gray-500 dark:text-gray-400",children:t.jsxs("p",{children:["Share your stream ID:"," ",t.jsx("code",{className:"rounded bg-gray-100 px-1 py-0.5 font-mono text-gray-800 dark:bg-gray-700 dark:text-gray-200",children:localStorage.getItem("stream_room_id")})]})}),e[49]=G):G=e[49];let H;return e[50]!==W||e[51]!==P?(H=t.jsx("div",{className:"flex min-h-screen items-center justify-center bg-gray-100 p-6 dark:bg-gray-900",children:t.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-xl bg-white shadow-xl dark:bg-gray-800",children:[P,W,G]})}),e[50]=W,e[51]=P,e[52]=H):H=e[52],H}function se(e){return console.error("[PAGE] Failed to join room API:",e)}export{ne as default};
