import{c as I,j as t,H as A,a as m}from"./app-lpOYEbLC.js";import{A as E}from"./app-layout-BX5iJD55.js";import{l as T}from"./index-BCtBPRNr.js";/* empty css            */import"./app-logo-icon-U0ofIimr.js";import"./index-A2iG4xAQ.js";import"./index-KJo104aI.js";import"./index-C4J_hXM0.js";function q(i){const r=I.c(8),{roomId:o}=i;let p;r[0]===Symbol.for("react.memo_cache_sentinel")?(p=[{title:"Room Monitor",href:"#"}],r[0]=p):p=r[0];const d=`Monitor Room ${o}`;let a;r[1]!==d?(a=t.jsx(A,{title:d}),r[1]=d,r[2]=a):a=r[2];let l;r[3]!==o?(l=t.jsx(P,{roomId:o}),r[3]=o,r[4]=l):l=r[4];let u;return r[5]!==a||r[6]!==l?(u=t.jsxs(E,{breadcrumbs:p,children:[a,l]}),r[5]=a,r[6]=l,r[7]=u):u=r[7],u}function P({roomId:i,variant:r="full"}){const[o,p]=m.useState([]),d=m.useRef(null),a=m.useRef(null),l=m.useRef(null),u=m.useRef(new Map),g=m.useRef([]),f=m.useRef("");if(!f.current){const e=sessionStorage.getItem(`mediasoup-client-id-${i}`);if(e)f.current=e;else{const s=crypto.randomUUID();sessionStorage.setItem(`mediasoup-client-id-${i}`,s),f.current=s}}const[w,N]=m.useState("disconnected");m.useEffect(()=>{let e=null,s;const c=()=>{const n="wss://eyeserver.mytro.in";e=new WebSocket(n),a.current=e,e.onopen=()=>{console.log("[ADMIN] Connected to Mediasoup Server"),N("connected");const x={action:"join-as-viewer",roomId:i,clientId:f.current};console.log("[ADMIN] Sending join-as-viewer:",x),e?.send(JSON.stringify(x))},e.onmessage=async x=>{const y=JSON.parse(x.data),{action:b,data:h}=y;switch(console.log(`[ADMIN] WS RECV: ${b}`,h),b){case"router-rtp-capabilities":await R(h),e?.send(JSON.stringify({action:"create-recv-transport",roomId:i,clientId:f.current}));break;case"create-recv-transport":await S(h);break;case"existing-producers":for(const v of h)j(v.id);break;case"new-producer":j(h.producerId);break;case"producer-closed":p(v=>v.filter(C=>C.producerId!==h.producerId));break;case"consume-done":await D(h);break;case"transport-connected":break;case"restart-ice-done":await $(h);break}},e.onclose=()=>{console.log("[ADMIN] WS Closed, reconnecting in 3s..."),N("reconnecting"),s=setTimeout(c,3e3)},e.onerror=x=>{console.error("[ADMIN] WS Error:",x),e?.close()}};return c(),()=>{e&&e.close(),clearTimeout(s)}},[i]);const R=async e=>{try{const s=new T.Device;await s.load({routerRtpCapabilities:e}),d.current=s,console.log("Device loaded")}catch(s){console.error("Failed to load device:",s)}},S=async e=>{const s=d.current;if(!s)return;const c=s.createRecvTransport(e);if(l.current=c,c.on("connect",({dtlsParameters:n},x,y)=>{a.current?.send(JSON.stringify({action:"connect-transport",roomId:i,clientId:f.current,data:{transportId:c.id,dtlsParameters:n}})),x()}),c.on("connectionstatechange",n=>{console.log("[ADMIN] Recv Transport connection state changed:",n),(n==="failed"||n==="disconnected")&&(console.log("[ADMIN] Transport failed, restarting ICE..."),M(c.id))}),console.log("Recv Transport created"),g.current.length>0){console.log(`Processing ${g.current.length} pending producers`);for(const n of g.current)j(n);g.current=[]}},j=e=>{const s=d.current,c=l.current;if(!s||!c){console.warn("Device or transport not ready to consume, queueing producer",e),g.current.push(e);return}const n=s.rtpCapabilities;a.current?.send(JSON.stringify({action:"consume",roomId:i,clientId:f.current,data:{transportId:c.id,producerId:e,rtpCapabilities:n}}))},D=async e=>{const{id:s,producerId:c,kind:n,rtpParameters:x}=e,y=l.current;if(!y)return;const b=await y.consume({id:s,producerId:c,kind:n,rtpParameters:x});u.current.set(b.id,b),new MediaStream().addTrack(b.track),p(v=>[...v,{id:b.id,producerId:c,track:b.track}]),console.log(`Consuming ${n} from producer ${c}`),console.log(`Consuming ${n} from producer ${c}`)},M=e=>{a.current?.send(JSON.stringify({action:"restart-ice",roomId:i,clientId:f.current,data:{transportId:e}}))},$=async e=>{const{transportId:s,iceParameters:c}=e,n=l.current;n&&n.id===s&&(console.log("[ADMIN] Restarting ICE with new parameters"),await n.restartIce({iceParameters:c}))};return console.log("RoomMonitor variant:",r),r==="card"?t.jsx("div",{className:"h-full w-full bg-black",children:o.length===0?t.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-gray-500 border-t-white"}),t.jsx("span",{className:"text-xs",children:"Connecting..."})]})}):t.jsx("div",{className:`grid h-full w-full ${o.length>1?"grid-cols-2":"grid-cols-1"}`,children:o.map(e=>t.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[t.jsx(k,{track:e.track,controls:!1}),t.jsx("div",{className:"absolute bottom-2 left-2 rounded bg-black/60 px-1.5 py-0.5 text-[10px] text-white backdrop-blur-sm",children:e.producerId.slice(0,6)})]},e.id))})}):t.jsxs("div",{className:"h-full p-6",children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[t.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Room:"," ",t.jsx("span",{className:"font-mono text-blue-600 dark:text-blue-400",children:i})]}),t.jsx("span",{className:`rounded-full px-3 py-1 text-sm font-medium ${w==="connected"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":w==="reconnecting"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:w==="connected"?"Active":w==="reconnecting"?"Reconnecting...":"Disconnected"})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[o.length===0&&t.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[t.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),t.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),t.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),o.map(e=>t.jsxs("div",{className:"overflow-hidden rounded-xl bg-white shadow-lg ring-1 ring-gray-200 dark:bg-gray-800 dark:ring-gray-700",children:[t.jsxs("div",{className:"relative aspect-video bg-black",children:[t.jsx(k,{track:e.track}),t.jsx("div",{className:"absolute bottom-3 left-3 flex items-center gap-2",children:t.jsxs("span",{className:"rounded bg-black/60 px-2 py-1 font-mono text-xs text-white backdrop-blur-sm",children:["ID: ",e.producerId.slice(0,8)]})}),t.jsx("div",{className:"absolute top-3 right-3",children:t.jsxs("span",{className:"flex h-2 w-2",children:[t.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75"}),t.jsx("span",{className:"relative inline-flex h-2 w-2 rounded-full bg-red-500"})]})})]}),t.jsx("div",{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Live Stream"}),t.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Video"})]})})]},e.id))]})]})}const k=i=>{const r=I.c(5),{track:o,controls:p}=i,d=p===void 0?!0:p,a=m.useRef(null);let l,u;r[0]!==o?(l=()=>{if(a.current&&o){const f=new MediaStream([o]);a.current.srcObject=f,a.current.play().catch(console.error)}},u=[o],r[0]=o,r[1]=l,r[2]=u):(l=r[1],u=r[2]),m.useEffect(l,u);let g;return r[3]!==d?(g=t.jsx("video",{ref:a,autoPlay:!0,playsInline:!0,muted:!0,controls:d,className:"h-full w-full object-cover"}),r[3]=d,r[4]=g):g=r[4],g};export{P as RoomMonitor,q as default};
