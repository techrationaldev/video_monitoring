import{c as R,j as e,H as $,a as m}from"./app-CkbTZbio.js";import{A as E}from"./app-layout-C8apEwCq.js";import{l as P}from"./index-BCtBPRNr.js";/* empty css            */import"./app-logo-icon-Cz9mu5D1.js";import"./index-BFc6lm0F.js";import"./index-BN5Tskw9.js";import"./index-C4J_hXM0.js";function q(i){const r=R.c(8),{roomId:o}=i;let p;r[0]===Symbol.for("react.memo_cache_sentinel")?(p=[{title:"Room Monitor",href:"#"}],r[0]=p):p=r[0];const d=`Monitor Room ${o}`;let a;r[1]!==d?(a=e.jsx($,{title:d}),r[1]=d,r[2]=a):a=r[2];let l;r[3]!==o?(l=e.jsx(O,{roomId:o}),r[3]=o,r[4]=l):l=r[4];let u;return r[5]!==a||r[6]!==l?(u=e.jsxs(E,{breadcrumbs:p,children:[a,l]}),r[5]=a,r[6]=l,r[7]=u):u=r[7],u}function O({roomId:i,variant:r="full"}){const[o,p]=m.useState([]),d=m.useRef(null),a=m.useRef(null),l=m.useRef(null),u=m.useRef(new Map),f=m.useRef([]),x=m.useRef(crypto.randomUUID()),[w,k]=m.useState("disconnected");m.useEffect(()=>{let t=null,c;const n=()=>{const s="wss://eyeserver.mytro.in";t=new WebSocket(s),a.current=t,t.onopen=()=>{console.log("Connected to Mediasoup Server"),k("connected"),t?.send(JSON.stringify({action:"join-as-viewer",roomId:i,clientId:x.current}))},t.onmessage=async h=>{const y=JSON.parse(h.data),{action:b,data:g}=y;switch(b){case"router-rtp-capabilities":await I(g),t?.send(JSON.stringify({action:"create-recv-transport",roomId:i,clientId:x.current}));break;case"create-recv-transport":await S(g);break;case"existing-producers":for(const v of g)j(v.id);break;case"new-producer":j(g.producerId);break;case"producer-closed":p(v=>v.filter(T=>T.producerId!==g.producerId));break;case"consume-done":await D(g);break;case"transport-connected":break;case"restart-ice-done":await C(g);break}},t.onclose=()=>{console.log("WS Closed, reconnecting in 3s..."),k("reconnecting"),c=setTimeout(n,3e3)},t.onerror=h=>{console.error("WS Error:",h),t?.close()}};return n(),()=>{t&&t.close(),clearTimeout(c)}},[i]);const I=async t=>{try{const c=new P.Device;await c.load({routerRtpCapabilities:t}),d.current=c,console.log("Device loaded")}catch(c){console.error("Failed to load device:",c)}},S=async t=>{const c=d.current;if(!c)return;const n=c.createRecvTransport(t);if(l.current=n,n.on("connect",({dtlsParameters:s},h,y)=>{a.current?.send(JSON.stringify({action:"connect-transport",roomId:i,clientId:x.current,data:{transportId:n.id,dtlsParameters:s}})),h()}),n.on("connectionstatechange",s=>{console.log("[ADMIN] Recv Transport connection state changed:",s),(s==="failed"||s==="disconnected")&&(console.log("[ADMIN] Transport failed, restarting ICE..."),M(n.id))}),console.log("Recv Transport created"),f.current.length>0){console.log(`Processing ${f.current.length} pending producers`);for(const s of f.current)j(s);f.current=[]}},j=t=>{const c=d.current,n=l.current;if(!c||!n){console.warn("Device or transport not ready to consume, queueing producer",t),f.current.push(t);return}const s=c.rtpCapabilities;a.current?.send(JSON.stringify({action:"consume",roomId:i,clientId:x.current,data:{transportId:n.id,producerId:t,rtpCapabilities:s}}))},D=async t=>{const{id:c,producerId:n,kind:s,rtpParameters:h}=t,y=l.current;if(!y)return;const b=await y.consume({id:c,producerId:n,kind:s,rtpParameters:h});u.current.set(b.id,b),new MediaStream().addTrack(b.track),p(v=>[...v,{id:b.id,producerId:n,track:b.track}]),console.log(`Consuming ${s} from producer ${n}`),console.log(`Consuming ${s} from producer ${n}`)},M=t=>{a.current?.send(JSON.stringify({action:"restart-ice",roomId:i,clientId:x.current,data:{transportId:t}}))},C=async t=>{const{transportId:c,iceParameters:n}=t,s=l.current;s&&s.id===c&&(console.log("[ADMIN] Restarting ICE with new parameters"),await s.restartIce({iceParameters:n}))};return console.log("RoomMonitor variant:",r),r==="card"?e.jsx("div",{className:"h-full w-full bg-black",children:o.length===0?e.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-gray-500 border-t-white"}),e.jsx("span",{className:"text-xs",children:"Connecting..."})]})}):e.jsx("div",{className:`grid h-full w-full ${o.length>1?"grid-cols-2":"grid-cols-1"}`,children:o.map(t=>e.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[e.jsx(N,{track:t.track,controls:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 rounded bg-black/60 px-1.5 py-0.5 text-[10px] text-white backdrop-blur-sm",children:t.producerId.slice(0,6)})]},t.id))})}):e.jsxs("div",{className:"h-full p-6",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Room:"," ",e.jsx("span",{className:"font-mono text-blue-600 dark:text-blue-400",children:i})]}),e.jsx("span",{className:`rounded-full px-3 py-1 text-sm font-medium ${w==="connected"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":w==="reconnecting"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:w==="connected"?"Active":w==="reconnecting"?"Reconnecting...":"Disconnected"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[o.length===0&&e.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[e.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),e.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),e.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),o.map(t=>e.jsxs("div",{className:"overflow-hidden rounded-xl bg-white shadow-lg ring-1 ring-gray-200 dark:bg-gray-800 dark:ring-gray-700",children:[e.jsxs("div",{className:"relative aspect-video bg-black",children:[e.jsx(N,{track:t.track}),e.jsx("div",{className:"absolute bottom-3 left-3 flex items-center gap-2",children:e.jsxs("span",{className:"rounded bg-black/60 px-2 py-1 font-mono text-xs text-white backdrop-blur-sm",children:["ID: ",t.producerId.slice(0,8)]})}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsxs("span",{className:"flex h-2 w-2",children:[e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex h-2 w-2 rounded-full bg-red-500"})]})})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Live Stream"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Video"})]})})]},t.id))]})]})}const N=i=>{const r=R.c(5),{track:o,controls:p}=i,d=p===void 0?!0:p,a=m.useRef(null);let l,u;r[0]!==o?(l=()=>{if(a.current&&o){const x=new MediaStream([o]);a.current.srcObject=x,a.current.play().catch(console.error)}},u=[o],r[0]=o,r[1]=l,r[2]=u):(l=r[1],u=r[2]),m.useEffect(l,u);let f;return r[3]!==d?(f=e.jsx("video",{ref:a,autoPlay:!0,playsInline:!0,muted:!0,controls:d,className:"h-full w-full object-cover"}),r[3]=d,r[4]=f):f=r[4],f};export{O as RoomMonitor,q as default};
