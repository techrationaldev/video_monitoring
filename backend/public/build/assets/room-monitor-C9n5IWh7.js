import{c as M,j as e,H as W,a as u}from"./app-BT4yo09Q.js";import{A as J}from"./app-layout-DZTH3K_z.js";import{l as V}from"./index-BCtBPRNr.js";/* empty css            */import"./app-logo-icon-DUEKiWEV.js";import"./index-DZAFyCSK.js";import"./index-DbiO_Wh3.js";import"./index-C4J_hXM0.js";function Y(m){const r=M.c(8),{roomId:l}=m;let p;r[0]===Symbol.for("react.memo_cache_sentinel")?(p=[{title:"Room Monitor",href:"#"}],r[0]=p):p=r[0];const i=`Monitor Room ${l}`;let d;r[1]!==i?(d=e.jsx(W,{title:i}),r[1]=i,r[2]=d):d=r[2];let n;r[3]!==l?(n=e.jsx(H,{roomId:l}),r[3]=l,r[4]=n):n=r[4];let c;return r[5]!==d||r[6]!==n?(c=e.jsxs(J,{breadcrumbs:p,children:[d,n]}),r[5]=d,r[6]=n,r[7]=c):c=r[7],c}function H({roomId:m,variant:r="full"}){const[l,p]=u.useState([]),[i,d]=u.useState(null),n=l.reduce((t,s)=>(t[s.clientId]||(t[s.clientId]={clientId:s.clientId}),s.kind==="video"&&(t[s.clientId].video=s),s.kind==="audio"&&(t[s.clientId].audio=s),t),{}),c=u.useRef(null),x=u.useRef(null),h=u.useRef(null),v=u.useRef(new Map),j=u.useRef([]),b=u.useRef("");if(!b.current){const t=sessionStorage.getItem(`mediasoup-client-id-${m}`);if(t)b.current=t;else{const s=crypto.randomUUID();sessionStorage.setItem(`mediasoup-client-id-${m}`,s),b.current=s}}const[w,S]=u.useState("disconnected"),[$,C]=u.useState(!1);u.useEffect(()=>{let t=null,s;const a=()=>{const o="wss://eyeserver.mytro.in";t=new WebSocket(o),x.current=t,t.onopen=()=>{console.log("[ADMIN] Connected to Mediasoup Server"),S("connected");const g={action:"join-as-viewer",roomId:m,clientId:b.current};console.log("[ADMIN] Sending join-as-viewer:",g),t?.send(JSON.stringify(g))},t.onmessage=async g=>{const N=JSON.parse(g.data),{action:k,data:f}=N;switch(console.log(`[ADMIN] WS RECV: ${k}`,f),k){case"router-rtp-capabilities":await O(f),t?.send(JSON.stringify({action:"create-recv-transport",roomId:m,clientId:b.current}));break;case"create-recv-transport":await L(f);break;case"existing-producers":for(const y of f)I(y.id,y.clientId);break;case"new-producer":I(f.producerId,f.clientId);break;case"producer-closed":p(y=>y.filter(R=>R.producerId!==f.producerId));break;case"consume-done":await E(f);break;case"transport-connected":break;case"restart-ice-done":await P(f);break;case"stream-interrupted":console.warn("[ADMIN] Stream interrupted (network drop?)"),C(!0);break}},t.onclose=()=>{console.log("[ADMIN] WS Closed, reconnecting in 3s..."),S("reconnecting"),s=setTimeout(a,3e3)},t.onerror=g=>{console.error("[ADMIN] WS Error:",g),t?.close()}};return a(),()=>{t&&t.close(),clearTimeout(s),c.current=null,h.current=null,v.current=new Map,j.current=[],p([])}},[m]);const O=async t=>{try{const s=new V.Device;await s.load({routerRtpCapabilities:t}),c.current=s,console.log("Device loaded")}catch(s){console.error("Failed to load device:",s)}},L=async t=>{const s=c.current;if(!s)return;const a=s.createRecvTransport(t);if(h.current=a,a.on("connect",({dtlsParameters:o},g,N)=>{x.current?.send(JSON.stringify({action:"connect-transport",roomId:m,clientId:b.current,data:{transportId:a.id,dtlsParameters:o}})),g()}),a.on("connectionstatechange",o=>{console.log("[ADMIN] Recv Transport connection state changed:",o),(o==="failed"||o==="disconnected")&&(console.log("[ADMIN] Transport failed, restarting ICE..."),T(a.id))}),console.log("Recv Transport created"),j.current.length>0){console.log(`Processing ${j.current.length} pending producers`);for(const o of j.current)I(o,"unknown");j.current=[]}},I=(t,s)=>{const a=c.current,o=h.current;if(!a||!o){console.warn(t);return}const g=a.rtpCapabilities;x.current?.send(JSON.stringify({action:"consume",roomId:m,clientId:b.current,data:{transportId:o.id,producerId:t,rtpCapabilities:g,appData:{clientId:s}}})),A.current.set(t,s)},A=u.useRef(new Map),E=async t=>{const{id:s,producerId:a,kind:o,rtpParameters:g}=t,N=A.current.get(a)||"unknown",k=h.current;if(!k)return;const f=await k.consume({id:s,producerId:a,kind:o,rtpParameters:g});v.current.set(f.id,f),new MediaStream().addTrack(f.track),p(R=>[...R,{id:f.id,producerId:a,kind:o,track:f.track,clientId:N}]),C(!1),console.log(`Consuming ${o} from producer ${a}`),console.log(`Consuming ${o} from producer ${a}`)},T=t=>{x.current?.send(JSON.stringify({action:"restart-ice",roomId:m,clientId:b.current,data:{transportId:t}}))},P=async t=>{const{transportId:s,iceParameters:a}=t,o=h.current;o&&o.id===s&&(console.log("[ADMIN] Restarting ICE with new parameters"),await o.restartIce({iceParameters:a}))};return console.log("RoomMonitor variant:",r),r==="card"?e.jsx("div",{className:"h-full w-full bg-black",children:Object.keys(n).length===0?e.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-gray-500 border-t-white"}),e.jsx("span",{className:"text-xs",children:"Connecting..."})]})}):e.jsx("div",{className:`grid h-full w-full ${Object.keys(n).length>1?"grid-cols-2":"grid-cols-1"}`,children:Object.values(n).map(t=>e.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[t.video?e.jsx(D,{track:t.video.track,controls:!1,muted:!0}):e.jsx("div",{className:"flex h-full items-center justify-center bg-gray-900 text-white",children:"No Video"}),e.jsx("div",{className:"absolute bottom-2 left-2 rounded bg-black/60 px-1.5 py-0.5 text-[10px] text-white backdrop-blur-sm",children:t.clientId.slice(0,6)})]},t.clientId))})}):e.jsxs("div",{className:"h-full p-6",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Room:"," ",e.jsx("span",{className:"font-mono text-blue-600 dark:text-blue-400",children:m})]}),e.jsx("span",{className:`rounded-full px-3 py-1 text-sm font-medium ${w==="connected"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":w==="reconnecting"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:w==="connected"?"Active":w==="reconnecting"?"Reconnecting...":"Disconnected"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[streams.length===0&&e.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[e.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),e.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),e.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),Object.keys(n).length===0&&e.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[e.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),e.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),e.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),Object.values(n).map(t=>e.jsxs("div",{className:`overflow-hidden rounded-xl bg-white shadow-lg ring-1 transition-all ${i===t.clientId?"ring-2 shadow-blue-500/20 ring-blue-500":"ring-gray-200 dark:ring-gray-700"} dark:bg-gray-800`,onClick:()=>d(t.clientId===i?null:t.clientId),children:[e.jsxs("div",{className:"group relative aspect-video cursor-pointer bg-black",children:[t.video?e.jsx(D,{track:t.video.track,muted:!0}):e.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("svg",{className:"h-12 w-12",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),e.jsx("span",{children:"No Video"})]})}),t.audio&&e.jsx(z,{track:t.audio.track,muted:i!==t.clientId}),e.jsx("div",{className:"absolute bottom-3 left-3 flex items-center gap-2",children:e.jsxs("span",{className:"rounded bg-black/60 px-2 py-1 font-mono text-xs text-white backdrop-blur-sm",children:["ID: ",t.clientId.slice(0,8)]})}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:`rounded-full p-2 backdrop-blur-sm transition-colors ${i===t.clientId?"bg-blue-500 text-white":"bg-black/40 text-white/70 group-hover:bg-black/60"}`,children:i===t.clientId?e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})}):e.jsxs("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"})]})})}),$&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-yellow-500",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-yellow-500 border-t-transparent"}),e.jsx("span",{className:"font-bold",children:"Reconnecting..."})]})})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["Client ",t.clientId.slice(0,4)]}),e.jsxs("div",{className:"flex gap-2 text-xs text-gray-500 dark:text-gray-400",children:[t.video&&e.jsx("span",{className:"text-green-500",children:"Video"}),t.audio&&e.jsx("span",{className:"text-blue-500",children:"Audio"})]})]})})]},t.clientId))]})]})}const D=m=>{const r=M.c(6),{track:l,controls:p,muted:i}=m,d=p===void 0?!0:p,n=i===void 0?!0:i,c=u.useRef(null);let x,h;r[0]!==l?(x=()=>{if(c.current&&l){const j=new MediaStream([l]);c.current.srcObject=j,c.current.play().catch(console.error)}},h=[l],r[0]=l,r[1]=x,r[2]=h):(x=r[1],h=r[2]),u.useEffect(x,h);let v;return r[3]!==d||r[4]!==n?(v=e.jsx("video",{ref:c,autoPlay:!0,playsInline:!0,muted:n,controls:d,className:"h-full w-full object-cover"}),r[3]=d,r[4]=n,r[5]=v):v=r[5],v},z=m=>{const r=M.c(5),{track:l,muted:p}=m,i=u.useRef(null);let d,n;r[0]!==l?(d=()=>{if(i.current&&l){const x=new MediaStream([l]);i.current.srcObject=x,i.current.play().catch(console.error)}},n=[l],r[0]=l,r[1]=d,r[2]=n):(d=r[1],n=r[2]),u.useEffect(d,n);let c;return r[3]!==p?(c=e.jsx("audio",{ref:i,autoPlay:!0,muted:p}),r[3]=p,r[4]=c):c=r[4],c};export{H as RoomMonitor,Y as default};
