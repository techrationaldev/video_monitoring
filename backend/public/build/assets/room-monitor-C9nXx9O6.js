import{c as R,j as e,H as T,a as m}from"./app-BUqwFoQD.js";import{A as P}from"./app-layout-BW1ICJN0.js";import{l as O}from"./index-BCtBPRNr.js";/* empty css            */import"./app-logo-icon-BdqogQMe.js";import"./index-BYkl7TSM.js";import"./index-BYscnMyy.js";import"./index-C4J_hXM0.js";function z(i){const r=R.c(8),{roomId:a}=i;let p;r[0]===Symbol.for("react.memo_cache_sentinel")?(p=[{title:"Room Monitor",href:"#"}],r[0]=p):p=r[0];const d=`Monitor Room ${a}`;let l;r[1]!==d?(l=e.jsx(T,{title:d}),r[1]=d,r[2]=l):l=r[2];let o;r[3]!==a?(o=e.jsx(J,{roomId:a}),r[3]=a,r[4]=o):o=r[4];let u;return r[5]!==l||r[6]!==o?(u=e.jsxs(P,{breadcrumbs:p,children:[l,o]}),r[5]=l,r[6]=o,r[7]=u):u=r[7],u}function J({roomId:i,variant:r="full"}){const[a,p]=m.useState([]),d=m.useRef(null),l=m.useRef(null),o=m.useRef(null),u=m.useRef(new Map),f=m.useRef([]),g=m.useRef("");if(!g.current){const t=sessionStorage.getItem(`mediasoup-client-id-${i}`);if(t)g.current=t;else{const s=crypto.randomUUID();sessionStorage.setItem(`mediasoup-client-id-${i}`,s),g.current=s}}const[v,N]=m.useState("disconnected"),[S,k]=m.useState(!1);m.useEffect(()=>{let t=null,s;const c=()=>{const n="wss://eyeserver.mytro.in";t=new WebSocket(n),l.current=t,t.onopen=()=>{console.log("[ADMIN] Connected to Mediasoup Server"),N("connected");const x={action:"join-as-viewer",roomId:i,clientId:g.current};console.log("[ADMIN] Sending join-as-viewer:",x),t?.send(JSON.stringify(x))},t.onmessage=async x=>{const w=JSON.parse(x.data),{action:h,data:b}=w;switch(console.log(`[ADMIN] WS RECV: ${h}`,b),h){case"router-rtp-capabilities":await M(b),t?.send(JSON.stringify({action:"create-recv-transport",roomId:i,clientId:g.current}));break;case"create-recv-transport":await D(b);break;case"existing-producers":for(const y of b)j(y.id);break;case"new-producer":j(b.producerId);break;case"producer-closed":p(y=>y.filter(E=>E.producerId!==b.producerId));break;case"consume-done":await $(b);break;case"transport-connected":break;case"restart-ice-done":await C(b);break;case"stream-interrupted":console.warn("[ADMIN] Stream interrupted (network drop?)"),k(!0);break}},t.onclose=()=>{console.log("[ADMIN] WS Closed, reconnecting in 3s..."),N("reconnecting"),s=setTimeout(c,3e3)},t.onerror=x=>{console.error("[ADMIN] WS Error:",x),t?.close()}};return c(),()=>{t&&t.close(),clearTimeout(s),d.current=null,o.current=null,u.current=new Map,f.current=[],p([])}},[i]);const M=async t=>{try{const s=new O.Device;await s.load({routerRtpCapabilities:t}),d.current=s,console.log("Device loaded")}catch(s){console.error("Failed to load device:",s)}},D=async t=>{const s=d.current;if(!s)return;const c=s.createRecvTransport(t);if(o.current=c,c.on("connect",({dtlsParameters:n},x,w)=>{l.current?.send(JSON.stringify({action:"connect-transport",roomId:i,clientId:g.current,data:{transportId:c.id,dtlsParameters:n}})),x()}),c.on("connectionstatechange",n=>{console.log("[ADMIN] Recv Transport connection state changed:",n),(n==="failed"||n==="disconnected")&&(console.log("[ADMIN] Transport failed, restarting ICE..."),A(c.id))}),console.log("Recv Transport created"),f.current.length>0){console.log(`Processing ${f.current.length} pending producers`);for(const n of f.current)j(n);f.current=[]}},j=t=>{const s=d.current,c=o.current;if(!s||!c){console.warn("Device or transport not ready to consume, queueing producer",t),f.current.push(t);return}const n=s.rtpCapabilities;l.current?.send(JSON.stringify({action:"consume",roomId:i,clientId:g.current,data:{transportId:c.id,producerId:t,rtpCapabilities:n}}))},$=async t=>{const{id:s,producerId:c,kind:n,rtpParameters:x}=t,w=o.current;if(!w)return;const h=await w.consume({id:s,producerId:c,kind:n,rtpParameters:x});u.current.set(h.id,h),new MediaStream().addTrack(h.track),p(y=>[...y,{id:h.id,producerId:c,track:h.track}]),k(!1),console.log(`Consuming ${n} from producer ${c}`),console.log(`Consuming ${n} from producer ${c}`)},A=t=>{l.current?.send(JSON.stringify({action:"restart-ice",roomId:i,clientId:g.current,data:{transportId:t}}))},C=async t=>{const{transportId:s,iceParameters:c}=t,n=o.current;n&&n.id===s&&(console.log("[ADMIN] Restarting ICE with new parameters"),await n.restartIce({iceParameters:c}))};return console.log("RoomMonitor variant:",r),r==="card"?e.jsx("div",{className:"h-full w-full bg-black",children:a.length===0?e.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-gray-500 border-t-white"}),e.jsx("span",{className:"text-xs",children:"Connecting..."})]})}):e.jsx("div",{className:`grid h-full w-full ${a.length>1?"grid-cols-2":"grid-cols-1"}`,children:a.map(t=>e.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[e.jsx(I,{track:t.track,controls:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 rounded bg-black/60 px-1.5 py-0.5 text-[10px] text-white backdrop-blur-sm",children:t.producerId.slice(0,6)})]},t.id))})}):e.jsxs("div",{className:"h-full p-6",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Room:"," ",e.jsx("span",{className:"font-mono text-blue-600 dark:text-blue-400",children:i})]}),e.jsx("span",{className:`rounded-full px-3 py-1 text-sm font-medium ${v==="connected"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":v==="reconnecting"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:v==="connected"?"Active":v==="reconnecting"?"Reconnecting...":"Disconnected"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[a.length===0&&e.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[e.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),e.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),e.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),a.map(t=>e.jsxs("div",{className:"overflow-hidden rounded-xl bg-white shadow-lg ring-1 ring-gray-200 dark:bg-gray-800 dark:ring-gray-700",children:[e.jsxs("div",{className:"relative aspect-video bg-black",children:[e.jsx(I,{track:t.track}),e.jsx("div",{className:"absolute bottom-3 left-3 flex items-center gap-2",children:e.jsxs("span",{className:"rounded bg-black/60 px-2 py-1 font-mono text-xs text-white backdrop-blur-sm",children:["ID: ",t.producerId.slice(0,8)]})}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsxs("span",{className:"flex h-2 w-2",children:[e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex h-2 w-2 rounded-full bg-red-500"})]})}),S&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-yellow-500",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-yellow-500 border-t-transparent"}),e.jsx("span",{className:"font-bold",children:"Reconnecting..."})]})})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Live Stream"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Video"})]})})]},t.id))]})]})}const I=i=>{const r=R.c(5),{track:a,controls:p}=i,d=p===void 0?!0:p,l=m.useRef(null);let o,u;r[0]!==a?(o=()=>{if(l.current&&a){const g=new MediaStream([a]);l.current.srcObject=g,l.current.play().catch(console.error)}},u=[a],r[0]=a,r[1]=o,r[2]=u):(o=r[1],u=r[2]),m.useEffect(o,u);let f;return r[3]!==d?(f=e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,muted:!0,controls:d,className:"h-full w-full object-cover"}),r[3]=d,r[4]=f):f=r[4],f};export{J as RoomMonitor,z as default};
