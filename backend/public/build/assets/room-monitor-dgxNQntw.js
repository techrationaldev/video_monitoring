import{c as L,j as t,H as ce,a as c}from"./app-BBWRKX2L.js";import{A as U,l as ae}from"./index-BgmI7n5W.js";import{A as ie}from"./app-layout-Do2xptX0.js";import{a as D}from"./app-logo-icon-whzKK1Jt.js";import{R as de}from"./refresh-cw-C-nf3aLj.js";/* empty css            */import"./index-B__iduyv.js";import"./index-CIV44pFn.js";import"./index-C4J_hXM0.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],F=D("MicOff",le);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],B=D("Mic",ue);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],me=D("VideoOff",pe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],ge=D("Video",fe);function q(a){const r=L.c(6),{track:p,controls:m,muted:g}=a,l=m===void 0?!0:m,d=g===void 0?!0:g,f=c.useRef(null);let i,x;r[0]!==p?(i=()=>{if(f.current&&p){const b=new MediaStream([p]);f.current.srcObject=b,f.current.play().catch(console.error)}},x=[p],r[0]=p,r[1]=i,r[2]=x):(i=r[1],x=r[2]),c.useEffect(i,x);let y;return r[3]!==l||r[4]!==d?(y=t.jsx("video",{ref:f,autoPlay:!0,playsInline:!0,muted:d,controls:l,className:"h-full w-full object-cover"}),r[3]=l,r[4]=d,r[5]=y):y=r[5],y}function xe(a){const r=L.c(9),{track:p,muted:m,sinkId:g}=a,l=c.useRef(null);let d,f;r[0]!==m?(d=()=>{console.log("[AudioPlayer] Muted state changed:",m),!m&&l.current?.paused&&(console.log("[AudioPlayer] Unmuted and paused, attempting to play..."),l.current.play().catch(ke))},f=[m],r[0]=m,r[1]=d,r[2]=f):(d=r[1],f=r[2]),c.useEffect(d,f);let i,x;r[3]!==g||r[4]!==p?(i=()=>{if(l.current&&p){console.log("[AudioPlayer] Playing track:",p.id,p.enabled,p.readyState);const b=new MediaStream([p]);l.current.srcObject=b,g&&"setSinkId"in l.current&&l.current.setSinkId(g).catch(be),(()=>{l.current?.play().then(ye).catch(k=>{console.error("[AudioPlayer] Play failed (likely autoplay policy):",k);const v=()=>{console.log("[AudioPlayer] Retrying playback after interaction..."),l.current?.play().then(ve).catch(he),window.removeEventListener("click",v),window.removeEventListener("keydown",v)};window.addEventListener("click",v),window.addEventListener("keydown",v)})})()}},x=[p,g],r[3]=g,r[4]=p,r[5]=i,r[6]=x):(i=r[5],x=r[6]),c.useEffect(i,x);let y;return r[7]!==m?(y=t.jsx("audio",{ref:l,autoPlay:!0,muted:m}),r[7]=m,r[8]=y):y=r[8],y}function he(a){return console.error("[AudioPlayer] Retry playback failed:",a)}function ve(){return console.log("[AudioPlayer] Retry playback successful")}function ye(){return console.log("[AudioPlayer] Playback started successfully")}function be(a){console.error("Failed to set audio sink ID:",a)}function ke(a){return console.error("[AudioPlayer] Play on unmute failed:",a)}function Ee(a){const r=L.c(8),{roomId:p}=a;let m;r[0]===Symbol.for("react.memo_cache_sentinel")?(m=[{title:"Room Monitor",href:"#"}],r[0]=m):m=r[0];const g=`Monitor Room ${p}`;let l;r[1]!==g?(l=t.jsx(ce,{title:g}),r[1]=g,r[2]=l):l=r[2];let d;r[3]!==p?(d=t.jsx(je,{roomId:p}),r[3]=p,r[4]=d):d=r[4];let f;return r[5]!==l||r[6]!==d?(f=t.jsxs(ie,{breadcrumbs:m,children:[l,d]}),r[5]=l,r[6]=d,r[7]=f):f=r[7],f}function je({roomId:a,variant:r="full"}){c.useEffect(()=>{console.log("[ADMIN] RoomMonitor v2.1 loaded")},[]);const[p,m]=c.useState([]),[g,l]=c.useState(null),d=p.reduce((e,n)=>(e[n.clientId]||(e[n.clientId]={clientId:n.clientId}),n.kind==="video"&&(e[n.clientId].video=n),n.kind==="audio"&&(e[n.clientId].audio=n),e),{}),f=c.useRef(null),i=c.useRef(null),x=c.useRef(null),y=c.useRef(null),b=c.useRef(null),C=c.useRef(new Map),k=c.useRef([]),v=c.useRef("");if(!v.current){const e=sessionStorage.getItem(`mediasoup-client-id-${a}`);if(e)v.current=e;else{const n=crypto.randomUUID();sessionStorage.setItem(`mediasoup-client-id-${a}`,n),v.current=n}}const[M,T]=c.useState("disconnected"),[we,Ie]=c.useState(!1),[S,Z]=c.useState({}),[R,G]=c.useState({}),[K,V]=c.useState(!1),[Q,X]=c.useState([]),[J,Y]=c.useState([]),[A,W]=c.useState(""),[O,z]=c.useState("");c.useEffect(()=>{const e=async()=>{try{const n=await navigator.mediaDevices.enumerateDevices(),s=n.filter(u=>u.kind==="audioinput"),o=n.filter(u=>u.kind==="audiooutput");X(s),Y(o),s.length>0&&!A&&W(s[0].deviceId),o.length>0&&!O&&z(o[0].deviceId)}catch(n){console.error("[ADMIN] Failed to enumerate devices:",n)}};return e(),navigator.mediaDevices.addEventListener("devicechange",e),()=>navigator.mediaDevices.removeEventListener("devicechange",e)},[]),c.useEffect(()=>{let e=null,n;const s=()=>{const o="wss://eyeserver.mytro.in";e=new WebSocket(o),i.current=e,e.onopen=()=>{console.log("[ADMIN] Connected to Mediasoup Server"),T("connected");const u={action:"join-as-viewer",roomId:a,clientId:v.current};console.log("[ADMIN] Sending join-as-viewer:",u),e?.send(JSON.stringify(u))},e.onmessage=async u=>{const j=JSON.parse(u.data),{action:I,data:h}=j;switch(console.log(`[ADMIN] WS RECV: ${I}`,h),I){case"router-rtp-capabilities":await ee(h),e?.send(JSON.stringify({action:"create-recv-transport",roomId:a,clientId:v.current}));break;case"create-recv-transport":await ne(h);break;case"create-send-transport":await te(h);break;case"existing-producers":for(const w of h)$(w.id,w.clientId);break;case"new-producer":$(h.producerId,h.clientId);break;case"producer-closed":m(w=>w.filter(N=>N.producerId!==h.producerId));break;case"consume-done":await se(h);break;case"transport-connected":break;case"restart-ice-done":await oe(h);break;case"session-ended":console.warn("[ADMIN] Session ended by server, reloading..."),window.location.reload();break;case"stream-interrupted":console.warn("[ADMIN] Stream interrupted (network drop?)"),V(!0);break}},e.onclose=()=>{console.log("[ADMIN] WS Closed, reconnecting in 3s..."),T("reconnecting"),x.current&&(x.current.close(),x.current=null),n=setTimeout(s,3e3)},e.onerror=u=>{console.error("[ADMIN] WS Error:",u),e?.close()}};return s(),()=>{e&&(e.onclose=null,e.close()),clearTimeout(n),f.current=null,x.current=null,C.current=new Map,k.current=[],m([])}},[a]);const ee=async e=>{try{const n=new ae.Device;await n.load({routerRtpCapabilities:e}),f.current=n,console.log("Device loaded")}catch(n){console.error("Failed to load device:",n)}},te=async e=>{const n=f.current;if(!n)return;const s=n.createSendTransport(e);y.current=s,s.on("connect",({dtlsParameters:o},u,j)=>{i.current?.send(JSON.stringify({action:"connect-transport",roomId:a,clientId:v.current,data:{transportId:s.id,dtlsParameters:o}})),u()}),s.on("produce",({kind:o,rtpParameters:u},j,I)=>{i.current?.send(JSON.stringify({action:"produce",roomId:a,clientId:v.current,data:{transportId:s.id,kind:o,rtpParameters:u}}));const h=w=>{const N=JSON.parse(w.data);N.action==="produce-done"&&(j({id:N.producerId}),i.current?.removeEventListener("message",h))};i.current?.addEventListener("message",h)})},[P,E]=c.useState(!1),re=async()=>{try{const n=(await navigator.mediaDevices.getUserMedia({audio:A?{deviceId:{exact:A}}:!0})).getAudioTracks()[0];y.current?(b.current=await y.current.produce({track:n}),E(!0)):(i.current?.send(JSON.stringify({action:"create-send-transport",roomId:a,clientId:v.current})),setTimeout(async()=>{y.current&&(b.current=await y.current.produce({track:n}),E(!0))},1e3))}catch(e){console.error("Failed to start talking:",e),alert("Could not access microphone")}},_=()=>{b.current&&(i.current?.send(JSON.stringify({action:"close-producer",roomId:a,clientId:v.current,data:{producerId:b.current.id}})),b.current.close(),b.current=null,E(!1))},ne=async e=>{const n=f.current;if(!n)return;const s=n.createRecvTransport(e);if(x.current=s,s.on("connect",({dtlsParameters:o},u,j)=>{i.current?.send(JSON.stringify({action:"connect-transport",roomId:a,clientId:v.current,data:{transportId:s.id,dtlsParameters:o}})),u()}),s.on("connectionstatechange",o=>{console.log(`[ADMIN] Recv Transport connection state changed: ${o}`),o==="connected"||(o==="disconnected"||o==="failed")&&(console.warn("[ADMIN] Transport disconnected or failed; closing WS to trigger reconnect."),s.close(),x.current=null,i.current&&i.current.readyState===WebSocket.OPEN&&i.current.close())}),k.current.length>0){console.log(`Processing ${k.current.length} pending producers`);for(const{producerId:o,clientId:u}of k.current)$(o,u);k.current=[]}},$=(e,n)=>{const s=f.current,o=x.current;if(!s||!o){console.warn("Device or transport not ready to consume, queueing producer",e),k.current.push({producerId:e,clientId:n});return}const u=s.rtpCapabilities;i.current?.send(JSON.stringify({action:"consume",roomId:a,clientId:v.current,data:{transportId:o.id,producerId:e,rtpCapabilities:u,appData:{clientId:n}}})),H.current.set(e,n)},H=c.useRef(new Map),se=async e=>{const{id:n,producerId:s,kind:o,rtpParameters:u}=e,j=H.current.get(s)||"unknown",I=x.current;if(!I)return;const h=await I.consume({id:n,producerId:s,kind:o,rtpParameters:u});C.current.set(h.id,h),new MediaStream().addTrack(h.track),m(N=>[...N,{id:h.id,producerId:s,kind:o,track:h.track,clientId:j}]),V(!1),console.log(`Consuming ${o} from producer ${s}`)},oe=async e=>{const{transportId:n,iceParameters:s}=e,o=x.current;o&&o.id===n&&(console.log("[ADMIN] Restarting ICE with new parameters"),await o.restartIce({iceParameters:s}))};return console.log("RoomMonitor variant:",r),r==="card"?t.jsx("div",{className:"h-full w-full bg-black",children:Object.keys(d).length===0?t.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-gray-500 border-t-white"}),t.jsx("span",{className:"text-xs",children:"Connecting..."})]})}):t.jsx("div",{className:`grid h-full w-full ${Object.keys(d).length>1?"grid-cols-2":"grid-cols-1"}`,children:Object.values(d).map(e=>t.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[e.video?t.jsx(q,{track:e.video.track,controls:!1,muted:!0}):t.jsx("div",{className:"flex h-full items-center justify-center bg-gray-900 text-white",children:"No Video"}),t.jsx("div",{className:"absolute top-2 right-2 flex flex-col gap-2 opacity-0 transition-opacity group-hover:opacity-100",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>{const s=!(S[e.clientId]||!1);Z(o=>({...o,[e.clientId]:s})),i.current?.send(JSON.stringify({action:"admin-action",roomId:a,targetClientId:e.clientId,actionType:s?"mute-audio":"unmute-audio"}))},className:`rounded p-1.5 text-white ${S[e.clientId]?"bg-red-500/80":"bg-black/50 hover:bg-black/70"}`,title:S[e.clientId]?"Unmute Remote Mic":"Mute Remote Mic",children:S[e.clientId]?t.jsx(F,{size:16}):t.jsx(B,{size:16})}),t.jsx("button",{onClick:()=>{const s=!(R[e.clientId]||!1);G(o=>({...o,[e.clientId]:s})),i.current?.send(JSON.stringify({action:"admin-action",roomId:a,targetClientId:e.clientId,actionType:s?"mute-video":"unmute-video"}))},className:`rounded p-1.5 text-white ${R[e.clientId]?"bg-red-500/80":"bg-black/50 hover:bg-black/70"}`,title:R[e.clientId]?"Enable Remote Camera":"Disable Remote Camera",children:R[e.clientId]?t.jsx(me,{size:16}):t.jsx(ge,{size:16})}),t.jsx("button",{onClick:()=>{confirm("Force reload remote client?")&&i.current?.send(JSON.stringify({action:"admin-action",roomId:a,targetClientId:e.clientId,actionType:"reload"}))},className:"rounded bg-black/50 p-1.5 text-white hover:bg-red-600/80",title:"Force Reload Remote Client",children:t.jsx(de,{size:16})})]})}),t.jsx("div",{className:"absolute bottom-2 left-2 rounded bg-black/60 px-1.5 py-0.5 text-[10px] text-white backdrop-blur-sm",children:e.clientId.slice(0,6)})]},e.clientId))})}):t.jsxs("div",{className:"h-full p-6",children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[t.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Room:"," ",t.jsx("span",{className:"font-mono text-blue-600 dark:text-blue-400",children:a})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("select",{value:A,onChange:e=>W(e.target.value),className:"rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",children:Q.map(e=>t.jsx("option",{value:e.deviceId,children:e.label||`Mic ${e.deviceId.slice(0,5)}...`},e.deviceId))}),J.length>0&&t.jsx("select",{className:"max-w-[150px] rounded bg-gray-700 px-3 py-2 text-sm text-white",value:O,onChange:e=>z(e.target.value),children:J.map(e=>t.jsx("option",{value:e.deviceId,children:e.label||`Speaker ${e.deviceId}`},e.deviceId))})]}),t.jsxs("button",{onMouseDown:re,onMouseUp:_,onMouseLeave:_,className:`flex items-center gap-2 rounded-full px-4 py-2 font-bold text-white transition-all ${P?"scale-105 bg-red-600 shadow-lg":"bg-blue-600 hover:bg-blue-700"}`,children:[P?t.jsx(B,{className:"animate-pulse"}):t.jsx(F,{}),P?"Broadcasting...":"Hold to Talk"]}),t.jsx("span",{className:`rounded-full px-3 py-1 text-sm font-medium ${M==="connected"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":M==="reconnecting"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:M==="connected"?"Active":M==="reconnecting"?"Reconnecting...":"Disconnected"})]})]}),t.jsxs("div",{className:`grid h-full w-full gap-6 ${Object.keys(d).length===1?"grid-cols-1":"grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"}`,children:[Object.keys(d).length===0&&t.jsxs("div",{className:"col-span-full flex h-64 flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400",children:[t.jsx("div",{className:"mb-4 h-12 w-12 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"}),t.jsx("p",{className:"text-lg font-medium",children:"Waiting for streams..."}),t.jsx("p",{className:"text-sm",children:"Streams will appear here automatically"})]}),Object.values(d).map(e=>t.jsxs("div",{className:`overflow-hidden rounded-xl bg-white shadow-lg ring-1 transition-all ${g===e.clientId?"ring-2 shadow-blue-500/20 ring-blue-500":"ring-gray-200 dark:ring-gray-700"} dark:bg-gray-800`,onClick:()=>{console.log("[RoomMonitor] Card clicked. Current active:",g,"Clicked:",e.clientId),l(e.clientId===g?null:e.clientId)},children:[t.jsxs("div",{className:`group relative cursor-pointer bg-black ${Object.keys(d).length===1?"h-[calc(100vh-12rem)] w-full":"aspect-video"}`,children:[e.video?t.jsx(q,{track:e.video.track,muted:!0}):t.jsx("div",{className:"flex h-full items-center justify-center text-gray-500",children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("svg",{className:"h-12 w-12",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),t.jsx("span",{children:"No Video"})]})}),e.audio&&t.jsx(xe,{track:e.audio.track,muted:g!==e.clientId,sinkId:O}),t.jsxs("div",{className:"absolute bottom-3 left-3 flex items-center gap-2",children:[t.jsxs("span",{className:"rounded bg-black/60 px-2 py-1 font-mono text-xs text-white backdrop-blur-sm",children:["ID: ",e.clientId.slice(0,8)]}),e.audio&&t.jsx("div",{className:"rounded bg-black/60 px-2 py-1 backdrop-blur-sm",children:t.jsx(U,{track:e.audio.track})})]}),t.jsx("div",{className:"absolute top-3 right-3",children:t.jsx("div",{className:`rounded-full p-2 backdrop-blur-sm transition-colors ${g===e.clientId?"bg-blue-500 text-white":"bg-black/40 text-white/70 group-hover:bg-black/60"}`,children:g===e.clientId?t.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})}):t.jsxs("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"})]})})}),K&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",children:t.jsxs("div",{className:"flex flex-col items-center gap-2 text-yellow-500",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-yellow-500 border-t-transparent"}),t.jsx("span",{className:"font-bold",children:"Reconnecting..."})]})})]}),t.jsx("div",{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["Client ",e.clientId.slice(0,4)]}),t.jsxs("div",{className:"flex gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.video&&t.jsx("span",{className:"text-green-500",children:"Video"}),e.audio&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(U,{track:e.audio.track}),t.jsx("span",{className:"text-blue-500",children:"Audio"})]})]})]})})]},e.clientId))]})]})}export{je as RoomMonitor,Ee as default};
